<%- include ./layouts/head.ejs %>
<%- include ./layouts/header.ejs %>

<body>
<style>
  /* ======================== PANEL CONTROL — ESTILO UNIFICADO (DESKTOP) ======================== */
  /* Sin media queries. Enfocado a pantallas grandes. Evita repeticiones y selectores redundantes. */

  :root{
    --pc-primary: #1f487e;
    --pc-border: rgba(31,72,126,.12);
    --pc-border-strong: rgba(31,72,126,.25);
    --pc-bg-soft: #fbfdff;
    --pc-bg-head: #f6f8fb;
    --pc-text: #29486f;
    --pc-shadow: 0 6px 18px rgba(0,0,0,.06);
    --pc-radius: 12px;
    --pc-radius-sm: 10px;
  }

  /* ---------- Contenedor general ---------- */
  main > .container{
    max-width: 1400px;
    padding: 0 10px;
  }

  /* ---------- Tarjetas del panel (usa .form-control como caja) ---------- */
  main > .container > .form-control{
    box-shadow: var(--pc-shadow);
    border: 1px solid var(--pc-border);
    border-radius: var(--pc-radius);
    padding: 14px;
    margin-bottom: 14px;
    background: #fff;
  }

  main > .container > .form-control h4{
    font-size: 1rem;
    font-weight: 800;
    color: var(--pc-primary);
    margin: 0 0 10px 0;
  }

  /* ---------- Layout superior: Acciones (izq) + Reportes (der) ---------- */
  .panel-top-grid{
    display: grid;
    grid-template-columns: 360px 1fr;
    gap: 14px;
    align-items: start;
    margin-bottom: 14px;
  }
  .panel-top-grid > .form-control{ margin-bottom: 0; }

  /* ===================== ACCIONES (panel lateral agrupado) ===================== */
  #panel-acciones{ display: grid; gap: 12px; }

  #panel-acciones .accion-grupo{
    border: 1px solid var(--pc-border);
    border-radius: var(--pc-radius);
    background: #fff;
    overflow: hidden;
  }

  #panel-acciones summary{ list-style: none; cursor: pointer; }
  #panel-acciones summary::-webkit-details-marker{ display: none; }

  #panel-acciones .accion-summary{
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    padding: 12px;
    border-radius: 0;
    text-align: left;
    font-weight: 800;
    min-height: 50px;
    white-space: normal;
  }

  #panel-acciones .accion-summary-text{
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  #panel-acciones .accion-title{ font-weight: 900; font-size: .95rem; }
  #panel-acciones .accion-subtitle{ font-weight: 700; font-size: .82rem; opacity: .85; }

  #panel-acciones .accion-caret{
    font-size: .95rem;
    opacity: .85;
    transition: transform .15s ease;
  }
  #panel-acciones details[open] .accion-caret{ transform: rotate(180deg); }

  #panel-acciones .accion-sub{
    padding: 10px;
    display: grid;
    gap: 8px;
    background: var(--pc-bg-soft);
    border-top: 1px solid var(--pc-border);
  }
  #panel-acciones .accion-sub .btn{ width: 100%; }

  /* ===================== REPORTES / IMPORTACIÓN ===================== */
  #panel-reportes .reportes-top{
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 10px;
  }

  #panel-reportes .reportes-filtros{
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 10px;
    align-items: end;
  }

  #panel-reportes .reportes-actions{
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }

  #panel-reportes .reportes-grid{
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 12px;
  }

  #panel-reportes .reportes-card{
    border: 1px solid var(--pc-border);
    border-radius: var(--pc-radius);
    padding: 12px;
    background: var(--pc-bg-soft);
  }

  #panel-reportes .reportes-card h5{
    font-size: .95rem;
    font-weight: 900;
    margin: 0 0 8px 0;
    color: var(--pc-primary);
  }

  #panel-reportes .reportes-card-wide{ grid-column: 1 / -1; }

  /* ===================== FORMULARIOS (común) ===================== */
  main > .container label{
    font-size: .9rem;
    font-weight: 700;
    color: var(--pc-text);
    margin: 0 8px 4px 0;
  }

  /* Labels tipo "span" usados en filtros */
  #panel-reportes label span{
    display: block;
    margin: 0 0 4px 0;
  }

  main > .container select,
  main > .container input[type="file"],
  main > .container input[type="text"]{
    font-size: .9rem;
    padding: .35rem .5rem;
    line-height: 1.25;
    border-radius: var(--pc-radius-sm);
    border: 1px solid var(--pc-border-strong);
    outline: none;
  }

  main > .container button.btn{
    padding: 8px 12px;
    font-size: .92rem;
    border-radius: var(--pc-radius-sm);
    font-weight: 800;
  }

  /* ===================== BUSCADOR + CTA NUEVO PRODUCTO ===================== */
  .panel-search-row{
    display: flex;
    gap: 10px;
    align-items: center;
  }
  .panel-search-row #entradaBusqueda{ flex: 1; margin: 0; }

  .btn-new-product{
    display: inline-flex;
    align-items: center;
    gap: 8px;
    border-radius: var(--pc-radius-sm);
    font-weight: 900;
    padding: 10px 12px;
    white-space: nowrap;
  }

  /* ===================== PAGINACIÓN ===================== */
  .panel-paginacion{
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
    user-select: none;
  }

  .panel-paginacion a,
  .panel-paginacion span{
    padding: 4px 8px;
    font-size: .9rem;
    border: 1px solid #dfe7f2;
    border-radius: 8px;
    color: var(--pc-primary);
    text-decoration: none;
    background: #fff;
  }

  .panel-paginacion span.active{
    background: var(--pc-primary);
    border-color: var(--pc-primary);
    color: #fff;
  }

  /* ===================== LISTADO (grilla) ===================== */
  .panel-container{
    overflow-x: auto;
    padding-bottom: 6px;
  }

  .panel-header,
  .panel-row{
    display: grid;
    grid-template-columns: 36px 1.1fr 2fr 120px .9fr 140px;
    gap: 8px;
    align-items: center;
    min-width: 900px;
  }

  .panel-header{
    position: sticky;
    top: 0;
    z-index: 1;
    background: var(--pc-bg-head);
    border: 1px solid #e5edf7;
    border-radius: var(--pc-radius-sm);
    padding: 8px;
    font-weight: 900;
    font-size: .9rem;
    color: var(--pc-primary);
  }

  .panel-row{
    border-bottom: 1px solid #eef2f7;
    padding: 8px 2px;
    font-size: .92rem;
  }

  .panel-col-small{ width: 36px; text-align: center; }
  .panel-text-small-bold{ font-weight: 800; font-size: .9rem; }

  .panel-image-container{
    width: 100%;
    max-width: 120px;
    margin: 0 auto;
  }

  .product-image{
    display: block;
    width: 100%;
    height: 70px;
    object-fit: contain;
  }

  .panel-price{ font-weight: 900; color: #0b6e4f; }

  /* Acciones de fila */
  .btn-edit{
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    font-size: .85rem;
    font-weight: 900;
    border: 1px solid #d0d7e2;
    border-radius: 8px;
    background: #fff;
    color: var(--pc-primary);
    cursor: pointer;
  }

  .panel-actions{
    display: flex;
    justify-content: flex-end;
    padding-top: 10px;
  }

  .btn-delete{
    padding: 6px 10px;
    font-size: .85rem;
    font-weight: 900;
    border-radius: 8px;
    border: 1px solid #f2d7da;
    background: #fff;
    color: #dc3545;
    cursor: pointer;
  }

  .panel-alert{
    font-size: .95rem;
    color: #6b7280;
    padding: 10px;
    text-align: center;
  }
</style>


 <main>
  <div class="container">

    <div class="panel-top-grid">
      <!-- ACCIONES -->
      <div class="form-control botones">
        <a href="/productos/crear" class="btn btn-primary panel-control">Crear un nuevo producto</a>
        <a href="/productos/modificarPorProveedor" class="btn btn-primary panel-control">Modificar producto por proveedor</a>
        <a href="/productos/generarPedidoManual" class="btn btn-primary panel-control">Generar Pedido Manual</a>
        <a href="/productos/historialPedidos" class="btn btn-primary panel-control">Historial Pedidos</a>
        <a href="/productos/masVendidos" class="btn btn-success panel-control">Ver productos más vendidos</a>
        <a href="/productos/recomendacionesProveedor" class="btn btn-warning panel-control">Recomendación pedido por proveedor</a>
      </div>

      <!-- REPORTES / IMPORTACIÓN -->
      <div class="form-control" id="panel-reportes">
        <div class="reportes-top">
          <h4>Reportes e importación</h4>
          <small class="text-muted d-block">
            Los filtros impactan en: Lista de precios, Stock proveedor y Actualización por Excel.
          </small>
        </div>

        <div class="reportes-filtros">
          <label for="filtroProveedor">
            <span>Proveedor</span>
            <select id="filtroProveedor">
              <option value="TODOS" <%= (!proveedorSeleccionado || String(proveedorSeleccionado) === 'TODOS') ? 'selected' : '' %>>
                Todos los proveedores
              </option>
              <% proveedores.forEach(proveedor => { %>
                <option value="<%= proveedor.id %>" <%= String(proveedor.id) === String(proveedorSeleccionado) ? 'selected' : '' %>>
                  <%= proveedor.nombre %>
                </option>
              <% }); %>
            </select>
          </label>

          <label for="filtroCategoria">
            <span>Categoría</span>
            <select id="filtroCategoria">
              <option value="" <%= (!categoriaSeleccionada || String(categoriaSeleccionada) === '' || String(categoriaSeleccionada) === 'TODAS') ? 'selected' : '' %>>
                Todas las categorías
              </option>
              <% categorias.forEach(categoria => { %>
                <option value="<%= categoria.id %>" <%= String(categoria.id) === String(categoriaSeleccionada) ? 'selected' : '' %>>
                  <%= categoria.nombre %>
                </option>
              <% }); %>
            </select>
          </label>

          <div class="reportes-actions">
            <button type="button" class="btn btn-primary" id="btnAplicarFiltros">Aplicar</button>
            <button type="button" class="btn btn-outline-secondary" id="btnLimpiarFiltros">Limpiar</button>
          </div>
        </div>

        <div class="reportes-grid">
          <div class="reportes-card">
            <h5>Lista de precios (PDF)</h5>
            <form method="get" action="/productos/generarPDF" id="form-lista-precios">
              <input type="hidden" name="proveedor" class="inp-proveedor-global">
              <input type="hidden" name="categoria" class="inp-categoria-global">
              <button type="submit" class="btn btn-primary">Generar PDF</button>
            </form>
          </div>

          <div class="reportes-card">
            <h5>Actualizar precios (Excel)</h5>
            <form method="post" action="/productos/actualizarPreciosExcel" enctype="multipart/form-data" id="form-actualizar-excel">
              <input type="hidden" name="proveedor" class="inp-proveedor-global">
              <label for="archivo">Subir lista</label>
              <input type="file" id="archivo" name="archivos[]" accept=".xlsx,.pdf">
              <button type="submit" class="btn btn-primary">Actualizar</button>
            </form>
          </div>

          <div class="reportes-card">
            <h5>Stock proveedor (PDF)</h5>

            <form method="get" action="/productos/generarPDFProveedor" id="form-pdf-stock-proveedor">
              <input type="hidden" name="proveedor" class="inp-proveedor-global">
              <input type="hidden" name="categoria" class="inp-categoria-global">

              <div class="opciones-reporte">
                <label><input type="radio" name="tipo" value="stock" checked> <strong>Stock completo</strong></label>
                <label><input type="radio" name="tipo" value="asignadoCompleto"> <strong>Asignados al proveedor (con categoría)</strong></label>
                <label><input type="radio" name="tipo" value="asignado"> <strong>Faltantes del proveedor asignado</strong></label>
                <label><input type="radio" name="tipo" value="pedido"> <strong>Faltantes del proveedor más barato</strong></label>
                <label><input type="radio" name="tipo" value="porCategoria"> <strong>Listado por categoría</strong></label>
                <label><input type="radio" name="tipo" value="categoriaProveedorMasBarato"> <strong>Proveedor más barato por categoría</strong></label>
              </div>

              <button type="submit" class="btn btn-primary">Generar PDF</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- A PARTIR DE ACÁ sigue tu sección: BUSCADOR + PAGINADO + LISTADO -->

    <!-- =======================
         BUSCADOR + PAGINADO + LISTADO
    ======================== -->
    <div class="panel-busqueda">
      <% 
        const qs = [];
        if (proveedorSeleccionado && String(proveedorSeleccionado) !== 'TODOS') qs.push('proveedor=' + encodeURIComponent(String(proveedorSeleccionado)));
        if (categoriaSeleccionada && String(categoriaSeleccionada) !== '' && String(categoriaSeleccionada) !== 'TODAS') qs.push('categoria=' + encodeURIComponent(String(categoriaSeleccionada)));
        if (busquedaActual) qs.push('busqueda=' + encodeURIComponent(String(busquedaActual)));
        const extraQuery = qs.length ? '&' + qs.join('&') : '';
      %>

      <div class="panel-paginacion mb-3">
        <% if (paginaActual > 1) { %>
          <a href="?pagina=<%= paginaActual - 1 %><%= extraQuery %>">&laquo;</a>
        <% } %>

        <% if (paginaActual > 10) { %>
          <a href="?pagina=1<%= extraQuery %>">1</a>
          <span>...</span>
        <% } %>

        <% for (let i = Math.max(1, paginaActual - 1); i <= Math.min(paginaActual + 10, numeroDePaginas); i++) { %>
          <% if (paginaActual === i) { %>
            <span class="active"><%= i %></span>
          <% } else { %>
            <a href="?pagina=<%= i %><%= extraQuery %>"><%= i %></a>
          <% } %>
        <% } %>

        <% if (paginaActual < numeroDePaginas - 1) { %>
          <span>...</span>
          <a href="?pagina=<%= numeroDePaginas %><%= extraQuery %>"><%= numeroDePaginas %></a>
        <% } %>

        <% if (paginaActual < numeroDePaginas) { %>
          <a href="?pagina=<%= paginaActual + 1 %><%= extraQuery %>">&raquo;</a>
        <% } %>
      </div>

      <div class="panel-buscador mb-4 panel-search-row">
  <input
    type="text"
    id="entradaBusqueda"
    class="form-control"
    autocomplete="off"
    placeholder="¿Qué estás buscando? Ej: Escort, Óptica, Faro, Agile"
  />
  <a href="/productos/crear" class="btn btn-primary btn-new-product">
    <i class="fas fa-plus"></i> Nuevo producto
  </a>
</div>


      <div class="panel-container">
        <% if (productos && productos.length > 0) { %>
          <div class="panel-header">
  <div class="panel-col panel-col-small">✔</div>
  <div class="panel-col">Categoría</div>
  <div class="panel-col">Nombre</div>
  <div class="panel-col">Imagen</div>
  <div class="panel-col">Precio</div>
  <div class="panel-col">Acciones</div>
</div>
          <% productos.forEach(producto => { %>
            <div class="panel-row">
              <div class="panel-col panel-col-small">
                <input type="checkbox" class="product-check" value="<%= producto.id %>" />
              </div>

              <div class="panel-text-small-bold"><%= producto.categoria %></div>
              <div class="panel-text-small-bold"><%= producto.nombre %></div>

              <div class="panel-col">
                <% if (producto.imagenes && producto.imagenes.length > 0) { %>
                  <div class="panel-image-container">
                    <img
                      src="/uploads/productos/<%= producto.imagenes[0] %>"
                      alt="Imagen de <%= producto.nombre %>"
                      class="product-image"
                    />
                  </div>
                <% } else { %>
                  <div class="panel-image-container">
                    <span class="no-image">(Sin imagen)</span>
                  </div>
                <% } %>
              </div>

              <div class="panel-col panel-price">
                $<%= parseInt(producto.precio_venta) %>
              </div>

              <div class="panel-col">
                <form
                  method="get"
                  action="/productos/editar/<%= producto.id %>?pagina=<%= paginaActual %><%= busquedaActual ? '&busqueda=' + encodeURIComponent(String(busquedaActual)) : '' %><%= (proveedorSeleccionado && String(proveedorSeleccionado) !== 'TODOS') ? '&proveedor=' + encodeURIComponent(String(proveedorSeleccionado)) : '' %><%= (categoriaSeleccionada && String(categoriaSeleccionada) !== '' && String(categoriaSeleccionada) !== 'TODAS') ? '&categoria=' + encodeURIComponent(String(categoriaSeleccionada)) : '' %>"
                >
                  <button class="btn-edit" type="submit">
                    <i class="fas fa-edit"></i> Editar
                  </button>
                </form>
              </div>
            </div>
          <% }); %>
        <% } else { %>
          <div class="panel-alert">No hay productos para mostrar.</div>
        <% } %>

        <div class="panel-actions">
          <button id="delete-selected" class="btn-delete" type="button">
            Eliminar seleccionados
          </button>
        </div>
      </div>
    </div>
  </div>
</main>


  <%- include ./layouts/footer.ejs %>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="/js/panelControl.js"></script> 
  <script id="productos-data" type="application/json">
    <%- JSON.stringify(productos) %>
  </script>
 
</body>
