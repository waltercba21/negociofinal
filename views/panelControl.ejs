<%- include ./layouts/head.ejs %>
<%- include ./layouts/header.ejs %>

<body>
  <main class="container mt-4">
    <!-- BOTONES PRINCIPALES -->
    <div class="d-flex flex-wrap gap-2 mb-4">
      <a href="/productos/crear" class="btn btn-primary">Crear un nuevo producto</a>
      <a href="/productos/modificarPorProveedor" class="btn btn-primary">Modificar producto por proveedor</a>
      <a href="/productos/proveedores" class="btn btn-primary">Ver proveedores</a>
      <a href="/productos/generarPedidoManual" class="btn btn-primary">Generar Pedido Manual</a>
    </div>

    <!-- GENERAR LISTADO PDF -->
    <div class="mb-4">
      <h4>Generar Listado de productos</h4>
      <form method="get" action="/productos/generarPDF" class="row g-3">
        <div class="col-md-6">
          <label for="proveedor" class="form-label">Seleccionar Proveedor</label>
          <select name="proveedor" id="proveedor" class="form-select">
            <option value="TODOS">Mostrar Todos</option>
            <% proveedores.forEach(proveedor => { %>
              <option value="<%= proveedor.id %>" <%= proveedor.id == proveedorSeleccionado ? 'selected' : '' %>><%= proveedor.nombre %></option>
            <% }); %>
          </select>
        </div>

        <div class="col-md-6">
          <label for="categoria" class="form-label">Seleccionar Categoría</label>
          <select name="categoria" id="categoria" class="form-select">
            <option value="">Mostrar Todas</option>
            <% categorias.forEach(categoria => { %>
              <option value="<%= categoria.id %>" <%= categoria.id == categoriaSeleccionada ? 'selected' : '' %>><%= categoria.nombre %></option>
            <% }); %>
          </select>
        </div>

        <div class="col-12">
          <button type="submit" class="btn btn-success">Generar PDF</button>
        </div>
      </form>
    </div>

    <!-- ACTUALIZAR PRECIOS EXCEL -->
    <div class="mb-4">
      <h4>Actualizar Precios con Excel</h4>
      <form method="post" action="/productos/actualizarPreciosExcel" enctype="multipart/form-data" class="row g-3">
        <div class="col-md-6">
          <label for="proveedorActualizar" class="form-label">Seleccionar Proveedor</label>
          <select name="proveedor" id="proveedorActualizar" class="form-select">
            <option value="TODOS">Mostrar Todos</option>
            <% proveedores.forEach(proveedor => { %>
              <option value="<%= proveedor.id %>" <%= proveedor.id == proveedorSeleccionado ? 'selected' : '' %>><%= proveedor.nombre %></option>
            <% }); %>
          </select>
        </div>

        <div class="col-md-6">
          <label for="archivo" class="form-label">Subir lista de precios</label>
          <input type="file" id="archivo" name="archivos[]" class="form-control" accept=".xlsx,.pdf">
        </div>

        <div class="col-12">
          <button type="submit" class="btn btn-success">Actualizar precios</button>
        </div>
      </form>
    </div>

    <!-- GENERAR PEDIDO PROVEEDOR -->
    <div class="mb-5">
      <h4>Generar Listado o Pedido de Proveedor</h4>
      <form method="get" action="/productos/generarPDFProveedor" class="row g-3">
        <div class="col-md-4">
          <label for="proveedor" class="form-label">Seleccionar Proveedor</label>
          <select name="proveedor" id="proveedor" class="form-select">
            <option value="TODOS">Mostrar Todos</option>
            <% proveedores.forEach(proveedor => { %>
              <option value="<%= proveedor.id %>" <%= proveedor.id == proveedorSeleccionado ? 'selected' : '' %>><%= proveedor.nombre %></option>
            <% }); %>
          </select>
        </div>

        <div class="col-md-4">
          <label for="categoria" class="form-label">Seleccionar Categoría</label>
          <select name="categoria" id="categoria" class="form-select">
            <option value="TODAS">Mostrar Todas</option>
            <% categorias.forEach(categoria => { %>
              <option value="<%= categoria.id %>" <%= categoria.id == categoriaSeleccionada ? 'selected' : '' %>><%= categoria.nombre %></option>
            <% }); %>
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label d-block">Tipo de Documento</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="tipo" id="tipo-stock" value="stock" checked>
            <label class="form-check-label" for="tipo-stock">Listado Completo del Proveedor</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="tipo" id="tipo-pedido" value="pedido">
            <label class="form-check-label" for="tipo-pedido">Pedido del Proveedor Más Barato (Stock bajo)</label>
          </div>
        </div>

        <div class="col-12">
          <button type="submit" class="btn btn-success">Generar PDF</button>
        </div>
      </form>
    </div>

    <!-- BUSCADOR + TABLA -->
    <div class="panel-busqueda">
      <div class="panel-buscador mb-3">
        <input type="text" id="entradaBusqueda" class="form-control" placeholder="¿Qué estás buscando? Ej: Escort, Óptica, Faro, Agile">
      </div>

      <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered align-middle text-center">
          <thead class="table-light">
            <tr>
              <th scope="col"><input type="checkbox" id="check-all"></th>
              <th scope="col">Categoría</th>
              <th scope="col">Nombre</th>
              <th scope="col">Imagen</th>
              <th scope="col">Precio</th>
              <th scope="col">Acciones</th>
            </tr>
          </thead>
          <tbody id="contenedor-productos">
            <% if (productos && productos.length > 0) { %>
              <% productos.forEach(producto => { %>
                <tr>
                  <td>
                    <input type="checkbox" class="form-check-input product-check" value="<%= producto.id %>">
                  </td>
                  <td><%= producto.categoria %></td>
                  <td><%= producto.nombre %></td>
                  <td>
                    <% if (producto.imagenes && producto.imagenes.length > 0) { %>
                      <img src="/uploads/productos/<%= producto.imagenes[0] %>" alt="Imagen de <%= producto.nombre %>" class="img-thumbnail" style="max-width: 100px;">
                    <% } else { %>
                      <span class="text-muted">(Sin imagen)</span>
                    <% } %>
                  </td>
                  <td>$<%= parseInt(producto.precio_venta) %></td>
                  <td>
                    <form method="get" action="/productos/editar/<%= producto.id %>?pagina=<%= paginaActual %><%= busquedaActual ? `&busqueda=${encodeURIComponent(busquedaActual)}` : '' %>">
                      <button class="btn btn-sm btn-warning" type="submit">
                        <i class="fas fa-edit"></i> Editar
                      </button>
                    </form>
                  </td>
                </tr>
              <% }); %>
            <% } else { %>
              <tr>
                <td colspan="6" class="text-muted">No hay productos para mostrar.</td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>

      <button id="delete-selected" class="btn btn-danger mt-3">Eliminar seleccionados</button>
    </div>
  </main>

  <%- include ./layouts/footer.ejs %>

  <script src="/js/panelControl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script id="productos-data" type="application/json">
    <%- JSON.stringify(productos) %>
  </script>
  <script>
    const productosOriginales = JSON.parse(document.getElementById('productos-data').textContent);
  </script>
</body>
