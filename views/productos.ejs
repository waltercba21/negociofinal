<%- include ./layouts/head.ejs %>
<%- include ./layouts/header.ejs %>

<body>
  <main>
    <h2 class="titulo-principal" id="titulo-principal"> 
      Todos los productos
    </h2>
    <div class="buscador">
      <input type="text" id="entradaBusqueda" placeholder="Buscar productos...">
    </div>

    <form action="/productos" method="GET"> <!-- Asegúrate de que tu formulario esté enviando una solicitud GET a la ruta correcta -->
          <div class="selectores-productos">
    <div class="form-group-crear">
      <label for="categoria_id">Categoria</label>
      <select id="categoria_id" name="categoria_id">
          <option value="" selected>Selecciona una categoría...</option>
          <% categorias.forEach(function(categoria) { %>
              <option value="<%= categoria.id %>"><%= categoria.nombre %></option>
          <% }); %>
      </select>
    </div>
    
    <div class="form-group-crear">
      <label for="marca_id">Marca</label>
      <select id="marca_id" name="marca_id">
        <option value="" selected>Selecciona una marca...</option> <!-- Agrega esta línea -->
        <% marcas.forEach(function(marca) { %>
          <option value="<%= marca.id %>"><%= marca.nombre %></option>
        <% }); %>
      </select>
    </div>
    
    <div class="form-group-crear">
      <label for="modelo_id">Modelo</label>
      <select id="modelo_id" name="modelo_id">
        <option value="" <% if (!modeloQuery) { %>selected<% } %>>Selecciona un modelo...</option>
        <% if (Array.isArray(modelosPorMarca)) { %>
            <% modelosPorMarca.forEach(function(modelo) { %>
              <option value="<%= modelo.id %>" <% if (modeloQuery == modelo.id) { %>selected<% } %>><%= modelo.nombre %></option>
            <% }); %>
        <% } %>
      </select>
    </div>
  </div>

  <div class="boton-buscar">
    <button id="boton-buscar" type="submit">Buscar</button>
  </div>
</form>



    <div id="contenedor-productos" class="contenedor-productos">
      <% productos.forEach(producto => { %>
        <div class="card">
          <div class="cover__card">
            <img src="../../images/<%= producto.imagen %>" alt="Imagen de <%= producto.nombre %>">
          </div>
          <div class="titulo-producto">
            <h3 class="nombre"><%= producto.nombre %></h3>
          </div>
          <hr>
          <div class="categoria-producto">
            <h6 class="categoria"><%= producto.categoria %></h6>
          </div>
          <hr>
          <div class="precio-producto">
            <p class="precio">$<%= producto.precio %></p>
          </div>
          <div class="cantidad-producto">
            <a href="/productos/carrito/agregar/<%= producto.id %>" class="agregar-carrito">Agregar al carrito</a>
          </div>
        </div>
      <% }); %>
    </div>
  </main>
  <%- include ./layouts/footer.ejs %>
  <script src="/js/buscador.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script>
    function llenarModelos(marcaId) { // Abre llenarModelos
      console.log('Llenando modelos para la marca:', marcaId);
  
      $.ajax({ // Abre $.ajax
        url: '/productos/modelos/' + marcaId,
        method: 'GET',
        success: function(modelos) { // Abre success
          try { // Abre try
            if (Array.isArray(modelos)) { // Abre if
              var $modeloSelect = $('#modelo_id');
              $modeloSelect.empty();

              modelos.forEach(function(modelo) { // Abre forEach
                var $option = $('<option></option>');
                $option.val(modelo.id);
                $option.text(modelo.nombre);
                $modeloSelect.append($option);
              }); // Cierra forEach
            } else { // Cierra if y abre else
              throw new Error('La respuesta del servidor no es un array');
            } // Cierra else
          } catch (error) { // Cierra try y abre catch
            console.error('Error: ', error);
          } // Cierra catch
        }, // Cierra success
        error: function(jqXHR, textStatus, errorThrown) { // Abre error
          console.error('Error al obtener los modelos:', textStatus, errorThrown);
          alert('Hubo un problema al obtener los modelos. Por favor, inténtalo de nuevo.');
        } // Cierra error
      }); // Cierra $.ajax

      $(document).ready(function() { // Abre $(document).ready
        // Cuando la marca cambia, llenar los modelos
        $('#marca_id').change(function() { // Abre change
          var marcaId = $(this).val(); 
          console.log('Marca seleccionada:', marcaId);
          llenarModelos(marcaId);
        }); // Cierra change

        $('#boton-buscar').on('click', function(e) { // Abre on
          e.preventDefault(); // Prevenir el comportamiento predeterminado del navegador

          var categoria = $('#categoria_id').val();
          var marca = $('#marca_id').val();
          var modelo = $('#modelo_id').val();

          console.log('Categoria seleccionada:', categoria);
          console.log('Marca seleccionada:', marca);
          console.log('Modelo seleccionado:', modelo);

          $.ajax({ // Abre $.ajax
            url: '/productos', 
            method: 'GET',
            data: {
              categoria_id: categoria,
              marca_id: marca,
              modelo_id: modelo
            },
            success: function(productosFiltrados) { // Abre success
              console.log('Productos filtrados:', productosFiltrados);
              if (Array.isArray(productosFiltrados)) { // Abre if
                renderizarProductos(productosFiltrados);
              } else { // Cierra if y abre else
                console.error('Error: la respuesta del servidor no es un array:', productosFiltrados);
              } // Cierra else
            }, // Cierra success
            error: function(jqXHR, textStatus, errorThrown) { // Abre error
              console.error('Error al obtener los productos:', textStatus, errorThrown);
              alert('Hubo un problema al obtener los productos. Por favor, inténtalo de nuevo.');
            } // Cierra error
          }); // Cierra $.ajax
        }); // Cierra on
      }); // Cierra $(document).ready

      function renderizarProductos(productos) { // Abre renderizarProductos
        var $productosDiv = $('#productos'); // Suponiendo que tienes un div con id 'productos' donde quieres mostrar los productos
        $productosDiv.empty(); // Limpiar el div antes de agregar nuevos productos

        productos.forEach(function(producto) { // Abre forEach
          var $productoDiv = $('<div></div>'); // Crear un nuevo div para cada producto
          $productoDiv.text(producto.nombre); // Suponiendo que cada producto tiene una propiedad 'nombre'
          $productosDiv.append($productoDiv); // Agregar el div del producto al div principal
        }); // Cierra forEach
      } // Cierra renderizarProductos
    } // Cierra llenarModelos
</script>
</body>