<%- include ./layouts/head.ejs %>
<%- include ./layouts/header.ejs %>

<body>
  <main>
    <h2 class="titulo-principal" id="titulo-principal"> 
      Todos los productos
    </h2>
    <div class="buscador">
      <input type="text" id="entradaBusqueda" placeholder="Buscar productos...">
    </div>

    <form action="/productos" method="GET"> <!-- Asegúrate de que tu formulario esté enviando una solicitud GET a la ruta correcta -->
          <div class="selectores-productos">
    <div class="form-group-crear">
      <label for="categoria_id">Categoria</label>
      <select id="categoria_id" name="categoria_id">
          <option value="" selected>Selecciona una categoría...</option>
          <% categorias.forEach(function(categoria) { %>
              <option value="<%= categoria.id %>"><%= categoria.nombre %></option>
          <% }); %>
      </select>
    </div>
    
    <div class="form-group-crear">
      <label for="marca_id">Marca</label>
      <select id="marca_id" name="marca_id">
        <option value="" selected>Selecciona una marca...</option> <!-- Agrega esta línea -->
        <% marcas.forEach(function(marca) { %>
          <option value="<%= marca.id %>"><%= marca.nombre %></option>
        <% }); %>
      </select>
    </div>
    
    <div class="form-group-crear">
      <label for="modelo_id">Modelo</label>
      <select id="modelo_id" name="modelo_id">
        <option value="" <% if (!modeloQuery) { %>selected<% } %>>Selecciona un modelo...</option>
        <% if (Array.isArray(modelosPorMarca)) { %>
            <% modelosPorMarca.forEach(function(modelo) { %>
              <option value="<%= modelo.id %>" <% if (modeloQuery == modelo.id) { %>selected<% } %>><%= modelo.nombre %></option>
            <% }); %>
        <% } %>
      </select>
    </div>
  </div>

  <div class="boton-buscar">
    <button id="boton-buscar" type="submit">Buscar</button>
  </div>
</form>



    <div id="contenedor-productos" class="contenedor-productos">
      <% productos.forEach(producto => { %>
        <div class="card">
          <div class="cover__card">
            <img src="../../images/<%= producto.imagen %>" alt="Imagen de <%= producto.nombre %>">
          </div>
          <div class="titulo-producto">
            <h3 class="nombre"><%= producto.nombre %></h3>
          </div>
          <hr>
          <div class="categoria-producto">
            <h6 class="categoria"><%= producto.categoria %></h6>
          </div>
          <hr>
          <div class="precio-producto">
            <p class="precio">$<%= producto.precio %></p>
          </div>
          <div class="cantidad-producto">
            <a href="/productos/carrito/agregar/<%= producto.id %>" class="agregar-carrito">Agregar al carrito</a>
          </div>
        </div>
      <% }); %>
    </div>
  </main>
  <%- include ./layouts/footer.ejs %>
  <script src="/js/buscador.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
  // Función para llenar los modelos basándose en la marca seleccionada
  function llenarModelos(marcaId) {
    $.ajax({
  url: '/productos', 
  method: 'GET',
  data: {
    categoria_id: categoria,
    marca_id: marca,
    modelo_id: modelo
  },
  success: function(productosFiltrados) {
    if (Array.isArray(productosFiltrados)) {
      renderizarProductos(productosFiltrados);
    } else {
      console.error('Error: la respuesta del servidor no es un array:', productosFiltrados);
      // Aquí puedes manejar el error como prefieras
    }
  },
  error: function(jqXHR, textStatus, errorThrown) {
    console.error('Error al obtener los productos:', textStatus, errorThrown);
    alert('Hubo un problema al obtener los productos. Por favor, inténtalo de nuevo.');
  }
});
  }
  
  // Cuando la marca cambia, llenar los modelos
  $('#marca_id').change(function() {
    var marcaId = $(this).val(); 
    llenarModelos(marcaId);
  });

  // Al cargar la página, si hay una marca seleccionada, llenar los modelos
  $(document).ready(function() {
    var marcaId = $('#marca_id').val();
    if (marcaId) {
      llenarModelos(marcaId);
    }
  });

  function renderizarProductos(productos) {
    // Obtén el contenedor de productos
    if (!Array.isArray(productos)){
    console.error('Error: productos no es un array:', productos);
    return;
  }
    var contenedor = document.getElementById('contenedor-productos');

    // Vacía el contenedor
    contenedor.innerHTML = '';

    // Añade cada producto al contenedor
    productos.forEach(function(producto) {
      var div = document.createElement('div');
      div.className = 'card';

      // Aquí puedes añadir el código para crear el HTML para cada producto
      // Por ejemplo:
      div.innerHTML = `
        <div class="cover__card">
          <img src="../../images/${producto.imagen}" alt="Imagen de ${producto.nombre}">
        </div>
        <div class="titulo-producto">
          <h3 class="nombre">${producto.nombre}</h3>
        </div>
        <hr>
        <div class="categoria-producto">
          <h6 class="categoria">${producto.categoria}</h6>
        </div>
        <hr>
        <div class="precio-producto">
          <p class="precio">$${producto.precio}</p>
        </div>
        <div class="cantidad-producto">
          <a href="/productos/carrito/agregar/${producto.id}" class="agregar-carrito">Agregar al carrito</a>
        </div>
      `;

      contenedor.appendChild(div);
    });
  }

  $(document).ready(function() {
  $('#boton-buscar').on('click', function(e) {
    e.preventDefault(); // Prevenir el comportamiento predeterminado del navegador

    var categoria = $('#categoria_id').val();
    var marca = $('#marca_id').val();
    var modelo = $('#modelo_id').val();

    $.ajax({
      url: '/productos', 
      method: 'GET',
      data: {
        categoria_id: categoria,
        marca_id: marca,
        modelo_id: modelo
      },
      success: function(productosFiltrados) {
          renderizarProductos(productosFiltrados);
      },
      error: function(jqXHR, textStatus, errorThrown) {
          console.error('Error al obtener los productos:', textStatus, errorThrown);
          alert('Hubo un problema al obtener los productos. Por favor, inténtalo de nuevo.');
      }
    });
  });
});
</script>
</body>