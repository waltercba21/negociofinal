<%- include ./layouts/head.ejs %>
<%- include ./layouts/header.ejs %>

<body>
    <main class="container-listadoPresupuesto">
        <h2 class="titulo-listado">Listado de Presupuestos</h2>

        <!-- Date pickers for selecting the date range -->
        <label for="fechaInicio">Desde:</label>
        <input type="date" id="fechaInicio" value="<%= new Date().toISOString().split('T')[0] %>">
        <label for="fechaFin">Hasta:</label>
        <input type="date" id="fechaFin" value="<%= new Date().toISOString().split('T')[0] %>">
        <button id="buscar">Buscar</button>

        <table id="presupuestos-table" class="table-presupuestos">
            <thead class="thead-presupuestos">
                <tr>
                    <th>ID Presupuesto</th>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Total</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <!-- Aquí se insertarán las filas dinámicamente con JavaScript -->
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="4" class="td-presupuestos"><strong>Total:</strong></td>
                    <td id="total-presupuestos" class="tfoot-total"></td>
                </tr>
            </tfoot>
        </table>
    </main>

    <script src="/js/listadoFacturas.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const btnBuscar = document.getElementById('buscar');
            btnBuscar.addEventListener('click', function() {
                const fechaInicio = document.getElementById('fechaInicio').value;
                const fechaFin = document.getElementById('fechaFin').value;
                cargarPresupuestos(fechaInicio, fechaFin);
            });
        });

        function cargarPresupuestos(fechaInicio, fechaFin) {
            fetch(`/productos/api/presupuestos?fechaInicio=${fechaInicio}&fechaFin=${fechaFin}`)
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.querySelector('#presupuestos-table tbody');
                    tableBody.innerHTML = '';  // Limpia la tabla antes de agregar nuevos datos
                    let totalPresupuestos = 0;

                    data.forEach(presupuesto => {
                        totalPresupuestos += parseFloat(presupuesto.total.replace(/\./g, '').replace(',', '.'));
                        const row = `
                            <tr data-id="${presupuesto.id}">
                                <td class="id">${presupuesto.id}</td>
                                <td class="fecha">${presupuesto.fecha}</td>
                                <td class="cliente">${presupuesto.nombre_cliente}</td>
                                <td class="total">${presupuesto.total}</td>
                                <td>
                                    <button class="btn-editar" data-id="${presupuesto.id}">Editar</button>
                                    <button class="btn-eliminar" data-id="${presupuesto.id}">Eliminar</button>
                                    <button class="btn-guardar" data-id="${presupuesto.id}" style="display:none;">Guardar</button>
                                    <button class="btn-cancelar" data-id="${presupuesto.id}" style="display:none;">Cancelar</button>
                                </td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });

                    // Actualiza el total de presupuestos
                    document.getElementById('total-presupuestos').textContent = new Intl.NumberFormat('es-ES', { minimumFractionDigits: 0 }).format(totalPresupuestos);

                    // Agrega eventos a los botones de edición y eliminación
                    document.querySelectorAll('.btn-editar').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            habilitarEdicion(id);
                        });
                    });

                    document.querySelectorAll('.btn-eliminar').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            eliminarPresupuesto(id);
                        });
                    });

                    document.querySelectorAll('.btn-guardar').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            guardarCambios(id);
                        });
                    });

                    document.querySelectorAll('.btn-cancelar').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            cancelarEdicion(id);
                        });
                    });
                })
                .catch(error => console.error('Error al cargar los presupuestos:', error));
        }

        function habilitarEdicion(id) {
            const row = document.querySelector(`tr[data-id="${id}"]`);
            row.querySelector('.fecha').innerHTML = `<input type="date" value="${row.querySelector('.fecha').textContent.split('/').reverse().join('-')}">`;
            row.querySelector('.cliente').innerHTML = `<input type="text" value="${row.querySelector('.cliente').textContent}">`;
            row.querySelector('.total').innerHTML = `<input type="text" value="${row.querySelector('.total').textContent.replace(/\./g, '').replace(',', '.')}">`;

            row.querySelector('.btn-editar').style.display = 'none';
            row.querySelector('.btn-eliminar').style.display = 'none';
            row.querySelector('.btn-guardar').style.display = 'inline';
            row.querySelector('.btn-cancelar').style.display = 'inline';
        }

        function cancelarEdicion(id) {
            const row = document.querySelector(`tr[data-id="${id}"]`);
            const fecha = row.querySelector('.fecha input').value.split('-').reverse().join('/');
            const cliente = row.querySelector('.cliente input').value;
            const total = new Intl.NumberFormat('es-ES', { minimumFractionDigits: 0 }).format(row.querySelector('.total input').value.replace('.', '').replace(',', '.'));

            row.querySelector('.fecha').textContent = fecha;
            row.querySelector('.cliente').textContent = cliente;
            row.querySelector('.total').textContent = total;

            row.querySelector('.btn-editar').style.display = 'inline';
            row.querySelector('.btn-eliminar').style.display = 'inline';
            row.querySelector('.btn-guardar').style.display = 'none';
            row.querySelector('.btn-cancelar').style.display = 'none';
        }

        function guardarCambios(id) {
            const row = document.querySelector(`tr[data-id="${id}"]`);
            const fecha = row.querySelector('.fecha input').value;
            const nombre_cliente = row.querySelector('.cliente input').value;
            const total = parseFloat(row.querySelector('.total input').value.replace('.', '').replace(',', '.'));

            fetch(`/productos/api/presupuestos/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ fecha, nombre_cliente, total })
            })
            .then(response => response.json())
            .then(data => {
                alert('Presupuesto actualizado exitosamente');
                cargarPresupuestos(document.getElementById('fechaInicio').value, document.getElementById('fechaFin').value);
            })
            .catch(error => console.error('Error al actualizar el presupuesto:', error));
        }

        function eliminarPresupuesto(id) {
            if (confirm('¿Está seguro de que desea eliminar este presupuesto?')) {
                fetch(`/productos/api/presupuestos/${id}`, {
                    method: 'DELETE',
                })
                .then(response => response.json())
                .then(data => {
                    alert('Presupuesto eliminado exitosamente');
                    // Recargar la tabla de presupuestos
                    const fechaInicio = document.getElementById('fechaInicio').value;
                    const fechaFin = document.getElementById('fechaFin').value;
                    cargarPresupuestos(fechaInicio, fechaFin);
                })
                .catch(error => console.error('Error al eliminar el presupuesto:', error));
            }
        }
    </script>
</body>
