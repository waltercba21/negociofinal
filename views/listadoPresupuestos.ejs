<%- include ./layouts/head.ejs %>
<%- include ./layouts/header.ejs %>

<body>
    <main class="container-listadoPresupuesto">
        <h2 class="titulo-listado">Listado de Presupuestos</h2>

        <!-- Date pickers for selecting the date range -->
        <label for="fechaInicio">Desde:</label>
        <input type="date" id="fechaInicio" value="<%= new Date().toISOString().split('T')[0] %>">
        <label for="fechaFin">Hasta:</label>
        <input type="date" id="fechaFin" value="<%= new Date().toISOString().split('T')[0] %>">
        <button id="buscar">Buscar</button>

        <table id="presupuestos-table" class="table-presupuestos">
            <thead class="thead-presupuestos">
                <tr>
                    <th>ID Presupuesto</th>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                <!-- Aquí se insertarán las filas dinámicamente con JavaScript -->
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="3" class="td-presupuestos"><strong>Total:</strong></td>
                    <td id="total-presupuestos" class="tfoot-total"></td>
                </tr>
            </tfoot>
        </table>
    </main>

    <script src="/js/listadoFacturas.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const btnBuscar = document.getElementById('buscar');
            btnBuscar.addEventListener('click', function() {
                const fechaInicio = document.getElementById('fechaInicio').value;
                const fechaFin = document.getElementById('fechaFin').value;
                cargarPresupuestos(fechaInicio, fechaFin);
            });
        });
    
        function cargarPresupuestos(fechaInicio, fechaFin) {
            fetch(`/productos/api/presupuestos?fechaInicio=${fechaInicio}&fechaFin=${fechaFin}`)
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.querySelector('#presupuestos-table tbody');
                    tableBody.innerHTML = '';  // Limpia la tabla antes de agregar nuevos datos
                    let totalPresupuestos = 0;
    
                    data.forEach(presupuesto => {
                        totalPresupuestos += parseFloat(presupuesto.total.replace(/\./g, '').replace(',', '.'));
                        const row = `
                            <tr>
                                <td>${presupuesto.id}</td>
                                <td>${presupuesto.fecha}</td>
                                <td>${presupuesto.nombre_cliente}</td>
                                <td>${presupuesto.total}</td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
    
                    // Actualiza el total de presupuestos
                    document.getElementById('total-presupuestos').textContent = new Intl.NumberFormat('es-ES', { minimumFractionDigits: 0 }).format(totalPresupuestos);
                })
                .catch(error => console.error('Error al cargar los presupuestos:', error));
        }
    </script>
    
</body>
