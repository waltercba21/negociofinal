<%- include('./layouts/head.ejs') %>
<%- include('./layouts/header.ejs') %>

<body> 
  <style>/* ================== PEDIDOS ADMIN (DESKTOP) ================== */
:root{
  --brand:#1F487E;
  --brand2:#0B2E59;
  --accent:#d90429;

  --bg:#0b1220;
  --panel:rgba(255,255,255,.92);
  --card:#ffffff;

  --text:#0f172a;
  --muted:rgba(15,23,42,.70);
  --line:rgba(2,6,23,.10);

  --shadow: 0 18px 45px rgba(2,6,23,.18);
  --shadow2: 0 10px 26px rgba(2,6,23,.18);

  --r12:12px;
  --r16:16px;
  --r20:20px;

  --tap:40px;
  --ease:cubic-bezier(.16,1,.3,1);
}

/* Layout */
.admin-container{
  min-height:100vh;
  padding:28px 28px 44px;
  background:
    radial-gradient(1200px 600px at 20% -10%, rgba(31,72,126,.35), transparent 60%),
    radial-gradient(1000px 540px at 90% 0%, rgba(217,4,41,.18), transparent 55%),
    linear-gradient(180deg, #070b14 0%, #0b1220 70%, #0b1220 100%);
  color:var(--text);
}

.pedidos-admin{
  max-width:1200px;
  margin:0 auto;
  background:var(--panel);
  border:1px solid rgba(255,255,255,.22);
  border-radius:var(--r20);
  box-shadow:var(--shadow);
  overflow:hidden;
  backdrop-filter: blur(10px);
}

.titulo-pedidos{
  margin:0;
  padding:18px 22px;
  font-size:18px;
  letter-spacing:.2px;
  color:#fff;
  background:
    linear-gradient(90deg, rgba(31,72,126,.96), rgba(11,46,89,.96));
  border-bottom:1px solid rgba(255,255,255,.18);
  display:flex;
  align-items:center;
  justify-content:space-between;
}

/* Tabla */
.tabla-pedidos{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  background:transparent;
}

.tabla-pedidos thead th{
  position:sticky;
  top:0;
  z-index:2;
  text-align:left;
  font-size:12px;
  letter-spacing:.6px;
  text-transform:uppercase;
  color:rgba(255,255,255,.92);
  background:linear-gradient(90deg, rgba(15,23,42,.94), rgba(2,6,23,.94));
  padding:12px 14px;
  border-bottom:1px solid rgba(255,255,255,.10);
  white-space:nowrap;
}

.tabla-pedidos tbody td{
  padding:14px 14px;
  border-bottom:1px solid var(--line);
  vertical-align:middle;
  color:var(--text);
  background:rgba(255,255,255,.92);
}

.tabla-pedidos tbody tr:nth-child(odd) td{
  background:rgba(248,250,252,.96);
}

.tabla-pedidos tbody tr:hover td{
  background:rgba(240,249,255,.85);
}

.tabla-pedidos tbody td:nth-child(1){
  font-weight:800;
  color:rgba(2,6,23,.86);
  width:90px;
}

.tabla-pedidos tbody td:nth-child(2){
  color:var(--muted);
  width:150px;
}

.tabla-pedidos tbody td:nth-child(3){
  font-weight:700;
}

/* Estado como â€œpillâ€ (sin cambiar tu HTML) */
.tabla-pedidos tbody td:nth-child(4){
  font-weight:800;
  letter-spacing:.2px;
}
.tabla-pedidos tbody td:nth-child(4)::before{
  content:"";
  display:inline-block;
  width:8px;
  height:8px;
  border-radius:999px;
  margin-right:8px;
  background:rgba(15,23,42,.35);
  box-shadow:0 0 0 4px rgba(15,23,42,.06);
  transform:translateY(-1px);
}
/* Estado como pill (base) */
.tabla-pedidos tbody tr td:nth-child(4){
  display:inline-flex;
  align-items:center;
  padding:7px 10px;
  border-radius:999px;
  border:1px solid rgba(2,6,23,.10);
  background:rgba(2,6,23,.03);
  font-weight:800;
  letter-spacing:.2px;
}

.tabla-pedidos tbody td:nth-child(5){
  background:inherit;
}

.tabla-pedidos tbody td[style*="display:flex"]{
  gap:10px !important;
}

/* Botones (incluye los que no tienen clase) */
.tabla-pedidos button{
  appearance:none;
  border:1px solid rgba(2,6,23,.12);
  background:rgba(255,255,255,.92);
  color:rgba(2,6,23,.86);
  border-radius:999px;
  padding:9px 12px;
  min-height:var(--tap);
  font-weight:800;
  font-size:13px;
  cursor:pointer;
  box-shadow: 0 6px 16px rgba(2,6,23,.10);
  transition: transform .12s var(--ease), box-shadow .12s var(--ease), background .12s var(--ease), border-color .12s var(--ease);
  user-select:none;
  white-space:nowrap;
}

.tabla-pedidos button:hover{
  transform: translateY(-1px);
  box-shadow: 0 10px 22px rgba(2,6,23,.14);
  border-color: rgba(31,72,126,.35);
}

.tabla-pedidos button:active{
  transform: translateY(0px) scale(.99);
}

.tabla-pedidos button:focus-visible{
  outline:3px solid rgba(31,72,126,.30);
  outline-offset:2px;
}

/* BotÃ³n â€œVer Detalleâ€ */
.btn-ver-detalle{
  background:linear-gradient(90deg, rgba(31,72,126,.10), rgba(31,72,126,.04)) !important;
  border-color: rgba(31,72,126,.25) !important;
  color: rgba(11,46,89,.95) !important;
}

/* Botones por acciÃ³n (segÃºn el texto del botÃ³n, sin tocar HTML)
   Nota: si querÃ©s 100% exacto, lo ideal es poner clases. Esto es un estilo â€œbest effortâ€. */
.tabla-pedidos button[onclick*="confirmarPedido"]{
  background:linear-gradient(90deg, rgba(34,197,94,.18), rgba(34,197,94,.06));
  border-color: rgba(34,197,94,.35);
}
.tabla-pedidos button[onclick*="prepararPedido"]{
  background:linear-gradient(90deg, rgba(59,130,246,.18), rgba(59,130,246,.06));
  border-color: rgba(59,130,246,.35);
}
.tabla-pedidos button[onclick*="finalizarPedido"]{
  background:linear-gradient(90deg, rgba(16,185,129,.18), rgba(16,185,129,.06));
  border-color: rgba(16,185,129,.35);
}

/* â€œNo hay pedidosâ€ */
.tabla-pedidos tbody tr td[colspan="5"]{
  text-align:center;
  padding:28px 14px;
  color:rgba(15,23,42,.70);
  font-weight:700;
}

/* ================== MODAL DETALLE ================== */
.modal{
  display:none;
  position:fixed;
  inset:0;
  z-index:9999;
  padding:28px;
  background: rgba(2,6,23,.62);
  backdrop-filter: blur(6px);
}

.modal-contenido{
  max-width:1060px;
  margin:34px auto;
  border-radius:var(--r20);
  overflow:hidden;
  background:linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
  border:1px solid rgba(255,255,255,.22);
  box-shadow:var(--shadow);
}

.modal-contenido h3{
  margin:0;
  padding:16px 18px;
  font-size:16px;
  color:#fff;
  background:linear-gradient(90deg, rgba(15,23,42,.96), rgba(2,6,23,.96));
  border-bottom:1px solid rgba(255,255,255,.10);
}

.modal-contenido > p{
  margin:10px 18px 0;
  color:rgba(15,23,42,.80);
}

.cerrar-modal{
  float:right;
  margin:10px 10px 0 0;
  width:40px;
  height:40px;
  display:grid;
  place-items:center;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.16);
  color:#fff;
  background:rgba(255,255,255,.10);
  cursor:pointer;
  transition: transform .12s var(--ease), background .12s var(--ease);
}

.cerrar-modal:hover{
  transform: translateY(-1px);
  background:rgba(255,255,255,.16);
}

.tabla-detalle{
  width:calc(100% - 36px);
  margin:14px 18px 10px;
  border-collapse:separate;
  border-spacing:0;
  overflow:hidden;
  border-radius:var(--r16);
  border:1px solid rgba(2,6,23,.10);
  box-shadow: var(--shadow2);
  background:#fff;
}

.tabla-detalle thead th{
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:.55px;
  padding:12px 12px;
  text-align:left;
  color:rgba(255,255,255,.92);
  background:linear-gradient(90deg, rgba(31,72,126,.96), rgba(11,46,89,.96));
  border-bottom:1px solid rgba(255,255,255,.12);
  white-space:nowrap;
}

.tabla-detalle td{
  padding:12px 12px;
  border-bottom:1px solid rgba(2,6,23,.08);
  color:rgba(2,6,23,.88);
}

.tabla-detalle tbody tr:nth-child(odd) td{
  background:rgba(248,250,252,.92);
}

.total-final{
  margin: 12px 18px 18px;
  padding:12px 14px;
  border-radius:var(--r16);
  background:linear-gradient(90deg, rgba(217,4,41,.10), rgba(31,72,126,.08));
  border:1px solid rgba(2,6,23,.10);
  font-weight:900;
  color:rgba(2,6,23,.90);
}

.total-final span{
  font-variant-numeric: tabular-nums;
}
</style>
 <main class="admin-container">
  <div class="pedidos-admin">
    <h2 class="titulo-pedidos">Pedidos Recibidos</h2>

    <table class="tabla-pedidos">
      <thead>
        <tr>
          <th>ID</th>
          <th>Fecha</th>
          <th>Cliente</th>
          <th>EnvÃ­o</th>
          <th>DirecciÃ³n</th>
          <th>Estado</th>
          <th>Total</th>
          <th>Acciones</th>
        </tr>
      </thead>

      <tbody>
        <% 
          const norm = (s) => (s ?? '')
            .toString()
            .toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // quita tildes (preparaciÃ³n -> preparacion)
            .replace(/[_-]+/g,' ')
            .replace(/\s+/g,' ')
            .trim();
        %>

        <% if (pedidos && pedidos.length > 0) { %>
          <% pedidos.forEach(pedido => { 
            const estN = norm(pedido.estado);

            // si llega algo "carrito", lo ocultamos
            if (estN === 'carrito') return;

            const tipoEnvio = (pedido.tipo_envio === 'delivery') ? 'Delivery' : 'Retiro en local';
            const direccion = (pedido.tipo_envio === 'delivery') ? (pedido.direccion || '-') : '-';

            const subtotalProductos = Number(pedido.subtotal_productos ?? 0);
            const costoEnvio = Number(pedido.costo_envio ?? 0);
            const totalFinal = Number(
              pedido.total ?? pedido.total_final ?? (subtotalProductos + costoEnvio) ?? 0
            );
          %>

            <tr>
              <td><%= pedido.id_pedido %></td>
              <td><%= pedido.fecha ? new Date(pedido.fecha).toLocaleDateString('es-AR') : '' %></td>
              <td><%= pedido.cliente %></td>
              <td><%= tipoEnvio %></td>
              <td><%= direccion %></td>
              <td><%= pedido.estado %></td>
              <td>$<%= totalFinal.toLocaleString('es-AR') %></td>

              <td style="display:flex; gap:8px; flex-wrap:wrap;">
                <button class="btn-ver-detalle" data-carrito-id="<%= pedido.id_pedido %>">ðŸ›  Ver Detalle</button>

                <% if (estN === 'pendiente') { %>
                  <button onclick='confirmarPedido("<%= pedido.id_pedido %>")'>âœ… Confirmar</button>
                <% } %>

                <% if (estN === 'confirmado') { %>
                  <button onclick='prepararPedido("<%= pedido.id_pedido %>")'>ðŸ“¦ En preparaciÃ³n</button>
                <% } %>

                <% if (estN === 'preparacion') { %>
                  <button onclick='finalizarPedido("<%= pedido.id_pedido %>")'>âœ… Finalizar</button>
                <% } %>

                <% if (estN === 'listo para entrega') { %>
                  <button onclick='finalizarPedido("<%= pedido.id_pedido %>")'>âœ… Finalizar</button>
                <% } %>

                <% if (estN === 'finalizado') { %>
                  <span style="padding:6px 10px;border-radius:999px;font-weight:700;background:#d4edda;color:#155724;">
                    âœ… FINALIZADO
                  </span>
                <% } %>
              </td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr><td colspan="8">No hay pedidos.</td></tr>
        <% } %>
      </tbody>
    </table>
  </div>

  <div id="modal-preparar" class="modal">
    <div class="modal-contenido">
      <span class="cerrar-modal" onclick="cerrarModal()">&times;</span>
      <h3>Detalle del Pedido</h3>

      <p><strong>Cliente:</strong> <span id="nombre-cliente"></span></p>
      <p><strong>Fecha:</strong> <span id="fecha-pedido"></span></p>

      <p><strong>EnvÃ­o:</strong> <span id="tipo-envio"></span></p>
      <p><strong>DirecciÃ³n:</strong> <span id="direccion-envio"></span></p>

      <table class="tabla-detalle">
        <thead>
          <tr>
            <th>CÃ³digo</th>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Precio Unitario</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody id="detalle-productos"></tbody>
      </table>

      <p><strong>Subtotal productos:</strong> <span id="subtotal-productos"></span></p>
      <p><strong>Costo envÃ­o:</strong> <span id="costo-envio"></span></p>

      <p class="total-final">Total: <span id="total-final"></span></p>
    </div>
  </div>
</main>


  <%- include('./layouts/footer.ejs') %>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9999;padding:24px;overflow:auto;}
    .modal-contenido{background:#fff;color:#111;max-width:980px;margin:40px auto;padding:18px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35);}
    .cerrar-modal{float:right;cursor:pointer;font-size:26px;line-height:1;padding:6px 10px;border-radius:8px;}
    .cerrar-modal:hover{background:rgba(0,0,0,.06);}
    .tabla-detalle{width:100%;border-collapse:collapse;background:#fff;}
    .tabla-detalle th,.tabla-detalle td{border:1px solid rgba(0,0,0,.12);padding:8px;vertical-align:top;}
    .total-final{margin-top:10px;font-weight:700;}
  </style>

  <script>
  window.addEventListener("DOMContentLoaded", () => {
    const $ = (id) => document.getElementById(id);

    function money(n) {
      return `$${Number(n || 0).toLocaleString('es-AR')}`;
    }

    function formatFecha(v) {
      if (!v) return '-';
      const d = new Date(v);
      return isNaN(d.getTime()) ? String(v) : d.toLocaleString('es-AR');
    }

    function cerrarModal() {
      const modal = $("modal-preparar");
      if (modal) modal.style.display = "none";
    }
    window.cerrarModal = cerrarModal;

    const modal = $("modal-preparar");
    if (modal) {
      modal.addEventListener("click", (e) => {
        if (e.target && e.target.id === "modal-preparar") cerrarModal();
      });
    }

    document.querySelectorAll('.btn-ver-detalle').forEach(btn => {
      btn.addEventListener('click', async () => {
        const carritoId = btn.dataset.carritoId;

        try {
          const response = await fetch(`/pedidos/${carritoId}/detalle`);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();

          const cuerpoTabla = document.querySelector('#detalle-productos');
          if (cuerpoTabla) cuerpoTabla.innerHTML = '';

          // Datos principales
          if ($('nombre-cliente')) $('nombre-cliente').textContent = data.cliente || '-';
          if ($('fecha-pedido')) $('fecha-pedido').textContent = formatFecha(data.fecha);

          // EnvÃ­o
          const esDelivery = (data.tipo_envio === 'delivery');
          if ($('tipo-envio')) $('tipo-envio').textContent = esDelivery ? 'Delivery' : 'Retiro en local';
          if ($('direccion-envio')) $('direccion-envio').textContent = esDelivery ? (data.direccion || '-') : '-';

          // Totales (segÃºn el model corregido)
          if ($('subtotal-productos')) $('subtotal-productos').textContent = money(data.total_productos);
          if ($('costo-envio')) $('costo-envio').textContent = money(data.costo_envio);
          if ($('total-final')) $('total-final').textContent = money(data.total);

          // Productos
          (data.productos || []).forEach(producto => {
            const fila = document.createElement('tr');
            fila.innerHTML = `
              <td>${producto.codigo ?? ''}</td>
              <td>${producto.nombre ?? ''}</td>
              <td>${producto.cantidad ?? 0}</td>
              <td>${money(producto.precio_unitario)}</td>
              <td>${money(producto.subtotal)}</td>
            `;
            if (cuerpoTabla) cuerpoTabla.appendChild(fila);
          });

          if (modal) modal.style.display = "block";
        } catch (err) {
          Swal.fire('Error', 'No se pudo cargar el detalle del pedido.', 'error');
        }
      });
    });

    async function postJson(url) {
      const res = await fetch(url, { method: 'POST' });
      let data = null;
      try { data = await res.json(); } catch (_) {}
      if (!res.ok) throw new Error((data && data.error) ? data.error : `Error HTTP ${res.status}`);
      return data || {};
    }

    window.confirmarPedido = async function(id) {
      try {
        const data = await postJson(`/pedidos/confirmar/${id}`);
        Swal.fire('Pedido confirmado', data.mensaje || 'OK', 'success');
        setTimeout(() => location.reload(), 900);
      } catch (err) {
        Swal.fire('Error', err.message || 'No se pudo confirmar.', 'error');
      }
    }

    window.prepararPedido = async function(id) {
      try {
        const data = await postJson(`/pedidos/marcar-preparado/${id}`);
        Swal.fire('En preparaciÃ³n', data.mensaje || 'OK', 'info');
        setTimeout(() => location.reload(), 900);
      } catch (err) {
        Swal.fire('Error', err.message || 'No se pudo preparar.', 'error');
      }
    }

    window.finalizarPedido = async function(id) {
      try {
        const data = await postJson(`/pedidos/finalizar/${id}`);
        Swal.fire('Pedido finalizado', data.mensaje || 'OK', 'success');
        setTimeout(() => location.reload(), 900);
      } catch (err) {
        Swal.fire('Error', err.message || 'No se pudo finalizar.', 'error');
      }
    }
  });
</script>

</body>
