<%- include('./layouts/head.ejs') %>
<%- include('./layouts/header.ejs') %>

<body>
  <main class="admin-container">
    <div class="pedidos-admin">
      <h2 class="titulo-pedidos">Pedidos Recibidos</h2>

      <!-- Tabla de pedidos -->
      <table class="tabla-pedidos">
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha</th>
            <th>Cliente</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <% if (pedidos.length > 0) { %>
            <% pedidos.forEach(pedido => { %>
              <tr>
                <td><%= pedido.id_pedido %></td>
                <td><%= pedido.fecha ? new Date(pedido.fecha).toLocaleDateString('es-AR') : '' %></td>
                <td><%= pedido.cliente %></td>
                <td><%= pedido.estado %></td>
                <td style="display:flex; gap:8px; flex-wrap:wrap;">
                  <button class="btn-ver-detalle" data-carrito-id="<%= pedido.id_pedido %>">üõ† Ver Detalle</button>

                  <!-- ‚úÖ NUEVO: confirmar (aceptar) pedido -->
                  <button onclick='confirmarPedido("<%= pedido.id_pedido %>")'>‚úÖ Confirmar</button>

                  <button onclick='prepararPedido("<%= pedido.id_pedido %>")'>üì¶ Preparar</button>
                  <button onclick='finalizarPedido("<%= pedido.id_pedido %>")'>‚úÖ Finalizar</button>
                </td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr><td colspan="6">No hay pedidos pendientes.</td></tr>
          <% } %>
        </tbody>
      </table>
    </div>

    <!-- MODAL EMERGENTE (detalle pedido) -->
    <div id="modal-preparar" class="modal">
      <div class="modal-contenido">
        <span class="cerrar-modal" onclick="cerrarModal()">&times;</span>
        <h3>Detalle del Pedido</h3>

        <p><strong>Cliente:</strong> <span id="nombre-cliente"></span></p>
        <p><strong>Fecha:</strong> <span id="fecha-pedido"></span></p>

        <table class="tabla-detalle">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Producto</th>
              <th>Cantidad</th>
              <th>Precio Unitario</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody id="detalle-productos">
            <!-- Se insertan con JS -->
          </tbody>
        </table>

        <p class="total-final">Total: <span id="total-final"></span></p>
      </div>
    </div>
  </main>

  <%- include('./layouts/footer.ejs') %>

  <!-- Asegurar SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* ‚úÖ FIX UX: modal visible */
    .modal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      z-index:9999;
      padding:24px;
      overflow:auto;
    }
    .modal-contenido{
      background:#fff;
      color:#111;
      max-width:980px;
      margin:40px auto;
      padding:18px 18px 12px 18px;
      border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .cerrar-modal{
      float:right;
      cursor:pointer;
      font-size:26px;
      line-height:1;
      padding:6px 10px;
      border-radius:8px;
    }
    .cerrar-modal:hover{ background:rgba(0,0,0,.06); }
    .tabla-detalle{
      width:100%;
      border-collapse:collapse;
      background:#fff;
    }
    .tabla-detalle th, .tabla-detalle td{
      border:1px solid rgba(0,0,0,.12);
      padding:8px;
      vertical-align:top;
    }
    .total-final{ margin-top:10px; font-weight:700; }
  </style>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      // Socket.io listener (admin)
      if (typeof io !== 'undefined') {
        if (!window.socket) {
          window.socket = io();
          socket.on("nuevoPedido", (data) => {
            const pedidoId = data.id_pedido || data.id_carrito || data.id;
            Swal.fire({
              title: 'üì¶ Nuevo pedido recibido',
              text: `Pedido #${pedidoId} - Estado: "${data.estado}"`,
              icon: 'info',
              confirmButtonText: 'Ver pedidos',
              showCancelButton: true,
              cancelButtonText: 'Cerrar',
              timer: 7000,
              timerProgressBar: true
            }).then((result) => {
              if (result.isConfirmed) window.location.href = '/pedidos';
            });
          });

          // (opcional) si tu backend emite cambios de estado
          socket.on("pedidoActualizado", (data) => {
            const pedidoId = data.id_pedido || data.id_carrito || data.id;
            Swal.fire({
              title: 'üîî Pedido actualizado',
              text: `Pedido #${pedidoId} - Estado: "${data.estado}"`,
              icon: data.estado === "finalizado" ? 'success' : 'info',
              timer: 4500,
              timerProgressBar: true
            });
          });
        }
      } else {
        console.warn("‚ùå Socket.IO no est√° disponible");
      }

      // Modal detalle
      function cerrarModal() {
        document.getElementById("modal-preparar").style.display = "none";
      }
      window.cerrarModal = cerrarModal;

      // Cerrar modal clickeando fuera
      document.getElementById("modal-preparar").addEventListener("click", (e) => {
        if (e.target.id === "modal-preparar") cerrarModal();
      });

      document.querySelectorAll('.btn-ver-detalle').forEach(btn => {
        btn.addEventListener('click', async () => {
          const carritoId = btn.dataset.carritoId;
          try {
            const response = await fetch(`/pedidos/${carritoId}/detalle`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();

            const cuerpoTabla = document.querySelector('#detalle-productos');
            const nombreCliente = document.getElementById('nombre-cliente');
            const fechaPedido = document.getElementById('fecha-pedido');
            const totalFinal = document.getElementById('total-final');

            cuerpoTabla.innerHTML = '';
            nombreCliente.textContent = data.cliente || '-';
            fechaPedido.textContent = data.fecha || '-';
            totalFinal.textContent = `$${Number(data.total || 0).toLocaleString('es-AR')}`;

            (data.productos || []).forEach(producto => {
              const fila = document.createElement('tr');
              fila.innerHTML = `
                <td>${producto.codigo ?? ''}</td>
                <td>${producto.nombre ?? ''}</td>
                <td>${producto.cantidad ?? 0}</td>
                <td>$${Number(producto.precio_unitario || 0).toLocaleString('es-AR')}</td>
                <td>$${Number(producto.subtotal || 0).toLocaleString('es-AR')}</td>
              `;
              cuerpoTabla.appendChild(fila);
            });

            document.getElementById("modal-preparar").style.display = "block";
          } catch (err) {
            console.error('‚ùå Error al obtener detalle del pedido:', err);
            Swal.fire('Error', 'No se pudo cargar el detalle del pedido.', 'error');
          }
        });
      });

      // Helpers fetch JSON con errores claros
      async function postJson(url) {
        const res = await fetch(url, { method: 'POST' });
        let data = null;
        try { data = await res.json(); } catch (_) {}
        if (!res.ok) {
          const msg = (data && data.error) ? data.error : `Error HTTP ${res.status}`;
          throw new Error(msg);
        }
        return data || {};
      }

      // ‚úÖ NUEVO: confirmar pedido
      window.confirmarPedido = async function(id) {
        try {
          const data = await postJson(`/pedidos/confirmar/${id}`);
          Swal.fire('Pedido confirmado', data.mensaje || 'El pedido fue confirmado.', 'success');
          setTimeout(() => location.reload(), 1200);
        } catch (err) {
          console.error('‚ùå Error al confirmar pedido:', err);
          Swal.fire('Error', err.message || 'No se pudo confirmar el pedido.', 'error');
        }
      }

      // Preparar pedido
      window.prepararPedido = async function(id) {
        try {
          const data = await postJson(`/pedidos/marcar-preparado/${id}`);
          Swal.fire('En preparaci√≥n', data.mensaje || 'Pedido marcado como en preparaci√≥n.', 'info');

          // PDF preparaci√≥n (si existe)
          const ventanaPDF = window.open(`/pedidos/${id}/pdf-preparacion`, '_blank');
          if (ventanaPDF) {
            ventanaPDF.onload = () => ventanaPDF.print();
          }

          setTimeout(() => location.reload(), 1500);
        } catch (err) {
          console.error('‚ùå Error al preparar pedido:', err);
          Swal.fire('Error', err.message || 'No se pudo marcar como en preparaci√≥n.', 'error');
        }
      }

      // Finalizar pedido
      window.finalizarPedido = async function(id) {
        try {
          const data = await postJson(`/pedidos/finalizar/${id}`);
          Swal.fire('Pedido finalizado', data.mensaje || 'Pedido finalizado correctamente.', 'success');
          setTimeout(() => location.reload(), 1200);
        } catch (err) {
          console.error('‚ùå Error al finalizar pedido:', err);
          Swal.fire('Error', err.message || 'No se pudo finalizar el pedido.', 'error');
        }
      }
    });
  </script>

</body>
