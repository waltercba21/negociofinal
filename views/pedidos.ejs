<%- include('./layouts/head.ejs') %>
<%- include('./layouts/header.ejs') %>

<body>
  <main class="admin-container">
    <div class="pedidos-admin">
      <h2 class="titulo-pedidos">Pedidos Recibidos</h2>

      <table class="tabla-pedidos">
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha</th>
            <th>Cliente</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <% if (pedidos.length > 0) { %>
            <% pedidos.forEach(pedido => { 
              const est = (pedido.estado || '').toLowerCase();
            %>

              <% // Si todavÃ­a te llegan carritos abiertos desde backend, los ocultamos como â€œparcheâ€:
                 // Ideal: filtrarlo en el controlador/modelo (WHERE estado <> 'carrito')
                 if (est === 'carrito') { %>
                <% return; %>
              <% } %>

              <tr>
                <td><%= pedido.id_pedido %></td>
                <td><%= pedido.fecha ? new Date(pedido.fecha).toLocaleDateString('es-AR') : '' %></td>
                <td><%= pedido.cliente %></td>
                <td><%= pedido.estado %></td>

                <td style="display:flex; gap:8px; flex-wrap:wrap;">
                  <button class="btn-ver-detalle" data-carrito-id="<%= pedido.id_pedido %>">ðŸ›  Ver Detalle</button>

                  <% if (est === 'pendiente') { %>
                    <button onclick='confirmarPedido("<%= pedido.id_pedido %>")'>âœ… Confirmar</button>
                  <% } %>

                  <% if (est === 'preparaciÃ³n') { %>
                    <button onclick='prepararPedido("<%= pedido.id_pedido %>")'>ðŸ“¦ Preparar</button>
                    <button onclick='finalizarPedido("<%= pedido.id_pedido %>")'>âœ… Finalizar</button>
                  <% } %>

                  <% if (est === 'listo para entrega') { %>
                    <button onclick='finalizarPedido("<%= pedido.id_pedido %>")'>âœ… Finalizar</button>
                  <% } %>

                  <% if (est === 'finalizado') { %>
                    <span style="padding:6px 10px;border-radius:999px;font-weight:700;background:#d4edda;color:#155724;">
                      âœ… FINALIZADO
                    </span>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr><td colspan="5">No hay pedidos.</td></tr>
          <% } %>
        </tbody>
      </table>
    </div>

    <div id="modal-preparar" class="modal">
      <div class="modal-contenido">
        <span class="cerrar-modal" onclick="cerrarModal()">&times;</span>
        <h3>Detalle del Pedido</h3>

        <p><strong>Cliente:</strong> <span id="nombre-cliente"></span></p>
        <p><strong>Fecha:</strong> <span id="fecha-pedido"></span></p>

        <table class="tabla-detalle">
          <thead>
            <tr>
              <th>CÃ³digo</th>
              <th>Producto</th>
              <th>Cantidad</th>
              <th>Precio Unitario</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody id="detalle-productos"></tbody>
        </table>

        <p class="total-final">Total: <span id="total-final"></span></p>
      </div>
    </div>
  </main>

  <%- include('./layouts/footer.ejs') %>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9999;padding:24px;overflow:auto;}
    .modal-contenido{background:#fff;color:#111;max-width:980px;margin:40px auto;padding:18px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35);}
    .cerrar-modal{float:right;cursor:pointer;font-size:26px;line-height:1;padding:6px 10px;border-radius:8px;}
    .cerrar-modal:hover{background:rgba(0,0,0,.06);}
    .tabla-detalle{width:100%;border-collapse:collapse;background:#fff;}
    .tabla-detalle th,.tabla-detalle td{border:1px solid rgba(0,0,0,.12);padding:8px;vertical-align:top;}
    .total-final{margin-top:10px;font-weight:700;}
  </style>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      function cerrarModal() {
        document.getElementById("modal-preparar").style.display = "none";
      }
      window.cerrarModal = cerrarModal;

      document.getElementById("modal-preparar").addEventListener("click", (e) => {
        if (e.target.id === "modal-preparar") cerrarModal();
      });

      document.querySelectorAll('.btn-ver-detalle').forEach(btn => {
        btn.addEventListener('click', async () => {
          const carritoId = btn.dataset.carritoId;
          try {
            const response = await fetch(`/pedidos/${carritoId}/detalle`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();

            const cuerpoTabla = document.querySelector('#detalle-productos');
            cuerpoTabla.innerHTML = '';

            document.getElementById('nombre-cliente').textContent = data.cliente || '-';
            document.getElementById('fecha-pedido').textContent = data.fecha || '-';
            document.getElementById('total-final').textContent = `$${Number(data.total || 0).toLocaleString('es-AR')}`;

            (data.productos || []).forEach(producto => {
              const fila = document.createElement('tr');
              fila.innerHTML = `
                <td>${producto.codigo ?? ''}</td>
                <td>${producto.nombre ?? ''}</td>
                <td>${producto.cantidad ?? 0}</td>
                <td>$${Number(producto.precio_unitario || 0).toLocaleString('es-AR')}</td>
                <td>$${Number(producto.subtotal || 0).toLocaleString('es-AR')}</td>
              `;
              cuerpoTabla.appendChild(fila);
            });

            document.getElementById("modal-preparar").style.display = "block";
          } catch (err) {
            Swal.fire('Error', 'No se pudo cargar el detalle del pedido.', 'error');
          }
        });
      });

      async function postJson(url) {
        const res = await fetch(url, { method: 'POST' });
        let data = null;
        try { data = await res.json(); } catch (_) {}
        if (!res.ok) throw new Error((data && data.error) ? data.error : `Error HTTP ${res.status}`);
        return data || {};
      }

      window.confirmarPedido = async function(id) {
        try {
          const data = await postJson(`/pedidos/confirmar/${id}`);
          Swal.fire('Pedido confirmado', data.mensaje || 'OK', 'success');
          setTimeout(() => location.reload(), 900);
        } catch (err) {
          Swal.fire('Error', err.message || 'No se pudo confirmar.', 'error');
        }
      }

      window.prepararPedido = async function(id) {
        try {
          const data = await postJson(`/pedidos/marcar-preparado/${id}`);
          Swal.fire('En preparaciÃ³n', data.mensaje || 'OK', 'info');
          setTimeout(() => location.reload(), 900);
        } catch (err) {
          Swal.fire('Error', err.message || 'No se pudo preparar.', 'error');
        }
      }

      window.finalizarPedido = async function(id) {
        try {
          const data = await postJson(`/pedidos/finalizar/${id}`);
          Swal.fire('Pedido finalizado', data.mensaje || 'OK', 'success');
          setTimeout(() => location.reload(), 900);
        } catch (err) {
          Swal.fire('Error', err.message || 'No se pudo finalizar.', 'error');
        }
      }
    });
  </script>
</body>
