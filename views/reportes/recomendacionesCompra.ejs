<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Recomendaciones de compra</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; padding:24px; color:#0f172a; }
    h1 { margin:0 0 4px; font-size:22px; }
    h3 { margin: 12px 0 8px; }
    .sub { color:#475569; font-size:12px; margin-bottom:16px; }
    .muted { color:#64748b; font-size:12px; }
    .section { margin-top:18px; page-break-inside: avoid; }
    table { border-collapse: collapse; width:100%; font-size:12px; }
    th, td { border-bottom:1px solid #e2e8f0; text-align:left; padding:8px 6px; }
    th { background:#f8fafc; text-transform:uppercase; letter-spacing:.4px; font-size:11px; color:#334155; }
    .num { text-align:right; font-variant-numeric: tabular-nums; white-space:nowrap; }
  </style>
</head>
<body>
  <h1>Recomendaciones de compra</h1>
  <div class="sub">
    Según el filtro aplicado, estos son los productos a considerar para mantener stock y responder a la demanda.
  </div>
  <div class="muted">
    <strong>Filtros:</strong>
    <%= filtros?.categoria_id ? ('Categoría ID ' + filtros.categoria_id) : 'Todas las categorías' %> ·
    <%= filtros?.desde ? ('Desde ' + filtros.desde) : 'Sin fecha desde' %> ·
    <%= filtros?.hasta ? ('Hasta ' + filtros.hasta) : 'Sin fecha hasta' %>
  </div>

  <!-- Top 50 más vendidos -->
  <div class="section">
    <h3>Top 50 productos más vendidos</h3>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Producto</th>
          <th class="num">Ventas</th>
        </tr>
      </thead>
      <tbody>
      <% (topVendidos || []).forEach((p,i)=>{ %>
        <tr>
          <td><%= i+1 %></td>
          <td><%= p.nombre %></td>
          <td class="num"><%= Number(p.total_vendido || 0) %></td>
        </tr>
      <% }) %>
      </tbody>
    </table>
  </div>

  <!-- Top 50 más buscados con desglose -->
  <div class="section">
    <h3>Top 50 productos más buscados (con desglose)</h3>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Producto</th>
          <th class="num">Clicks</th>
          <th class="num">Búsquedas texto</th>
          <th class="num">Total buscado</th>
          <th class="num">Ventas</th>
        </tr>
      </thead>
      <tbody>
      <% (topBuscados || []).forEach((r,i)=>{ %>
        <tr>
          <td><%= i+1 %></td>
          <td><%= r.nombre %></td>
          <td class="num"><%= Number(r.clicks || 0) %></td>
          <td class="num"><%= Number(r.textos || 0) %></td>
          <td class="num"><%= (Number(r.total_buscado) || 0).toFixed(1) %></td>
          <td class="num"><%= Number(r.ventas || 0) %></td>
        </tr>
      <% }) %>
      </tbody>
    </table>
  </div>

  <!-- Sugerido de compra (Top 50) -->
  <div class="section">
    <h3>Sugerido de compra (Top 50)</h3>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Producto</th>
          <th class="num">Ventas (período)</th>
          <th class="num">Stock actual</th>
          <th class="num">Stock mínimo</th>
          <th class="num">Cobertura obj. (días)</th>
          <th class="num">Sugerido</th>
        </tr>
      </thead>
      <tbody>
      <% (topSugeridos || []).forEach((r,i)=>{ %>
        <tr>
          <td><%= i+1 %></td>
          <td><%= r.nombre %></td>
          <td class="num"><%= Number(r.ventas_periodo || 0) %></td>
          <td class="num"><%= Number(r.stock_actual || 0) %></td>
          <td class="num"><%= Number(r.stock_minimo || 0) %></td>
          <td class="num"><%= Number(r.cobertura_objetivo || 0) %></td>
          <td class="num"><strong><%= Number(r.sugerido || 0) %></strong></td>
        </tr>
      <% }) %>
      </tbody>
    </table>
  </div>
</body>
</html>
