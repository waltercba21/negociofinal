<%- include('./layouts/head.ejs') %>
<%- include('./layouts/header.ejs') %>

<%
  const productosList = Array.isArray(productos) ? productos : [];
  const pedidosList = (typeof pedidos !== 'undefined' && Array.isArray(pedidos)) ? pedidos : [];

  const fmtARS0 = (n) => new Intl.NumberFormat('es-AR').format(Math.round(Number(n) || 0));
  const fmtARS2 = (n) =>
    Number(n || 0).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  const totalValue = Number(total || 0);
  const estado = (estadoCarrito || '').toLowerCase();

  const badgeClass =
    estado === 'preparaci√≥n' ? 'badge badge-prep' :
    estado === 'listo para entrega' ? 'badge badge-entrega' :
    estado === 'finalizado' ? 'badge badge-final' :
    estado ? 'badge badge-otro' : 'badge badge-otro';
%>

<body>
  <main class="carrito-container">
    <h1>‚úÖ Pago confirmado</h1>

    <style>
      :root{
        --af-bg:#f6f8fb;
        --af-card:#ffffff;
        --af-text:#0f172a;
        --af-muted:#64748b;
        --af-border:#e5e7eb;
        --af-primary:#1d4ed8;
        --af-danger:#ef4444;
        --af-shadow: 0 12px 30px rgba(2,6,23,.08);

        --tap: 44px;
        --radius: 18px;
      }

      body{ background: var(--af-bg); }

      .carrito-container{
        max-width: 980px;
        margin: 28px auto;
        padding: 0 16px 160px; /* sticky */
        color: var(--af-text);
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      }

      .carrito-container h1{
        margin: 0 0 10px 0;
        font-size: 28px;
        font-weight: 900;
        display:flex;
        align-items:center;
        justify-content:center;
        gap:10px;
        text-align:center;
      }

      .wrap{
        background: var(--af-card);
        border: 1px solid var(--af-border);
        border-radius: var(--radius);
        padding: 18px;
        box-shadow: var(--af-shadow);
      }

      .subhead{
        margin: 6px 0 14px 0;
        opacity: .85;
        font-weight: 900;
        text-align:center;
      }

      /* Helpers */
      .desktop-only{ display:block; }
      .mobile-only{ display:none; }

      /* Tabla (desktop) */
      .carrito-tabla{
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        overflow: hidden;
        border-radius: 14px;
        border: 1px solid var(--af-border);
        background: #fff;
      }

      .carrito-tabla thead th{
        background: #0b1220;
        color: #fff;
        font-weight: 900;
        font-size: 12px;
        letter-spacing: .06em;
        text-transform: uppercase;
        padding: 14px 12px;
      }

      .carrito-tabla tbody td{
        padding: 14px 12px;
        border-bottom: 1px solid var(--af-border);
        vertical-align: middle;
        font-weight: 800;
        font-size: 14px;
      }

      .carrito-tabla tbody tr:last-child td{ border-bottom: none; }

      .imagen-miniatura{
        width: 56px;
        height: 56px;
        object-fit: contain;
        border-radius: 12px;
        border: 1px solid var(--af-border);
        background: #fff;
        padding: 6px;
      }

      .money{
        font-variant-numeric: tabular-nums;
        white-space: nowrap;
        font-weight: 950;
      }

      .carrito-total td{
        background: rgba(15,23,42,.02);
        font-weight: 950;
      }

      /* Estado */
      .estado-pedido{
        margin-top: 14px;
        border: 1px solid var(--af-border);
        border-radius: 16px;
        background: #fff;
        padding: 14px;
      }
      .estado-pedido h2{
        margin: 0 0 8px 0;
        font-size: 14px;
        font-weight: 950;
        display:flex;
        align-items:center;
        gap: 8px;
      }
      .estado-pedido p{
        margin: 6px 0;
        color: var(--af-muted);
        font-weight: 900;
      }
      .estado-pedido p strong{ color: var(--af-text); }

      .badge{
        display:inline-block;
        padding: 6px 10px;
        border-radius: 999px;
        font-weight: 950;
        font-size: .85rem;
        line-height: 1;
        white-space: nowrap;
      }
      .badge-prep{ background:#fff3cd; color:#856404; }
      .badge-entrega{ background:#d1ecf1; color:#0c5460; }
      .badge-final{ background:#d4edda; color:#155724; }
      .badge-otro{ background:#eee; color:#444; }

      /* Botones */
      .btn-row{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        margin-top: 14px;
      }

      .btn-finalizar{
        min-height: var(--tap);
        padding: 12px 18px;
        border-radius: 14px;
        font-weight: 950;
        border: none;
        background: var(--af-primary);
        color: #fff;
        cursor: pointer;
        box-shadow: 0 12px 20px rgba(29,78,216,.20);
        transition: transform .12s ease, filter .12s ease;
        text-decoration:none;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        gap: 10px;
      }
      .btn-finalizar:hover{ filter: brightness(1.05); transform: translateY(-1px); }
      .btn-finalizar:active{ transform: translateY(0); }
      .btn-finalizar:disabled{
        opacity: .55;
        cursor: not-allowed;
        transform: none;
      }

      .btn-ghost{
        background: transparent;
        color: var(--af-text);
        border: 1px solid var(--af-border);
        box-shadow: none;
      }
      .btn-ghost:hover{ background: rgba(15,23,42,.04); filter:none; }

      /* Mobile cards */
      .cart-cards{ display:flex; flex-direction:column; gap: 12px; }

      .cart-card{
        border: 1px solid var(--af-border);
        background:#fff;
        border-radius: 16px;
        box-shadow: 0 10px 22px rgba(2,6,23,.06);
        padding: 12px;
      }

      .cart-card__top{
        display:flex;
        gap: 12px;
        align-items:flex-start;
      }

      .cart-card__img{
        width: 64px;
        height: 64px;
        border-radius: 14px;
        border: 1px solid var(--af-border);
        background:#fff;
        object-fit: contain;
        padding: 8px;
        flex: 0 0 auto;
      }

      .cart-card__info{
        flex: 1 1 auto;
        min-width: 0;
      }

      .cart-card__name{
        font-weight: 950;
        font-size: 14px;
        line-height: 1.2;
        margin: 2px 0 6px 0;
        word-break: break-word;
      }

      .cart-card__meta{
        display:flex;
        gap: 10px;
        flex-wrap:wrap;
        color: var(--af-muted);
        font-weight: 900;
        font-size: 12px;
      }
      .cart-card__meta strong{ color: var(--af-text); }

      .divider{
        height: 1px;
        background: var(--af-border);
        margin: 10px 0;
        opacity:.9;
      }

      .totals-card{
        border: 1px solid rgba(29,78,216,.18);
        background: rgba(29,78,216,.05);
        border-radius: 16px;
        padding: 12px;
      }

      .totals-line{
        display:flex;
        justify-content: space-between;
        gap: 10px;
        font-weight: 900;
        color: var(--af-muted);
        padding: 6px 0;
      }
      .totals-line strong{
        color: var(--af-text);
        font-variant-numeric: tabular-nums;
        white-space: nowrap;
      }
      .totals-line.total strong{ color: var(--af-primary); font-size: 16px; }

      /* Sticky CTA mobile */
      .sticky-checkout{
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 999;
        background: rgba(246,248,251,.92);
        backdrop-filter: blur(10px);
        border-top: 1px solid rgba(229,231,235,.9);
        padding: 10px 12px;
      }
      .sticky-checkout__inner{
        max-width: 980px;
        margin: 0 auto;
        display:flex;
        align-items:center;
        justify-content: space-between;
        gap: 10px;
      }
      .sticky-total{
        display:flex;
        flex-direction:column;
        gap: 2px;
        min-width: 0;
      }
      .sticky-total small{ color: var(--af-muted); font-weight: 900; }
      .sticky-total strong{
        font-weight: 950;
        font-variant-numeric: tabular-nums;
        white-space: nowrap;
        color: var(--af-primary);
      }

      @media (max-width: 640px){
        .carrito-container{ padding: 0 14px 170px; }
        .wrap{ padding: 14px; }

        .desktop-only{ display:none; }
        .mobile-only{ display:block; }

        .btn-row{ display:none; } /* usamos sticky */
      }
    </style>

    <div class="wrap">
      <% if (pedidoId) { %>
        <p class="subhead">
          N√∫mero de pedido: <strong>#<%= pedidoId %></strong>
        </p>
      <% } %>

      <% if (productosList.length > 0) { %>

        <!-- ===== Desktop tabla ===== -->
        <div class="desktop-only">
          <table class="carrito-tabla">
            <thead>
              <tr>
                <th>Imagen</th>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio</th>
                <th>Sub-Total</th>
              </tr>
            </thead>
            <tbody>
              <% productosList.forEach(function(producto) { %>
                <tr>
                  <td>
                    <img
                      src="/uploads/productos/<%= producto.imagen || 'default.jpg' %>"
                      class="imagen-miniatura"
                      alt="<%= producto.nombre %>">
                  </td>
                  <td><%= producto.nombre %></td>
                  <td><%= producto.cantidad %></td>
                  <td class="money">$<%= fmtARS2(producto.precio_venta) %></td>
                  <td class="money">$<%= fmtARS2(producto.total) %></td>
                </tr>
              <% }) %>

              <tr class="carrito-total">
                <td colspan="3"></td>
                <td><strong>Total</strong></td>
                <td class="money">$<%= fmtARS2(totalValue) %></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ===== Mobile cards ===== -->
        <div class="mobile-only">
          <div class="cart-cards">
            <% productosList.forEach(function(producto) { %>
              <article class="cart-card">
                <div class="cart-card__top">
                  <img class="cart-card__img" src="/uploads/productos/<%= producto.imagen || 'default.jpg' %>" alt="<%= producto.nombre %>">
                  <div class="cart-card__info">
                    <div class="cart-card__name"><%= producto.nombre %></div>
                    <div class="cart-card__meta">
                      <span><i class="fas fa-cubes"></i> Cant: <strong><%= producto.cantidad %></strong></span>
                      <span><i class="fas fa-tag"></i> <strong>$<%= fmtARS2(producto.precio_venta) %></strong></span>
                      <span><i class="fas fa-receipt"></i> <strong>$<%= fmtARS2(producto.total) %></strong></span>
                    </div>
                  </div>
                </div>
              </article>
            <% }) %>

            <div class="totals-card">
              <div class="totals-line total">
                <span>Total</span>
                <strong>$<%= fmtARS2(totalValue) %></strong>
              </div>
            </div>

          </div>
        </div>

      <% } else { %>
        <p style="opacity:.75;font-weight:900; text-align:center;">No encontramos productos para mostrar.</p>
      <% } %>

      <% if (estadoCarrito) { %>
        <div class="estado-pedido">
          <h2>üì¶ Estado del pedido</h2>
          <p>
            Estado actual:
            <span class="<%= badgeClass %>"><%= estadoCarrito %></span>
          </p>

          <% if (estadoCarrito === "preparaci√≥n") { %>
            <p>üõí Tu pedido est√° listo para retirar en nuestro local.</p>
          <% } else if (estadoCarrito === "listo para entrega") { %>
            <p>üöö En breve recibir√°s tu pedido en tu domicilio.</p>
          <% } else if (estadoCarrito === "pendiente") { %>
            <p>‚è≥ Estamos procesando tu compra.</p>
          <% } %>
        </div>
      <% } %>

      <!-- Acciones (desktop) -->
      <div class="btn-row">
        <a href="/carrito" class="btn-finalizar btn-ghost">
          üõí Volver al carrito
        </a>

        <button
          id="descargar-comprobante"
          class="btn-finalizar"
          <%= pedidoId ? '' : 'disabled' %>>
          üìÑ Descargar comprobante
        </button>
      </div>

      <hr style="margin:22px 0; opacity:.25;">

      <h2 style="margin:0 0 8px 0; font-size:16px; font-weight:950;">üßæ Tus comprobantes</h2>
      <p style="margin:0 0 12px 0; opacity:.75; font-weight:800;">
        Pod√©s volver cuando quieras y descargar tus comprobantes desde el carrito.
      </p>

      <% if (pedidosList.length > 0) { %>

        <!-- Desktop historial -->
        <div class="desktop-only">
          <table class="carrito-tabla">
            <thead>
              <tr>
                <th>Pedido</th>
                <th>Fecha</th>
                <th>Estado</th>
                <th>Unidades</th>
                <th>Total</th>
                <th>Comprobante</th>
              </tr>
            </thead>
            <tbody>
              <% pedidosList.forEach(function(p) {
                const est2 = (p.estado || '').toLowerCase();
                const badge2 =
                  est2 === 'preparaci√≥n' ? 'badge badge-prep' :
                  est2 === 'listo para entrega' ? 'badge badge-entrega' :
                  est2 === 'finalizado' ? 'badge badge-final' :
                  'badge badge-otro';
              %>
                <tr>
                  <td>#<%= p.id_carrito %></td>
                  <td><%= p.fecha_compra ? new Date(p.fecha_compra).toLocaleDateString('es-AR') : '-' %></td>
                  <td><span class="<%= badge2 %>"><%= p.estado %></span></td>
                  <td><%= fmtARS0(p.unidades || 0) %></td>
                  <td class="money">$<%= fmtARS2(p.total || 0) %></td>
                  <td>
                    <a class="btn-finalizar"
                       style="text-decoration:none; padding:8px 12px; font-size:.9rem;"
                       href="/carrito/comprobante/<%= p.id_carrito %>">
                      üìÑ Descargar
                    </a>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>

        <!-- Mobile historial -->
        <div class="mobile-only">
          <div class="cart-cards">
            <% pedidosList.forEach(function(p) {
              const est2 = (p.estado || '').toLowerCase();
              const badge2 =
                est2 === 'preparaci√≥n' ? 'badge badge-prep' :
                est2 === 'listo para entrega' ? 'badge badge-entrega' :
                est2 === 'finalizado' ? 'badge badge-final' :
                'badge badge-otro';
            %>
              <article class="cart-card">
                <div class="cart-card__name">Pedido #<%= p.id_carrito %></div>
                <div class="cart-card__meta">
                  <span><i class="fas fa-calendar-alt"></i> <strong><%= p.fecha_compra ? new Date(p.fecha_compra).toLocaleDateString('es-AR') : '-' %></strong></span>
                  <span><i class="fas fa-box"></i> <strong><%= fmtARS0(p.unidades || 0) %></strong> u.</span>
                  <span><i class="fas fa-money-bill-wave"></i> <strong>$<%= fmtARS2(p.total || 0) %></strong></span>
                </div>
                <div style="margin-top:10px; display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
                  <span class="<%= badge2 %>"><%= p.estado %></span>
                  <a class="btn-finalizar"
                     style="text-decoration:none; padding:10px 12px; font-size:.95rem;"
                     href="/carrito/comprobante/<%= p.id_carrito %>">
                    üìÑ Comprobante
                  </a>
                </div>
              </article>
            <% }) %>
          </div>
        </div>

      <% } else { %>
        <p style="opacity:.75; margin-top:8px; font-weight:800;">
          No hay historial para mostrar ac√°. (Lo vas a ver siempre en <a href="/carrito">/carrito</a>)
        </p>
      <% } %>

      <script>
        (function () {
          const btn = document.getElementById("descargar-comprobante");
          if (!btn) return;

          const pedidoId = "<%= pedidoId ? pedidoId : '' %>";

          btn.addEventListener("click", async function () {
            try {
              if (!pedidoId) {
                alert("No pudimos identificar el pedido para descargar el comprobante.");
                return;
              }

              const response = await fetch(`/carrito/comprobante/${pedidoId}`);
              if (!response.ok) {
                let msg = "No se pudo descargar el comprobante.";
                try {
                  const d = await response.json();
                  if (d && d.error) msg = d.error;
                } catch (e) {}
                alert(msg);
                return;
              }

              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = `comprobante_autofaros_${pedidoId}.pdf`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              window.URL.revokeObjectURL(url);
            } catch (e) {
              alert("Ocurri√≥ un error al descargar el comprobante.");
            }
          });
        })();
      </script>

    </div>

    <!-- Sticky acciones (mobile) -->
    <div class="sticky-checkout mobile-only">
      <div class="sticky-checkout__inner">
        <div class="sticky-total">
          <small>Total</small>
          <strong>$<%= fmtARS2(totalValue) %></strong>
        </div>

        <div style="display:flex; gap:10px; align-items:center;">
          <a href="/carrito" class="btn-finalizar btn-ghost" style="padding:12px 12px;">
            üõí
          </a>

          <button
            id="descargar-comprobante-sticky"
            class="btn-finalizar"
            <%= pedidoId ? '' : 'disabled' %>
            style="padding:12px 14px;">
            üìÑ
          </button>
        </div>
      </div>
    </div>

    <script>
      // Sticky button -> dispara el bot√≥n real (misma l√≥gica)
      (function () {
        const sticky = document.getElementById('descargar-comprobante-sticky');
        const realBtn = document.getElementById('descargar-comprobante');
        if (!sticky || !realBtn) return;
        sticky.addEventListener('click', () => realBtn.click());
      })();
    </script>

  </main>

  <%- include('./layouts/footer.ejs') %>
</body>
