<%- include ./layouts/head.ejs %>
<%- include ./layouts/header.ejs %>

<style>
/* =====================================================================
   ----------------------------- EDITAR (scoped) ------------------------
   ===================================================================== */
.container-editar{
  padding: 20px;
  background-color: var(--surface);
  border: 2px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}
.container-editar .titulo-editar{
  text-align: center;
  font-size: 24px;
  font-weight: 800;
  margin-bottom: 16px;
  color: var(--primary);
}
.container-editar .card-body-editar{
  padding: 0;
  background-color: var(--surface);
  border: 2px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}
/* Tres columnas (características | proveedores | utilidades) */
.container-editar .contenido-editar{
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 20px;
  width: 100%;
}
.container-editar .caracteristicas,
.container-editar #proveedoresContainer,
.container-editar .utilidades{
  background: var(--surface);
  border: 2px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 16px;
}
/* Inputs/Selects (reutiliza clases del JS) */
.container-editar .form-group-crear{
  margin-bottom: 14px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  align-items: stretch;
}
.container-editar .form-group-crear label{
  display: block;
  color: var(--label);
  font-weight: 700;
  font-size: 13px;
  margin-bottom: 2px;
}
.container-editar .form-group-crear input,
.container-editar .form-group-crear select,
.container-editar .form-group-crear .form-control{
  width: 100%;
  padding: 10px 12px;
  font-size: 13px;
  font-weight: 600;
  background: var(--surface);
  border: 2px solid var(--border-strong);
  border-radius: 10px;
  box-shadow: var(--shadow-inset);
  outline: none;
}
.container-editar .form-group-crear input:focus,
.container-editar .form-group-crear select:focus,
.container-editar .form-group-crear .form-control:focus{
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(0,63,125,0.12), var(--shadow-inset);
}
/* Grilla de proveedores */
.container-editar #proveedoresContainer{
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 16px;
  align-items: start;
}
/* Tarjeta proveedor + “pill” radio */
.container-editar .proveedor{
  position: relative;
  background: var(--surface);
  border: 2px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 18px 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  transition: box-shadow .2s ease, border-color .2s ease, transform .06s ease-in;
  padding-top: 58px; /* espacio para pill del radio */
}
.container-editar .proveedor:hover{
  box-shadow: var(--shadow-hover);
  border-color: var(--border-strong);
}
.container-editar .proveedor > .form-group-crear:first-child{
  position: absolute;
  top: 10px;
  right: 10px;
  margin: 0;
  align-items: flex-end;
}
.container-editar .proveedor > .form-group-crear:first-child label{
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: var(--surface-muted);
  border: 2px solid var(--border);
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 12px;
  color: var(--text);
  box-shadow: var(--shadow);
  user-select: none;
}
.container-editar .proveedor-designado-radio{
  transform: scale(1.15);
  accent-color: var(--primary);
  margin: 0;
}
.container-editar .proveedor:has(.proveedor-designado-radio:checked){
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(0,63,125,0.10), var(--shadow-hover);
}
/* FIX: select Proveedores ancho completo y sin solapar */
.container-editar .proveedor .form-group-crear > label.label-proveedor{
  display: block;
  width: 100%;
  margin: 0 0 6px 0;
  line-height: 1.2;
}
.container-editar .proveedor .form-group-crear > select.proveedores{
  display: block !important;
  width: 100% !important;
  max-width: 100% !important;
  position: static !important;
  float: none !important;
  clear: both !important;
  flex: 0 0 auto !important;
  align-self: stretch !important;
  box-sizing: border-box !important;
}
/* Miniaturas */
.container-editar .imagen-miniatura-contenedor{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
.container-editar .imagen-miniatura-contenedor .imagen-miniatura{ width:80px; height:80px; }
.container-editar .imagen-miniatura{
  object-fit: cover;
  border-radius: 6px;
  box-shadow: var(--shadow);
  border: 2px solid var(--border);
}
.container-editar .preview-img{ position: relative; cursor: pointer; }
.container-editar .preview-img::after{
  content: '✕';
  position: absolute; top: 5px; right: 5px;
  background: rgba(0,0,0,0.55); color:#fff;
  padding: 2px 5px; border-radius: 50%;
  font-size: 12px;
}
/* Botón + proveedor */
.container-editar #addProveedor{
  background-color: #22A35A;
  color: white;
  border: 2px solid #1e8c4d;
  padding: 10px 16px;
  font-size: 14px;
  line-height: 1;
  border-radius: 999px;
  cursor: pointer;
  box-shadow: var(--shadow);
  transition: transform .15s ease, box-shadow .15s ease, background-color .15s ease;
  justify-self: center;
}
.container-editar #addProveedor:hover{
  background-color: #2EDB77;
  color: #0b1729;
  transform: translateY(-1px);
  box-shadow: var(--shadow-hover);
}
/* Botonera */
.container-editar .botones-crear{
  display: flex;
  justify-content: space-between;
  gap: 12px;
  margin-top: 20px;
}
.container-editar .botones-crear .btn{
  padding: 10px 16px;
  font-size: 14px;
  border-radius: 10px;
  font-weight: 800;
  box-shadow: var(--shadow);
  border: 2px solid var(--primary-600);
  background: var(--primary);
  color: #fff;
}
/* Responsive */
@media (max-width: 992px){
  .container-editar .contenido-editar{ grid-template-columns: 1fr; }
}
</style>

<body>
  <main>
    <div class="container-editar">
      <div class="titulo-editar">Editar Producto</div>

      <div class="card-body-editar">
        <form class="contenido-editar" method="POST" action="/productos/actualizar/<%= producto.id %>" enctype="multipart/form-data" data-producto-id="<%= producto.id %>">
          <input type="hidden" name="pagina" value="<%= producto.paginaActual %>">
          <input type="hidden" name="busqueda" value="<%= producto.busqueda || '' %>">
          <input type="hidden" name="id" value="<%= producto.id %>">
          <input type="hidden" name="paginaActual" value="<%= producto.paginaActual %>">
          <input type="hidden" id="iva_producto" name="IVA_producto" value="<%= producto.IVA || 21 %>">

          <!-- Hidden preferencia del proveedor -->
          <input type="hidden" id="proveedor_designado" name="proveedor_designado" value="<%= producto.proveedor_id || '' %>">

          <!-- ============ CARACTERÍSTICAS ============ -->
          <div class="caracteristicas">
            <div class="form-group-crear">
              <label for="imagen">Imagen</label>
              <input id="imagen" class="form-control-file" type="file" name="archivos[]" multiple>

              <div id="preview" class="imagen-miniatura-contenedor">
                <% if (producto && producto.imagenes && producto.imagenes.length > 0) { %>
                  <% producto.imagenes.forEach((imagen) => { %>
                    <div data-imagen-id="<%= imagen.id %>" class="preview-img">
                      <img class="imagen-miniatura" src="<%= imagen.imagen %>" alt="Imagen del producto">
                    </div>
                  <% }); %>
                <% } %>
              </div>
            </div>

            <div class="form-group-crear">
              <label for="nombre">Nombre</label>
              <input id="nombre" class="form-control" type="text" name="nombre" value="<%= producto ? producto.nombre : '' %>" required>
            </div>

            <div class="form-group-crear">
              <label for="descripcion">Descripción</label>
              <textarea id="descripcion" class="form-control" name="descripcion" rows="6"><%= producto ? producto.descripcion : '' %></textarea>

            </div>

            <div class="form-group-crear">
              <label for="oferta">Oferta</label>
              <input type="hidden" name="oferta" value="0">
              <input type="checkbox" id="oferta" name="oferta" value="1" class="form-check-input" <%= producto.oferta ? 'checked' : '' %>>
            </div>

            <div class="form-group-crear">
              <label for="categoria">Categoría</label>
              <select id="categoria" name="categoria" class="form-control">
                <option value="" <%= !producto || !producto.categoria_id ? 'selected' : '' %>>Selecciona una categoría...</option>
                <% categorias.forEach(function(categoria) { %>
                  <option value="<%= categoria.id %>" <%= producto && producto.categoria_id == categoria.id ? 'selected' : '' %>><%= categoria.nombre %></option>
                <% }); %>
              </select>
            </div> 
<%
  const _escCod = Array.isArray(escobillasCodigos) ? escobillasCodigos : [];
  const _escKit = (escobillasKit && typeof escobillasKit === 'object') ? escobillasKit : null;

  // defaults para que no explote la vista
  const _tipoInit = _escKit ? 'kit' : 'unidad';

  // unidad
  const _uniTec = (_escCod[0] && _escCod[0].tecnologia) ? String(_escCod[0].tecnologia) : 'FLEX';
  const _uniCod = (_escCod[0] && _escCod[0].codigo) ? String(_escCod[0].codigo) : '';

  // kit
  const _kitTec = (_escKit && _escKit.tecnologia) ? String(_escKit.tecnologia) : 'FLEX';
  const _kitCon = (_escKit && _escKit.conductor) ? String(_escKit.conductor) : '';
  const _kitAco = (_escKit && _escKit.acompanante) ? String(_escKit.acompanante) : '';

  // IMPORTANT: no mencionar tags EJS dentro de este bloque (rompe el parser)
  const _codJsonInit = JSON.stringify(_escCod || []);
  const _kitJsonInit = JSON.stringify(_escKit || {});
%>



<div id="escobillasSection" class="form-group-crear" style="display:none; margin-top:12px;">
  <div style="padding:12px; border:1px solid #e6e6e6; border-radius:10px;">
    <h4 style="margin:0 0 10px 0;">Datos de Escobillas (TRICO)</h4>

    <!-- Hidden payload que usa el backend -->
    <input type="hidden" id="escobillas_tipo" name="escobillas_tipo" value="<%= _tipoInit %>">
    <input type="hidden" id="escobillas_codigos_json" name="escobillas_codigos_json" value="<%= _codJsonInit %>">
    <input type="hidden" id="escobillas_kit_json" name="escobillas_kit_json" value="<%= _kitJsonInit %>">

    <div class="form-group-crear">
      <label for="esc_formato">Formato:</label>
      <select id="esc_formato" class="form-control" name="esc_formato">
        <option value="unidad" <%= (!_tipoInit || _tipoInit === 'unidad') ? 'selected' : '' %>>Unidad</option>
        <option value="kit" <%= (_tipoInit === 'kit') ? 'selected' : '' %>>Kit (Conductor + Acompañante)</option>
      </select>
    </div>

    <!-- Unidad -->
    <div id="esc_unidad_block">
      <div class="form-group-crear">
        <label for="esc_tecnologia">Tecnología:</label>
        <select id="esc_tecnologia" class="form-control" name="esc_tecnologia">
          <option value="FLEX"  <%= String(_uniTec).toUpperCase()==='FLEX' ? 'selected' : '' %>>FLEX</option>
          <option value="STEEL" <%= String(_uniTec).toUpperCase()==='STEEL' ? 'selected' : '' %>>STEEL</option>
          <option value="REAR"  <%= String(_uniTec).toUpperCase()==='REAR' ? 'selected' : '' %>>REAR (Trasera)</option>
        </select>
      </div>

      <div class="form-group-crear">
        <label for="esc_codigo">Código TRICO:</label>
        <input
          type="text"
          id="esc_codigo"
          class="form-control"
          name="esc_codigo"
          placeholder="Ej: 10707"
          autocomplete="off"
          value="<%= _uniCod %>"
        />
      </div>
    </div>

    <!-- Kit -->
    <div id="esc_kit_block" style="display:none;">
      <div class="form-group-crear">
        <label for="esc_kit_tecnologia">Tecnología del kit:</label>
        <select id="esc_kit_tecnologia" class="form-control" name="esc_kit_tecnologia">
          <option value="FLEX"  <%= String(_kitTec).toUpperCase()==='FLEX' ? 'selected' : '' %>>FLEX</option>
          <option value="STEEL" <%= String(_kitTec).toUpperCase()==='STEEL' ? 'selected' : '' %>>STEEL</option>
        </select>
      </div>

      <div class="form-group-crear">
        <label for="esc_kit_conductor">Código TRICO Conductor:</label>
        <input
          type="text"
          id="esc_kit_conductor"
          class="form-control"
          name="esc_kit_conductor"
          placeholder="Ej: 10707"
          autocomplete="off"
          value="<%= _kitCon %>"
        />
      </div>

      <div class="form-group-crear">
        <label for="esc_kit_acompanante">Código TRICO Acompañante:</label>
        <input
          type="text"
          id="esc_kit_acompanante"
          class="form-control"
          name="esc_kit_acompanante"
          placeholder="Ej: 10708"
          autocomplete="off"
          value="<%= _kitAco %>"
        />
      </div>
    </div>
  </div>
</div>


            <div class="form-group-crear">
              <label for="marca">Marca</label>
              <select id="marca" name="marca" class="form-control">
                <option value="" <%= !producto || !producto.marca_id ? 'selected' : '' %>>Selecciona una marca...</option>
                <% marcas.forEach(function(marca) { %>
                  <option value="<%= marca.id %>" <%= producto && producto.marca_id == marca.id ? 'selected' : '' %>><%= marca.nombre %></option>
                <% }); %>
              </select>
            </div>

            <div class="form-group-crear">
              <label for="modelo_id">Modelo</label>
              <select id="modelo_id" name="modelo_id" class="form-control" data-selected="<%= producto ? producto.modelo_id : '' %>">
                <option value="" <%= !producto || !producto.modelo_id ? 'selected' : '' %>>Selecciona un modelo...</option>
                <% modelos.forEach(function(modelo) { %>
                  <option value="<%= modelo.id %>" <%= producto && producto.modelo_id == modelo.id ? 'selected' : '' %>><%= modelo.nombre %></option>
                <% }); %>
              </select>
            </div>
          </div>

          <!-- ============ PROVEEDORES ============ -->
          <div id="proveedoresContainer">
            <div class="form-group-crear">
              <label for="calidad_original">Calidad FITAM</label>
              <input type="checkbox" id="calidad_original" name="calidad_original" value="1" <%= producto.calidad_original === 1 ? 'checked' : '' %>>
            </div>

            <div class="form-group-crear">
              <label for="calidad_vic">Calidad VIC</label>
              <input type="checkbox" id="calidad_vic" name="calidad_vic" value="1" <%= producto.calidad_vic === 1 ? 'checked' : '' %>>
            </div>

            <div class="form-group-crear">
              <label>Proveedor asignado:</label>
              <div id="proveedorAsignado" class="form-control" readonly></div>
            </div>

            <% if (productoProveedores && productoProveedores.length > 0) { %>
              <% productoProveedores.forEach(function(productoProveedor) { 
                 const _ivaProv = Number(String(productoProveedor.iva ?? producto.IVA ?? 21).replace(',', '.')) || 21;
                 const _pres    = (productoProveedor.presentacion || 'unidad').toLowerCase();
                 const _factor  = _pres === 'juego' ? 0.5 : 1;
                 const _civaSrv = (typeof productoProveedor.costo_iva === 'number'
                                   ? productoProveedor.costo_iva
                                   : parseFloat(productoProveedor.costo_iva || 0));
              %>
                <div class="proveedor" data-proveedor-id="<%= productoProveedor.proveedor_id %>">
                  <!-- Pill radio -->
                  <div class="form-group-crear">
                    <label class="radio-elige-proveedor">
                      <input
                        type="radio"
                        name="proveedor_designado_radio"
                        class="proveedor-designado-radio"
                        value="<%= productoProveedor.proveedor_id %>"
                        <%= (producto.proveedor_id === productoProveedor.proveedor_id) ? 'checked' : '' %> />
                      Usar este proveedor
                    </label>
                  </div>

                  <div class="form-group-crear">
                    <label class="label-proveedor">Proveedor <span class="nombre_proveedor"></span></label>
                    <select class="proveedores form-control" name="proveedores[]">
                      <% proveedores.forEach(function(proveedor) { %>
                        <option value="<%= proveedor.id %>"
                                data-descuento="<%= proveedor.descuento %>"
                                <%= productoProveedor.proveedor_id === proveedor.id ? 'selected' : '' %>>
                          <%= proveedor.nombre %>
                        </option>
                      <% }); %>
                    </select>
                  </div>

                  <div class="form-group-crear">
                    <label class="label-codigo">Código</label>
                    <input class="codigo form-control" type="text" name="codigo[]" value="<%= productoProveedor.codigo %>">
                  </div>

                  <div class="form-group-crear">
                    <label class="label-precio-lista">Precio de Lista</label>
                    <input class="precio_lista form-control" type="number" step="0.01" name="precio_lista[]" value="<%= productoProveedor.precio_lista %>">
                  </div>

                  <div class="form-group-crear">
                    <label class="label-descuento">Descuento</label>
                    <input class="descuentos_proveedor_id form-control" type="text" name="descuentos_proveedor_id[]" value="<%= productoProveedor.descuento %>" readonly>
                  </div>

                  <div class="form-group-crear">
                    <label>Precio de costo (Neto)</label>
                    <input class="costo_neto form-control" type="number" name="costo_neto[]" value="<%= productoProveedor.costo_neto %>" readonly>
                  </div>

                  <div class="form-group-crear">
                    <label>IVA</label>
                    <select class="IVA form-control" name="IVA[]">
                      <option value="21"   <%= _ivaProv === 21 ? 'selected' : '' %>>21%</option>
                      <option value="10.5" <%= _ivaProv === 10.5 ? 'selected' : '' %>>10,5%</option>
                    </select>
                  </div>

                  <!-- NUEVO: Presentación del precio -->
                  <div class="form-group-crear">
                    <label>Presentación del precio</label>
                    <select class="presentacion form-control" name="presentacion[]">
                      <option value="unidad" <%= _pres === 'unidad' ? 'selected' : '' %>>Unidad</option>
                      <option value="juego"  <%= _pres === 'juego'  ? 'selected' : '' %>>Juego (par)</option>
                    </select>
                    <small>Si es "juego", se divide a la mitad (por unidad) para comparar y calcular.</small>
                    <input type="hidden" class="factor_unidad" name="factor_unidad[]" value="<%= _factor %>">
                  </div>

                  <!-- Visible (por UNIDAD) -->
                  <div class="form-group-crear campo-costo-iva">
                    <label>Costo con IVA (por unidad)</label>
                    <input class="costo_iva_vis form-control" type="number" step="0.01" value="">
                  </div>

                  <!-- Hidden normalizado a UNIDAD -->
                  <input class="costo_iva" type="hidden" name="costo_iva[]" value="<%= isFinite(_civaSrv) ? _civaSrv.toFixed(2) : '0.00' %>">

                  <div class="form-group-crear">
                    <button class="eliminar-proveedor btn btn-outline-danger" type="button" data-proveedor-id="<%= productoProveedor.proveedor_id %>">
                      Eliminar proveedor
                    </button>
                  </div>
                </div>
              <% }); %>
            <% } else { %>
              <!-- Plantilla base si no hay proveedores -->
              <% 
                const _ivaProv0 = Number(String(producto.IVA ?? 21).replace(',', '.')) || 21;
                const _pres0    = 'unidad';
                const _factor0  = 1;
                const _civaSrv0 = 0;
              %>
              <div class="proveedor" data-proveedor-id="">
                <div class="form-group-crear">
                  <label class="radio-elige-proveedor">
                    <input type="radio" name="proveedor_designado_radio" class="proveedor-designado-radio" value="">
                    Usar este proveedor
                  </label>
                </div>

                <div class="form-group-crear">
                  <label class="label-proveedor">Proveedor <span class="nombre_proveedor"></span></label>
                  <select class="proveedores form-control" name="proveedores[]">
                    <option value="">Selecciona proveedor...</option>
                    <% proveedores.forEach(function(proveedor) { %>
                      <option value="<%= proveedor.id %>" data-descuento="<%= proveedor.descuento %>"><%= proveedor.nombre %></option>
                    <% }); %>
                  </select>
                </div>

                <div class="form-group-crear">
                  <label class="label-codigo">Código</label>
                  <input class="codigo form-control" type="text" name="codigo[]" value="">
                </div>

                <div class="form-group-crear">
                  <label class="label-precio-lista">Precio de Lista</label>
                  <input class="precio_lista form-control" type="number" step="0.01" name="precio_lista[]" value="">
                </div>

                <div class="form-group-crear">
                  <label class="label-descuento">Descuento</label>
                  <input class="descuentos_proveedor_id form-control" type="text" name="descuentos_proveedor_id[]" value="0" readonly>
                </div>

                <div class="form-group-crear">
                  <label>Precio de costo (Neto)</label>
                  <input class="costo_neto form-control" type="number" name="costo_neto[]" value="0" readonly>
                </div>

                <div class="form-group-crear">
                  <label>IVA</label>
                  <select class="IVA form-control" name="IVA[]">
                    <option value="21"   <%= _ivaProv0 === 21 ? 'selected' : '' %>>21%</option>
                    <option value="10.5" <%= _ivaProv0 === 10.5 ? 'selected' : '' %>>10,5%</option>
                  </select>
                </div>

                <!-- NUEVO: Presentación del precio -->
                <div class="form-group-crear">
                  <label>Presentación del precio</label>
                  <select class="presentacion form-control" name="presentacion[]">
                    <option value="unidad" <%= _pres0 === 'unidad' ? 'selected' : '' %>>Unidad</option>
                    <option value="juego"  <%= _pres0 === 'juego'  ? 'selected' : '' %>>Juego (par)</option>
                  </select>
                  <small>Si es "juego", se divide a la mitad (por unidad) para comparar y calcular.</small>
                  <input type="hidden" class="factor_unidad" name="factor_unidad[]" value="<%= _factor0 %>">
                </div>

                <!-- Visible (por UNIDAD) -->
                <div class="form-group-crear campo-costo-iva">
                  <label>Costo con IVA (por unidad)</label>
                  <input class="costo_iva_vis form-control" type="number" step="0.01" value="" readonly>
                </div>

                <!-- Hidden normalizado a UNIDAD -->
                <input class="costo_iva" type="hidden" name="costo_iva[]" value="<%= _civaSrv0.toFixed(2) %>">

                <div class="form-group-crear">
                  <button class="eliminar-proveedor btn btn-outline-danger" type="button">
                    Eliminar proveedor
                  </button>
                </div>
              </div>
            <% } %>

            <!-- Botón + SIEMPRE fuera del bloque .proveedor -->
            <div class="form-group-crear">
              <button id="addProveedor" type="button" class="btn btn-secondary">+ Agregar proveedor</button>
            </div>
          </div>

          <!-- ============ UTILIDADES / ESTADO / STOCK ============ -->
          <div class="utilidades">
            <div class="form-group-crear">
              <label for="utilidad">Utilidad</label>
              <input id="utilidad" class="form-control" type="number" name="utilidad" value="<%= producto ? producto.utilidad : '' %>">
            </div>

            <div class="form-group-crear">
              <label for="precio_venta">Precio Venta</label>
              <input id="precio_venta" class="form-control" type="number" name="precio_venta" data-manual="false" value="<%= producto ? producto.precio_venta : '' %>">
            </div>

            <div class="form-group-crear">
              <label for="estado">Estado</label>
              <select id="estado" class="form-control" name="estado">
                <option value="" <%= !producto || !producto.estado ? 'selected' : '' %>>Selecciona un estado...</option>
                <option value="activo" <%= producto && producto.estado == 'activo' ? 'selected' : '' %>>Activo</option>
                <option value="inactivo" <%= producto && producto.estado == 'inactivo' ? 'selected' : '' %>>Inactivo</option>
              </select>
            </div>

            <div class="form-group-crear">
              <label for="stock_minimo">Stock Mínimo</label>
              <input type="number" id="stock_minimo" class="form-control" name="stock_minimo" min="0" value="<%= stock.stock_minimo %>" required>
            </div>

            <div class="form-group-crear">
              <label for="stock_actual">Stock Actual</label>
              <input type="number" id="stock_actual" class="form-control" name="stock_actual" min="0" value="<%= stock.stock_actual %>" required>
            </div>

            <div class="botones-crear">
              <button class="btn btn-success" type="submit">Guardar</button>
              <a class="btn btn-primary" href="/productos/panelControl?pagina=<%= producto.paginaActual %>&busqueda=<%= encodeURIComponent(producto.busqueda || '') %>">Cancelar</a>
            </div>
          </div>
        </form>
      </div>
    </div> 
  </main>

  <%- include ./layouts/footer.ejs %>
</body>


  <!-- Libs -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.10.2/Sortable.min.js"></script>

  <!-- JS de edición -->
  <script src="/js/editar.js"></script>
  <script>
(function () {
  // ----- NODOS BASE -----
  var inputImagen   = document.getElementById('imagen');
  var preview       = document.getElementById('preview');
  var form          = (preview && preview.closest('form')) || document.querySelector('form');

  if (!inputImagen || !preview || !form) return;

  // ----- HIDDENs (creados si no existen) -----
  function ensureHidden(id, name, val) {
    var el = document.getElementById(id);
    if (!el) {
      el = document.createElement('input');
      el.type = 'hidden';
      el.id = id;
      el.name = name;
      el.value = val;
      form.appendChild(el);
    }
    return el;
  }
  var portadaTipo         = ensureHidden('portada_tipo', 'portada_tipo', 'existente'); // 'existente' | 'nueva'
  var portadaExistenteId  = ensureHidden('portada_existente_id', 'portada_existente_id', '');
  var portadaNuevaIndex   = ensureHidden('portada_nueva_index', 'portada_nueva_index', '-1');

  var ordenWrap = document.getElementById('orden_existentes_container');
  if (!ordenWrap) {
    ordenWrap = document.createElement('div');
    ordenWrap.id = 'orden_existentes_container';
    ordenWrap.style.display = 'none';
    form.appendChild(ordenWrap);
  }

  var eliminarWrap = document.getElementById('eliminar_imagenes_container');
  if (!eliminarWrap) {
    eliminarWrap = document.createElement('div');
    eliminarWrap.id = 'eliminar_imagenes_container';
    eliminarWrap.style.display = 'none';
    form.appendChild(eliminarWrap);
  }

  // ----- MINI ESTILO LOCAL PARA LA CHAPITA PORTADA (no afecta el grid) -----
  (function injectBadgeStyle(){
    if (document.getElementById('editar-portada-style')) return;
    var css = '.preview-img{position:relative;cursor:pointer}' +
              '.badge-portada{position:absolute;left:6px;top:6px;font-size:10px;font-weight:800;background:var(--primary);color:#fff;padding:3px 6px;border-radius:999px;box-shadow:var(--shadow);display:none}' +
              '.preview-img.is-cover .badge-portada{display:inline-block}';
    var s = document.createElement('style');
    s.id = 'editar-portada-style';
    s.textContent = css;
    document.head.appendChild(s);
  })();

  // ----- MARCAR EXISTENTES (del HTML viejo) -----
  Array.from(preview.querySelectorAll('.preview-img')).forEach(function (node) {
    var id = node.getAttribute('data-imagen-id');
    if (id) {
      node.dataset.type = 'existente';
      node.dataset.id   = String(id);
    }
    // inyectar badge si no existe
    if (!node.querySelector('.badge-portada')) {
      var badge = document.createElement('span');
      badge.className = 'badge-portada';
      badge.textContent = 'PORTADA';
      node.appendChild(badge);
    }
  });

  // ----- DATATRANSFER PARA NUEVAS -----
  var dt = new DataTransfer();
  function syncInput() { inputImagen.files = dt.files; }

  // ----- UTILIDADES -----
  function markCoverNode(node){
    Array.from(preview.children).forEach(function(n){ n.classList.remove('is-cover'); });
    if (node) node.classList.add('is-cover');
  }
  function pushOrdenExistente(id){
    var inp = document.createElement('input');
    inp.type  = 'hidden';
    inp.name  = 'orden_imagenes_existentes[]';
    inp.value = String(id);
    ordenWrap.appendChild(inp);
  }
  function rebuildOrdenExistentesHidden(){
    ordenWrap.innerHTML = '';
    Array.from(preview.children).forEach(function(n){
      if (n.dataset.type === 'existente' && n.dataset.id) pushOrdenExistente(n.dataset.id);
    });
  }
  function pushEliminarExistente(id){
    var inp = document.createElement('input');
    inp.type  = 'hidden';
    inp.name  = 'eliminar_imagenes[]';
    inp.value = String(id);
    eliminarWrap.appendChild(inp);
  }
  function clampIndex(n){
    if (isNaN(n) || n < 0) return 0;
    if (n >= dt.files.length) return dt.files.length - 1;
    return n;
  }

  // ----- PORTADA -----
  function setCover(node){
    if (!node) return;
    markCoverNode(node);
    if (node.dataset.type === 'existente') {
      portadaTipo.value = 'existente';
      portadaExistenteId.value = node.dataset.id || '';
      portadaNuevaIndex.value = '-1';
    } else { // nueva
      portadaTipo.value = 'nueva';
      var idx = clampIndex(parseInt(node.dataset.idx,10));
      if (idx !== 0) {
        var files = Array.from(dt.files);
        var chosen = files[idx];
        files.splice(idx,1);
        files.unshift(chosen);
        var ndt = new DataTransfer();
        files.forEach(function(f){ ndt.items.add(f); });
        dt = ndt;
        syncInput();
        // reasignar índices visibles de nuevas
        var k=0;
        Array.from(preview.children).forEach(function(n){
          if (n.dataset.type === 'nueva') n.dataset.idx = String(k++);
        });
      }
      portadaNuevaIndex.value = '0';
      portadaExistenteId.value = '';
    }
  }

  // ----- NUEVAS: crear thumbs y anexar al final -----
  function appendNewThumbs(){
    // limpio las previas nuevas y las reconstruyo según dt
    Array.from(preview.querySelectorAll('.preview-img[data-type="nueva"]')).forEach(function(n){ n.remove(); });
    Array.from(dt.files).forEach(function(file, idx){
      var wrap = document.createElement('div');
      wrap.className = 'preview-img';
      wrap.dataset.type = 'nueva';
      wrap.dataset.idx  = String(idx);

      var img = document.createElement('img');
      img.className = 'imagen-miniatura';
      var u = URL.createObjectURL(file);
      img.src = u;
      img.alt = file.name;
      img.onload = function(){ try{ URL.revokeObjectURL(u); }catch(e){} };

      var badge = document.createElement('span');
      badge.className = 'badge-portada';
      badge.textContent = 'PORTADA';

      wrap.appendChild(img);
      wrap.appendChild(badge);
      preview.appendChild(wrap);
    });
  }

  // ----- CLICK vs DBLCLICK -----
  var clickTimer = null, SINGLE_DELAY = 220;

  preview.addEventListener('click', function(e){
    var item = e.target.closest('.preview-img');
    if (!item) return;
    if (clickTimer) clearTimeout(clickTimer);
    clickTimer = setTimeout(function(){
      setCover(item); // clic => portada
      clickTimer = null;
    }, SINGLE_DELAY);
  });

  preview.addEventListener('dblclick', function(e){
    var item = e.target.closest('.preview-img');
    if (!item) return;
    if (clickTimer) { clearTimeout(clickTimer); clickTimer = null; }

    if (item.dataset.type === 'existente') {
      var id = item.dataset.id;
      if (id) pushEliminarExistente(id);
      item.remove();
      rebuildOrdenExistentesHidden();
      // si era portada, reasigno a primera visible
      if (!preview.querySelector('.preview-img.is-cover')) {
        var first = preview.querySelector('.preview-img');
        if (first) setCover(first);
      }
      // mantener sortable coherente
      ensureSortable();
    } else {
      // nueva
      var idx = parseInt(item.dataset.idx,10);
      if (!isNaN(idx)) {
        var ndt = new DataTransfer();
        Array.from(dt.files).forEach(function(f,i){ if (i!==idx) ndt.items.add(f); });
        dt = ndt;
        syncInput();
        item.remove();
        // reasignar idx visibles
        var k=0;
        Array.from(preview.children).forEach(function(n){
          if (n.dataset.type === 'nueva') n.dataset.idx = String(k++);
        });
        if (!preview.querySelector('.preview-img.is-cover')) {
          var first2 = preview.querySelector('.preview-img');
          if (first2) setCover(first2);
        }
        ensureSortable();
      }
    }
  });

  // ----- INPUT CHANGE: adjuntar nuevas -----
  inputImagen.addEventListener('change', function(e){
    var files = Array.from(e.target.files || []);
    if (files.length === 0 && dt.files.length === 0) return;
    files.forEach(function(f){ dt.items.add(f); });
    syncInput();
    appendNewThumbs();
    ensureSortable();

    // portada por defecto si no hay
    if (!preview.querySelector('.preview-img.is-cover')) {
      var first = preview.querySelector('.preview-img');
      if (first) setCover(first);
    }
    rebuildOrdenExistentesHidden();
  });

  // ----- SORTABLE -----
  function ensureSortable(){
    if (typeof Sortable === 'undefined' || !Sortable) return;
    if (preview.__sortable) { preview.__sortable.destroy(); preview.__sortable = null; }
    preview.__sortable = new Sortable(preview, {
      animation: 150,
      draggable: '.preview-img',
      onEnd: function(){
        rebuildOrdenExistentesHidden(); // orden de existentes
        // reordenar nuevas en dt según DOM
        var orderNew = [];
        Array.from(preview.children).forEach(function(n){
          if (n.dataset.type === 'nueva') orderNew.push(parseInt(n.dataset.idx,10));
        });
        var ndt = new DataTransfer();
        orderNew.forEach(function(oldIdx){
          if (dt.files[oldIdx]) ndt.items.add(dt.files[oldIdx]);
        });
        dt = ndt;
        // reasignar idx visibles
        var k=0;
        Array.from(preview.children).forEach(function(n){
          if (n.dataset.type === 'nueva') n.dataset.idx = String(k++);
        });
        syncInput();

        // mantener la marca de portada donde corresponda
        var currentCover = (portadaTipo.value === 'existente' && portadaExistenteId.value)
          ? preview.querySelector('.preview-img[data-type="existente"][data-id="'+portadaExistenteId.value+'"]')
          : preview.querySelector('.preview-img[data-type="nueva"][data-idx="'+portadaNuevaIndex.value+'"]');
        if (currentCover) markCoverNode(currentCover);
      }
    });
  }

  // ----- INIT -----
  rebuildOrdenExistentesHidden();
  ensureSortable();
  // portada visual por defecto si existe algo
  (function initCover(){
    var first = preview.querySelector('.preview-img');
    if (first) setCover(first);
  })();

})();
</script>

  <script>
    // Si al entrar la marca ya está seleccionada, refrescamos modelos por marca
    (function initModeloSeleccionado() {
      var marcaEl = document.getElementById('marca');
      var modeloEl = document.getElementById('modelo_id');
      var marcaSel = marcaEl ? marcaEl.value : '';
      var modeloSel = modeloEl ? modeloEl.getAttribute('data-selected') : '';
      if (!marcaSel || !modeloSel) return;

      $.get('/productos/modelos/' + marcaSel, function (modelosPorMarca) {
        var $modelo = $('#modelo_id');
        $modelo.empty().append('<option value="">Selecciona un modelo...</option>');
        (modelosPorMarca || []).forEach(function (m) {
          var selected = (String(m.id) === String(modeloSel)) ? 'selected' : '';
          $modelo.append('<option value="' + m.id + '" ' + selected + '>' + m.nombre + '</option>');
        });
      });
    })();
</script>

<!-- ✅ FIX ENTER EN DESCRIPCIÓN -->
<script>
  (function () {
    var ta = document.getElementById('descripcion');
    if (!ta) return;

    ta.addEventListener('keydown', function (e) {
      if (e.key !== 'Enter') return;

      // Forzamos salto de línea aunque algún script global bloquee Enter
      e.preventDefault();
      e.stopImmediatePropagation();

      var start = ta.selectionStart;
      var end = ta.selectionEnd;

      if (typeof start !== 'number' || typeof end !== 'number') {
        ta.value += "\n";
        return;
      }

      ta.value = ta.value.slice(0, start) + "\n" + ta.value.slice(end);
      ta.selectionStart = ta.selectionEnd = start + 1;

      ta.dispatchEvent(new Event('input', { bubbles: true }));
    }, true);
  })();
</script>

</body>

