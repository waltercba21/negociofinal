<%- include ./layouts/head.ejs %>
<%- include ./layouts/header.ejs %>

<body>
  <main>
    <div class="container-crear">
      <div class="titulo-crear">Editar Producto</div>

      <div class="contenido-crear">
        <div class="card-body">
          <form class="form-crear" method="POST" action="/productos/actualizar/<%= producto.id %>" enctype="multipart/form-data">
            <input type="hidden" name="pagina" value="<%= producto.paginaActual %>">
            <input type="hidden" name="busqueda" value="<%= producto.busqueda || '' %>">
            <input type="hidden" name="id" value="<%= producto.id %>">
            <input type="hidden" name="paginaActual" value="<%= producto.paginaActual %>">
            <!-- Hidden donde guardamos SIEMPRE el proveedor_id elegido -->
            <input type="hidden" id="proveedor_designado" name="proveedor_designado" value="<%= producto.proveedor_id || '' %>">

            <!-- ============ CARACTERÍSTICAS ============ -->
            <div class="caracteristicas">
              <!-- Imágenes -->
              <div class="form-group-crear">
                <label for="imagen">Imagen</label>
                <input id="imagen" class="form-control-file" type="file" name="archivos[]" multiple>

                <div id="preview" class="imagen-miniatura-contenedor">
                  <% if (producto && producto.imagenes && producto.imagenes.length > 0) { %>
                    <% producto.imagenes.forEach((imagen) => { %>
                      <div data-imagen-id="<%= imagen.id %>" class="preview-img">
                        <img class="imagen-miniatura" src="<%= imagen.imagen %>" alt="Imagen del producto">
                      </div>
                    <% }); %>
                  <% } %>
                </div>
              </div>

              <div class="form-group-crear">
                <label for="nombre">Nombre</label>
                <input id="nombre" class="form-control" type="text" name="nombre" value="<%= producto ? producto.nombre : '' %>" required>
              </div>

              <div class="form-group-crear">
                <label for="descripcion">Descripción</label>
                <input id="descripcion" class="form-control" type="text" name="descripcion" value="<%= producto ? producto.descripcion : '' %>">
              </div>

              <div class="form-group-crear">
                <label for="oferta">Oferta</label>
                <input type="hidden" name="oferta" value="0">
                <input type="checkbox" id="oferta" name="oferta" value="1" class="form-check-input" <%= producto.oferta ? 'checked' : '' %>>
              </div>

              <div class="form-group-crear">
                <label for="categoria">Categoría</label>
                <select id="categoria" name="categoria" class="form-control">
                  <option value="" <%= !producto || !producto.categoria_id ? 'selected' : '' %>>Selecciona una categoría...</option>
                  <% categorias.forEach(function(categoria) { %>
                    <option value="<%= categoria.id %>" <%= producto && producto.categoria_id == categoria.id ? 'selected' : '' %>><%= categoria.nombre %></option>
                  <% }); %>
                </select>
              </div>

              <div class="form-group-crear">
                <label for="marca">Marca</label>
                <select id="marca" name="marca" class="form-control">
                  <option value="" <%= !producto || !producto.marca_id ? 'selected' : '' %>>Selecciona una marca...</option>
                  <% marcas.forEach(function(marca) { %>
                    <option value="<%= marca.id %>" <%= producto && producto.marca_id == marca.id ? 'selected' : '' %>><%= marca.nombre %></option>
                  <% }); %>
                </select>
              </div>

              <div class="form-group-crear">
                <label for="modelo_id">Modelo</label>
                <select id="modelo_id" name="modelo_id" class="form-control" data-selected="<%= producto ? producto.modelo_id : '' %>">
                  <option value="" <%= !producto || !producto.modelo_id ? 'selected' : '' %>>Selecciona un modelo...</option>
                  <% modelos.forEach(function(modelo) { %>
                    <option value="<%= modelo.id %>" <%= producto && producto.modelo_id == modelo.id ? 'selected' : '' %>><%= modelo.nombre %></option>
                  <% }); %>
                </select>
              </div>
            </div>

            <!-- ============ PROVEEDORES ============ -->
            <div id="proveedoresContainer">
              <div class="form-group-crear">
                <label for="calidad_original">Calidad FITAM</label>
                <input type="checkbox" id="calidad_original" name="calidad_original" value="1" <%= producto.calidad_original === 1 ? 'checked' : '' %>>
              </div>

              <div class="form-group-crear">
                <label for="calidad_vic">Calidad VIC</label>
                <input type="checkbox" id="calidad_vic" name="calidad_vic" value="1" <%= producto.calidad_vic === 1 ? 'checked' : '' %>>
              </div>

              <!-- Indicador del proveedor asignado -->
              <div class="form-group-crear">
                <label>Proveedor asignado:</label>
                <div id="proveedorAsignado" class="texto-resaltado"></div>
              </div>

              <% if (productoProveedores && productoProveedores.length > 0) { %>
                <% productoProveedores.forEach(function(productoProveedor) { %>
                  <div class="proveedor">
                    <div class="form-group-crear">
                      <label>
                        <input type="radio"
                               name="proveedor_designado_radio"
                               class="proveedor-designado-radio"
                               value="<%= productoProveedor.proveedor_id %>"
                               <%= (producto.proveedor_id && producto.proveedor_id === productoProveedor.proveedor_id) ? 'checked' : '' %> >
                        Usar este proveedor
                      </label>
                    </div>

                    <div class="form-group-crear">
                      <label class="label-proveedor">Proveedor <span class="nombre_proveedor"></span></label>
                      <select class="proveedores form-control" name="proveedores[]">
                        <% proveedores.forEach(function(proveedor) { %>
                          <option value="<%= proveedor.id %>"
                                  data-descuento="<%= proveedor.descuento %>"
                                  <%= productoProveedor.proveedor_id === proveedor.id ? 'selected' : '' %>>
                            <%= proveedor.nombre %>
                          </option>
                        <% }); %>
                      </select>
                    </div>

                    <div class="form-group-crear">
                      <label class="label-codigo">Código</label>
                      <input class="codigo form-control" type="text" name="codigo[]" value="<%= productoProveedor.codigo %>">
                    </div>

                    <div class="form-group-crear">
                      <label class="label-precio-lista">Precio de Lista</label>
                      <input class="precio_lista form-control" type="number" step="0.01" name="precio_lista[]" value="<%= productoProveedor.precio_lista %>">
                    </div>

                    <div class="form-group-crear">
                      <label class="label-descuento">Descuento</label>
                      <input class="descuentos_proveedor_id form-control" type="text" name="descuentos_proveedor_id[]" value="<%= productoProveedor.descuento %>" readonly>
                    </div>

                    <div class="form-group-crear">
                      <label>Precio de costo (Neto)</label>
                      <input class="costo_neto form-control" type="number" name="costo_neto[]" value="<%= productoProveedor.costo_neto %>" readonly>
                    </div>

                    <div class="form-group-crear">
                      <label>IVA</label>
                      <input class="IVA form-control" type="number" name="IVA[]" value="21" readonly>
                    </div>

                    <div class="form-group-crear">
                      <label>Precio de costo con IVA</label>
                      <input class="costo_iva form-control" type="number" name="costo_iva[]" step="0.01"
                             value="<%= (typeof productoProveedor.costo_iva === 'number'
                                      ? productoProveedor.costo_iva
                                      : parseFloat(productoProveedor.costo_iva || 0)).toFixed(2) %>">
                    </div>

                    <div class="form-group-crear">
                      <button class="eliminar-proveedor btn btn-outline-danger" type="button" data-proveedor-id="<%= productoProveedor.proveedor_id %>">
                        Eliminar proveedor
                      </button>
                    </div>
                  </div>
                <% }); %>
              <% } else { %>
                <!-- Si no hay proveedores, renderizamos un bloque base para clonar (con radio incluido) -->
                <div class="proveedor">
                  <div class="form-group-crear">
                    <label>
                      <input type="radio"
                             name="proveedor_designado_radio"
                             class="proveedor-designado-radio"
                             value="">
                      Usar este proveedor
                    </label>
                  </div>

                  <div class="form-group-crear">
                    <label class="label-proveedor">Proveedor <span class="nombre_proveedor"></span></label>
                    <select class="proveedores form-control" name="proveedores[]">
                      <option value="">Selecciona proveedor...</option>
                      <% proveedores.forEach(function(proveedor) { %>
                        <option value="<%= proveedor.id %>" data-descuento="<%= proveedor.descuento %>">
                          <%= proveedor.nombre %>
                        </option>
                      <% }); %>
                    </select>
                  </div>

                  <div class="form-group-crear">
                    <label class="label-codigo">Código</label>
                    <input class="codigo form-control" type="text" name="codigo[]" value="">
                  </div>

                  <div class="form-group-crear">
                    <label class="label-precio-lista">Precio de Lista</label>
                    <input class="precio_lista form-control" type="number" step="0.01" name="precio_lista[]" value="">
                  </div>

                  <div class="form-group-crear">
                    <label class="label-descuento">Descuento</label>
                    <input class="descuentos_proveedor_id form-control" type="text" name="descuentos_proveedor_id[]" value="0" readonly>
                  </div>

                  <div class="form-group-crear">
                    <label>Precio de costo (Neto)</label>
                    <input type="number" class="costo_neto form-control" name="costo_neto[]" value="0" readonly>
                  </div>

                  <div class="form-group-crear">
                    <label>IVA</label>
                    <input type="number" class="IVA form-control" name="IVA[]" value="21" readonly>
                  </div>

                  <div class="form-group-crear">
                    <label>Precio de costo con IVA</label>
                    <input type="number" class="costo_iva form-control" name="costo_iva[]" value="0" step="0.01">
                  </div>
                </div>
              <% } %>

              <!-- Botón + SIEMPRE fuera del bloque .proveedor -->
              <div class="form-group-crear">
                <button id="addProveedor" type="button" class="btn btn-secondary">+ Agregar proveedor</button>
              </div>
            </div>

            <!-- ============ UTILIDADES / ESTADO / STOCK ============ -->
            <div class="utilidades">
              <div class="form-group-crear">
                <label for="utilidad">Utilidad</label>
                <input id="utilidad" class="form-control" type="number" name="utilidad" value="<%= producto ? producto.utilidad : '' %>">
              </div>

              <div class="form-group-crear">
                <label for="precio_venta">Precio Venta</label>
                <input id="precio_venta" class="form-control" type="number" name="precio_venta" data-manual="false" value="<%= producto ? producto.precio_venta : '' %>">
              </div>

              <div class="form-group-crear">
                <label for="estado">Estado</label>
                <select id="estado" class="form-control" name="estado">
                  <option value="" <%= !producto || !producto.estado ? 'selected' : '' %>>Selecciona un estado...</option>
                  <option value="activo" <%= producto && producto.estado == 'activo' ? 'selected' : '' %>>Activo</option>
                  <option value="inactivo" <%= producto && producto.estado == 'inactivo' ? 'selected' : '' %>>Inactivo</option>
                </select>
              </div>

              <div class="form-group-crear">
                <label for="stock_minimo">Stock Mínimo</label>
                <input type="number" id="stock_minimo" class="form-control" name="stock_minimo" min="0" value="<%= stock.stock_minimo %>" required>
              </div>

              <div class="form-group-crear">
                <label for="stock_actual">Stock Actual</label>
                <input type="number" id="stock_actual" class="form-control" name="stock_actual" min="0" value="<%= stock.stock_actual %>" required>
              </div>

              <div class="botones-crear">
                <button class="btn btn-success" type="submit">Guardar</button>
                <a class="btn btn-primary" href="/productos/panelControl?pagina=<%= producto.paginaActual %>&busqueda=<%= encodeURIComponent(producto.busqueda || '') %>">Cancelar</a>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div> 
  </main>

  <%- include ./layouts/footer.ejs %>

  <!-- Libs -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.10.2/Sortable.min.js"></script>

  <!-- JS de edición -->
  <script src="/js/editar.js"></script>

  <script>
    // Logs útiles
    console.log("📝 DEBUG - input[name='pagina']:", document.querySelector('input[name="pagina"]')?.value);
    console.log("📝 DEBUG - input[name='busqueda']:", document.querySelector('input[name="busqueda"]')?.value);

    // Si al entrar la marca ya está seleccionada, refrescamos modelos por marca
    (function initModeloSeleccionado() {
      var marcaSel = document.getElementById('marca')?.value;
      var modeloSel = document.getElementById('modelo_id')?.getAttribute('data-selected');
      if (!marcaSel || !modeloSel) return;
      $.get('/productos/modelos/' + marcaSel, function (modelosPorMarca) {
        var $modelo = $('#modelo_id');
        $modelo.empty().append('<option value="">Selecciona un modelo...</option>');
        (modelosPorMarca || []).forEach(function (m) {
          var selected = (String(m.id) === String(modeloSel)) ? 'selected' : '';
          $modelo.append('<option value="' + m.id + '" ' + selected + '>' + m.nombre + '</option>');
        });
      });
    })();
  </script>
</body>
