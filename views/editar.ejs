<%- include ./layouts/head.ejs %>
<%- include ./layouts/header.ejs %>

<style>
/* =====================================================================
   ----------------------------- EDITAR (scoped) ------------------------
   ===================================================================== */
.container-editar{
  padding: 20px;
  background-color: var(--surface);
  border: 2px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}
.container-editar .titulo-editar{
  text-align: center;
  font-size: 24px;
  font-weight: 800;
  margin-bottom: 16px;
  color: var(--primary);
}
.container-editar .card-body-editar{
  padding: 0;
  background-color: var(--surface);
  border: 2px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}

/* ========= üîß GRID 3 columnas ‚Äúa prueba de corrimientos‚Äù ========= */
.container-editar .contenido-editar{
  display: grid;
  /* Evita huecos: tracks fijos que se adaptan y no permiten overflow */
  grid-template-columns: minmax(0, 2fr) minmax(0, 2fr) minmax(0, 1.2fr);
  gap: 20px;
  width: 100%;
  /* Asegura que los √≠tems ocupen de IZQ‚ÜíDER sin centrados raros */
  justify-content: stretch;
  align-items: start;
  justify-items: stretch;
}

/* Los 3 contenedores principales NUNCA deben desbordar su columna */
.container-editar .caracteristicas,
.container-editar #proveedoresContainer,
.container-editar .utilidades{
  min-width: 0;                 /* <- clave para evitar desbordes en grid */
  background: var(--surface);
  border: 2px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 16px;
  box-sizing: border-box;       /* que el padding/borde no ‚Äúensanche‚Äù */
  margin: 0;                    /* sin m√°rgenes que rompan el track */
}

/* Inputs/Selects (reutiliza clases del JS) */
.container-editar .form-group-crear{
  margin-bottom: 14px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  align-items: stretch;
  min-width: 0;                 /* <- evita forzar ancho por textos largos */
}
.container-editar .form-group-crear label{
  display: block;
  color: var(--label);
  font-weight: 700;
  font-size: 13px;
  margin-bottom: 2px;
}
.container-editar .form-group-crear input,
.container-editar .form-group-crear select,
.container-editar .form-group-crear .form-control{
  width: 100%;
  padding: 10px 12px;
  font-size: 13px;
  font-weight: 600;
  background: var(--surface);
  border: 2px solid var(--border-strong);
  border-radius: 10px;
  box-shadow: var(--shadow-inset);
  outline: none;
  min-width: 0;                 /* <- inputs no expanden el track */
}
.container-editar .form-group-crear input:focus,
.container-editar .form-group-crear select:focus,
.container-editar .form-group-crear .form-control:focus{
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(0,63,125,0.12), var(--shadow-inset);
}

/* ========= üîß GRID de proveedores ‚Äúfluido y sin huecos‚Äù ========= */
.container-editar #proveedoresContainer{
  display: grid;
  /* auto-fit + minmax asegura columnas completas sin espacios a la izquierda */
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
  align-items: start;
  justify-items: stretch;
  width: 100%;
  min-width: 0;
}

/* Tarjeta proveedor + ‚Äúpill‚Äù radio */
.container-editar .proveedor{
  position: relative;
  background: var(--surface);
  border: 2px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 18px 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  transition: box-shadow .2s ease, border-color .2s ease, transform .06s ease-in;
  padding-top: 58px; /* espacio para pill del radio */
  min-width: 0;
}
.container-editar .proveedor:hover{
  box-shadow: var(--shadow-hover);
  border-color: var(--border-strong);
}
.container-editar .proveedor > .form-group-crear:first-child{
  position: absolute;
  top: 10px;
  right: 10px;
  margin: 0;
  align-items: flex-end;
}
.container-editar .proveedor > .form-group-crear:first-child label{
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: var(--surface-muted);
  border: 2px solid var(--border);
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 12px;
  color: var(--text);
  box-shadow: var(--shadow);
  user-select: none;
}
.container-editar .proveedor-designado-radio{
  transform: scale(1.15);
  accent-color: var(--primary);
  margin: 0;
}
.container-editar .proveedor:has(.proveedor-designado-radio:checked){
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(0,63,125,0.10), var(--shadow-hover);
}

/* FIX: select Proveedores ancho completo y sin solapar */
.container-editar .proveedor .form-group-crear > label.label-proveedor{
  display: block;
  width: 100%;
  margin: 0 0 6px 0;
  line-height: 1.2;
}
.container-editar .proveedor .form-group-crear > select.proveedores{
  display: block !important;
  width: 100% !important;
  max-width: 100% !important;
  position: static !important;
  float: none !important;
  clear: both !important;
  flex: 0 0 auto !important;
  align-self: stretch !important;
  box-sizing: border-box !important;
}

/* Miniaturas (EDITAR) */
.container-editar .imagen-miniatura-contenedor{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
.thumb{ position:relative; width:90px; height:90px; border:2px solid var(--border); border-radius:8px; overflow:hidden; box-shadow:var(--shadow); cursor:grab; background:#111 }
.thumb:active{ cursor:grabbing }
.thumb img{ width:100%; height:100%; object-fit:cover; display:block }
.badge-portada{ position:absolute; left:6px; top:6px; font-size:10px; font-weight:800; background:var(--primary); color:#fff; padding:3px 6px; border-radius:999px; box-shadow:var(--shadow); display:none }
.thumb.is-cover .badge-portada{ display:inline-block }

/* Bot√≥n + proveedor */
.container-editar #addProveedor{
  background-color: #22A35A;
  color: white;
  border: 2px solid #1e8c4d;
  padding: 10px 16px;
  font-size: 14px;
  line-height: 1;
  border-radius: 999px;
  cursor: pointer;
  box-shadow: var(--shadow);
  transition: transform .15s ease, box-shadow .15s ease, background-color .15s ease;
  justify-self: center;
}
.container-editar #addProveedor:hover{
  background-color: #2EDB77;
  color: #0b1729;
  transform: translateY(-1px);
  box-shadow: var(--shadow-hover);
}

/* Botonera */
.container-editar .botones-crear{
  display: flex;
  justify-content: space-between;
  gap: 12px;
  margin-top: 20px;
}
.container-editar .botones-crear .btn{
  padding: 10px 16px;
  font-size: 14px;
  border-radius: 10px;
  font-weight: 800;
  box-shadow: var(--shadow);
  border: 2px solid var(--primary-600);
  background: var(--primary);
  color: #fff;
}

/* Responsive */
@media (max-width: 992px){
  .container-editar .contenido-editar{ grid-template-columns: 1fr; }
}
/* ====== OVERRIDE LAYOUT ESTABLE (pegar al final del <style>) ====== */

/* 1) Centrar el wrapper y evitar desbordes horizontales accidentales */
.container-editar,
.container-editar .card-body-editar,
.container-editar .contenido-editar {
  width: 100%;
  box-sizing: border-box;
}
.container-editar {
  max-width: 1440px;        /* ajustable a tu gusto */
  margin-left: auto;
  margin-right: auto;
}

/* 2) Grid principal: 3 columnas blindadas, sin corrimiento a la derecha */
.container-editar .contenido-editar{
  grid-template-columns: minmax(340px, 1fr) minmax(340px, 1fr) minmax(320px, 1fr);
  gap: 20px;
  align-items: start;
  justify-items: stretch;
  justify-content: stretch;
  overflow: hidden; /* por si alg√∫n hijo intenta desbordar */
}

/* 3) Nada puede forzar el ancho del track */
.container-editar .caracteristicas,
.container-editar #proveedoresContainer,
.container-editar .utilidades,
.container-editar .form-group-crear,
.container-editar .form-group-crear > *,
.container-editar .proveedor,
.container-editar .proveedor * {
  min-width: 0 !important;
  box-sizing: border-box;
}

/* 4) Proveedores: columnas fluidas sin huecos ni salto hacia la derecha */
.container-editar #proveedoresContainer{
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* rellena de izq‚Üíder */
  gap: 16px;
  justify-content: stretch;
  justify-items: stretch;
  width: 100%;
  min-width: 0;
}

/* 5) Inputs / selects nunca expanden el track */
.container-editar .form-group-crear input,
.container-editar .form-group-crear select,
.container-editar .form-group-crear .form-control {
  min-width: 0 !important;
  max-width: 100%;
}

/* 6) Breakpoints s√≥lidos (evitan el ‚Äúempuj√≥n‚Äù visual) */
@media (max-width: 1280px){
  .container-editar .contenido-editar{
    grid-template-columns: minmax(360px, 1fr) minmax(360px, 1fr); /* 2 cols */
  }
}
@media (max-width: 900px){
  .container-editar .contenido-editar{
    grid-template-columns: 1fr; /* 1 col stack */
  }
}

/* 7) (Opcional) Si ves scroll-x m√≠nimo que mueve todo:
html, body { overflow-x: hidden; }
*/

</style>


<body>
  <main>
    <div class="container-editar">
      <div class="titulo-editar">Editar Producto</div>

      <div class="card-body-editar">
        <form class="contenido-editar" method="POST" action="/productos/actualizar/<%= producto.id %>" enctype="multipart/form-data" data-producto-id="<%= producto.id %>">
          <input type="hidden" name="pagina" value="<%= producto.paginaActual %>">
          <input type="hidden" name="busqueda" value="<%= producto.busqueda || '' %>">
          <input type="hidden" name="id" value="<%= producto.id %>">
          <input type="hidden" name="paginaActual" value="<%= producto.paginaActual %>">
          <input type="hidden" id="iva_producto" name="IVA_producto" value="<%= producto.IVA || 21 %>">

          <!-- Hidden preferencia del proveedor -->
          <input type="hidden" id="proveedor_designado" name="proveedor_designado" value="<%= producto.proveedor_id || '' %>">

          <!-- üîí HIDDEN para im√°genes (EDITAR) -->
          <input type="hidden" id="portada_tipo" name="portada_tipo" value="existente"><!-- existente | nueva -->
          <input type="hidden" id="portada_existente_id" name="portada_existente_id" value="<%= (producto && producto.portada_id) ? producto.portada_id : '' %>">
          <input type="hidden" id="portada_nueva_index" name="portada_nueva_index" value="-1">
          <div id="orden_existentes_container"></div> <!-- se rellenar√° con orden_imagenes_existentes[] -->
          <div id="eliminar_imagenes_container"></div> <!-- se agregan eliminar_imagenes[] -->

          <!-- ============ CARACTER√çSTICAS ============ -->
          <div class="caracteristicas">
            <div class="form-group-crear">
              <label for="imagen">Im√°genes</label>
              <input id="imagen" class="form-control-file" type="file" name="archivos[]" multiple>
              <div class="hint">‚Ä¢ Clic: marcar portada ‚Ä¢ Doble-clic: eliminar ‚Ä¢ Arrastrar: reordenar</div>

              <div id="preview" class="imagen-miniatura-contenedor">
                <% if (producto && producto.imagenes && producto.imagenes.length > 0) { %>
                  <% producto.imagenes.forEach((imagen) => { %>
                    <div class="thumb" data-type="existente" data-id="<%= imagen.id %>">
                      <img src="<%= imagen.imagen %>" alt="Imagen del producto">
                      <span class="badge-portada">PORTADA</span>
                    </div>
                  <% }); %>
                <% } %>
              </div>
            </div>

            <div class="form-group-crear">
              <label for="nombre">Nombre</label>
              <input id="nombre" class="form-control" type="text" name="nombre" value="<%= producto ? producto.nombre : '' %>" required>
            </div>

            <div class="form-group-crear">
              <label for="descripcion">Descripci√≥n</label>
              <input id="descripcion" class="form-control" type="text" name="descripcion" value="<%= producto ? producto.descripcion : '' %>">
            </div>

            <div class="form-group-crear">
              <label for="oferta">Oferta</label>
              <input type="hidden" name="oferta" value="0">
              <input type="checkbox" id="oferta" name="oferta" value="1" class="form-check-input" <%= producto.oferta ? 'checked' : '' %>>
            </div>

            <div class="form-group-crear">
              <label for="categoria">Categor√≠a</label>
              <select id="categoria" name="categoria" class="form-control">
                <option value="" <%= !producto || !producto.categoria_id ? 'selected' : '' %>>Selecciona una categor√≠a...</option>
                <% categorias.forEach(function(categoria) { %>
                  <option value="<%= categoria.id %>" <%= producto && producto.categoria_id == categoria.id ? 'selected' : '' %>><%= categoria.nombre %></option>
                <% }); %>
              </select>
            </div>

            <div class="form-group-crear">
              <label for="marca">Marca</label>
              <select id="marca" name="marca" class="form-control">
                <option value="" <%= !producto || !producto.marca_id ? 'selected' : '' %>>Selecciona una marca...</option>
                <% marcas.forEach(function(marca) { %>
                  <option value="<%= marca.id %>" <%= producto && producto.marca_id == marca.id ? 'selected' : '' %>><%= marca.nombre %></option>
                <% }); %>
              </select>
            </div>

            <div class="form-group-crear">
              <label for="modelo_id">Modelo</label>
              <select id="modelo_id" name="modelo_id" class="form-control" data-selected="<%= producto ? producto.modelo_id : '' %>">
                <option value="" <%= !producto || !producto.modelo_id ? 'selected' : '' %>>Selecciona un modelo...</option>
                <% modelos.forEach(function(modelo) { %>
                  <option value="<%= modelo.id %>" <%= producto && producto.modelo_id == modelo.id ? 'selected' : '' %>><%= modelo.nombre %></option>
                <% }); %>
              </select>
            </div>
          </div>

          <!-- ============ PROVEEDORES ============ -->
          <div id="proveedoresContainer">
            <div class="form-group-crear">
              <label for="calidad_original">Calidad FITAM</label>
              <input type="checkbox" id="calidad_original" name="calidad_original" value="1" <%= producto.calidad_original === 1 ? 'checked' : '' %>>
            </div>

            <div class="form-group-crear">
              <label for="calidad_vic">Calidad VIC</label>
              <input type="checkbox" id="calidad_vic" name="calidad_vic" value="1" <%= producto.calidad_vic === 1 ? 'checked' : '' %>>
            </div>

            <div class="form-group-crear">
              <label>Proveedor asignado:</label>
              <div id="proveedorAsignado" class="form-control" readonly></div>
            </div>

            <% if (productoProveedores && productoProveedores.length > 0) { %>
              <% productoProveedores.forEach(function(productoProveedor) { %>
                <div class="proveedor" data-proveedor-id="<%= productoProveedor.proveedor_id %>">
                  <!-- Pill radio -->
                  <div class="form-group-crear">
                    <label class="radio-elige-proveedor">
                      <input
                        type="radio"
                        name="proveedor_designado_radio"
                        class="proveedor-designado-radio"
                        value="<%= productoProveedor.proveedor_id %>"
                        <%= (producto.proveedor_id === productoProveedor.proveedor_id) ? 'checked' : '' %> />
                      Usar este proveedor
                    </label>
                  </div>

                  <div class="form-group-crear">
                    <label class="label-proveedor">Proveedor <span class="nombre_proveedor"></span></label>
                    <select class="proveedores form-control" name="proveedores[]">
                      <% proveedores.forEach(function(proveedor) { %>
                        <option value="<%= proveedor.id %>"
                                data-descuento="<%= proveedor.descuento %>"
                                <%= productoProveedor.proveedor_id === proveedor.id ? 'selected' : '' %>>
                          <%= proveedor.nombre %>
                        </option>
                      <% }); %>
                    </select>
                  </div>

                  <div class="form-group-crear">
                    <label class="label-codigo">C√≥digo</label>
                    <input class="codigo form-control" type="text" name="codigo[]" value="<%= productoProveedor.codigo %>">
                  </div>

                  <div class="form-group-crear">
                    <label class="label-precio-lista">Precio de Lista</label>
                    <input class="precio_lista form-control" type="number" step="0.01" name="precio_lista[]" value="<%= productoProveedor.precio_lista %>">
                  </div>

                  <div class="form-group-crear">
                    <label class="label-descuento">Descuento</label>
                    <input class="descuentos_proveedor_id form-control" type="text" name="descuentos_proveedor_id[]" value="<%= productoProveedor.descuento %>" readonly>
                  </div>

                  <div class="form-group-crear">
                    <label>Precio de costo (Neto)</label>
                    <input class="costo_neto form-control" type="number" name="costo_neto[]" value="<%= productoProveedor.costo_neto %>" readonly>
                  </div>

                 <% const _ivaProv = Number(String(productoProveedor.iva ?? producto.IVA ?? 21).replace(',', '.')) || 21; %>

                  <div class="form-group-crear">
                    <label>IVA</label>
                    <select class="IVA form-control" name="IVA[]">
                      <option value="21"   <%= _ivaProv === 21 ? 'selected' : '' %>>21%</option>
                      <option value="10.5" <%= _ivaProv === 10.5 ? 'selected' : '' %>>10,5%</option>
                    </select>
                  </div>

                  <div class="form-group-crear">
                    <label>Precio de costo con IVA</label>
                    <input class="costo_iva form-control" type="number" name="costo_iva[]" step="0.01"
                           value="<%= (typeof productoProveedor.costo_iva === 'number'
                                    ? productoProveedor.costo_iva
                                    : parseFloat(productoProveedor.costo_iva || 0)).toFixed(2) %>">
                  </div>

                  <div class="form-group-crear">
                    <button class="eliminar-proveedor btn btn-outline-danger" type="button" data-proveedor-id="<%= productoProveedor.proveedor_id %>">
                      Eliminar proveedor
                    </button>
                  </div>
                </div>
              <% }); %>
            <% } else { %>
              <!-- Plantilla base si no hay proveedores -->
              <div class="proveedor" data-proveedor-id="">
                <div class="form-group-crear">
                  <label class="radio-elige-proveedor">
                    <input type="radio" name="proveedor_designado_radio" class="proveedor-designado-radio" value="">
                    Usar este proveedor
                  </label>
                </div>

                <div class="form-group-crear">
                  <label class="label-proveedor">Proveedor <span class="nombre_proveedor"></span></label>
                  <select class="proveedores form-control" name="proveedores[]">
                    <option value="">Selecciona proveedor...</option>
                    <% proveedores.forEach(function(proveedor) { %>
                      <option value="<%= proveedor.id %>" data-descuento="<%= proveedor.descuento %>"><%= proveedor.nombre %></option>
                    <% }); %>
                  </select>
                </div>

                <div class="form-group-crear">
                  <label class="label-codigo">C√≥digo</label>
                  <input class="codigo form-control" type="text" name="codigo[]" value="">
                </div>

                <div class="form-group-crear">
                  <label class="label-precio-lista">Precio de Lista</label>
                  <input class="precio_lista form-control" type="number" step="0.01" name="precio_lista[]" value="">
                </div>

                <div class="form-group-crear">
                  <label class="label-descuento">Descuento</label>
                  <input class="descuentos_proveedor_id form-control" type="text" name="descuentos_proveedor_id[]" value="0" readonly>
                </div>

                <div class="form-group-crear">
                  <label>Precio de costo (Neto)</label>
                  <input type="number" class="costo_neto form-control" name="costo_neto[]" value="0" readonly>
                </div>

                <div class="form-group-crear">
                  <label>IVA</label>
                  <select class="IVA form-control" name="IVA[]">
                    <option value="21" selected>21%</option>
                    <option value="10.5">10,5%</option>
                  </select>
                </div>

                <div class="form-group-crear">
                  <label>Precio de costo con IVA</label>
                  <input class="costo_iva form-control" type="number" name="costo_iva[]" step="0.01" value="0.00">
                </div>

                <div class="form-group-crear">
                  <button class="eliminar-proveedor btn btn-outline-danger" type="button">
                    Eliminar proveedor
                  </button>
                </div>
              </div>
            <% } %>

            <!-- Bot√≥n + SIEMPRE fuera del bloque .proveedor -->
            <div class="form-group-crear">
              <button id="addProveedor" type="button" class="btn btn-secondary">+ Agregar proveedor</button>
            </div>
          </div>

          <!-- ============ UTILIDADES / ESTADO / STOCK ============ -->
          <div class="utilidades">
            <div class="form-group-crear">
              <label for="utilidad">Utilidad</label>
              <input id="utilidad" class="form-control" type="number" name="utilidad" value="<%= producto ? producto.utilidad : '' %>">
            </div>

            <div class="form-group-crear">
              <label for="precio_venta">Precio Venta</label>
              <input id="precio_venta" class="form-control" type="number" name="precio_venta" data-manual="false" value="<%= producto ? producto.precio_venta : '' %>">
            </div>

            <div class="form-group-crear">
              <label for="estado">Estado</label>
              <select id="estado" class="form-control" name="estado">
                <option value="" <%= !producto || !producto.estado ? 'selected' : '' %>>Selecciona un estado...</option>
                <option value="activo" <%= producto && producto.estado == 'activo' ? 'selected' : '' %>>Activo</option>
                <option value="inactivo" <%= producto && producto.estado == 'inactivo' ? 'selected' : '' %>>Inactivo</option>
              </select>
            </div>

            <div class="form-group-crear">
              <label for="stock_minimo">Stock M√≠nimo</label>
              <input type="number" id="stock_minimo" class="form-control" name="stock_minimo" min="0" value="<%= stock.stock_minimo %>" required>
            </div>

            <div class="form-group-crear">
              <label for="stock_actual">Stock Actual</label>
              <input type="number" id="stock_actual" class="form-control" name="stock_actual" min="0" value="<%= stock.stock_actual %>" required>
            </div>

            <div class="botones-crear">
              <button class="btn btn-success" type="submit">Guardar</button>
              <a class="btn btn-primary" href="/productos/panelControl?pagina=<%= producto.paginaActual %>&busqueda=<%= encodeURIComponent(producto.busqueda || '') %>">Cancelar</a>
            </div>
          </div>
        </form>
      </div>
    </div> 
  </main>

  <%- include ./layouts/footer.ejs %>

  <!-- Libs -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.10.2/Sortable.min.js"></script>

  <!-- JS de edici√≥n -->
  <script src="/js/editar.js"></script>

  <script>
    // Si al entrar la marca ya est√° seleccionada, refrescamos modelos por marca
    (function initModeloSeleccionado() {
      var marcaSel = document.getElementById('marca')?.value;
      var modeloSel = document.getElementById('modelo_id')?.getAttribute('data-selected');
      if (!marcaSel || !modeloSel) return;
      $.get('/productos/modelos/' + marcaSel, function (modelosPorMarca) {
        var $modelo = $('#modelo_id');
        $modelo.empty().append('<option value="">Selecciona un modelo...</option>');
        (modelosPorMarca || []).forEach(function (m) {
          var selected = (String(m.id) === String(modeloSel)) ? 'selected' : '';
          $modelo.append('<option value="' + m.id + '" ' + selected + '>' + m.nombre + '</option>');
        });
      });
    })();
  </script>
</body>
