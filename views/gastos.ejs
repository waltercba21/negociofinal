<!DOCTYPE html>
<html lang="es">
<head>
  <%- include('layouts/head') %>
  <meta charset="utf-8"/>
  <title>Gastos</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    .gastos-container{max-width:1000px;margin:20px auto;padding:16px;background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
    .gastos-form{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;align-items:end}
    .gastos-form label{font-weight:600;font-size:.9rem}
    .gastos-form input,.gastos-form select, .gastos-form textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:8px}
    .gastos-form button{padding:10px 14px;border:none;border-radius:10px;background:#003f7d;color:#fff;font-weight:700;cursor:pointer}
    .gastos-form button:hover{opacity:.92}
    table{width:100%;border-collapse:collapse;margin-top:18px}
    th,td{padding:10px;border-bottom:1px solid #eee}
    th{text-align:left;background:#f7f7f7}
    .monto{font-variant-numeric:tabular-nums;font-weight:700}
  </style>
</head>
<body>
  <%- include('layouts/header') %>

  <div class="gastos-container">
    <h2>Registrar gasto</h2>

    <form class="gastos-form" action="/administracion/gastos" method="POST" id="form-gasto">
      <div>
        <label for="categoria">Categoría</label>
        <select id="categoria" name="categoria" required>
          <% (categorias || []).forEach(c => { %>
            <option value="<%= c %>"><%= c.toUpperCase() %></option>
          <% }) %>
        </select>
      </div>

      <div>
        <label for="fecha">Fecha</label>
        <input type="date" id="fecha" name="fecha" value="<%= hoy %>" required>
      </div>

      <div>
        <label for="monto">Monto ($)</label>
        <input type="number" id="monto" name="monto" step="0.01" min="0" placeholder="0.00" required>
      </div>

      <div style="grid-column:1 / -1">
        <label for="descripcion">Descripción (opcional)</label>
        <textarea id="descripcion" name="descripcion" rows="2" placeholder="Detalle breve del gasto..."></textarea>
      </div>

      <input type="hidden" name="administrador" value="<%= (typeof userLogged !== 'undefined' && userLogged?.nombre) ? userLogged.nombre : 'admin' %>">

      <div style="grid-column:1 / -1; text-align:right">
        <button type="submit">Guardar gasto</button>
      </div>
    </form>

    <h3 style="margin-top:26px">Últimos 30 días</h3>
    <table>
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Categoría</th>
          <th>Descripción</th>
          <th style="text-align:right">Monto</th>
        </tr>
      </thead>
      <tbody>
        <% if ((gastos || []).length === 0) { %>
          <tr><td colspan="4">Sin registros recientes.</td></tr>
        <% } else { %>
          <% gastos.forEach(g => { %>
            <tr>
              <td><%= new Date(g.fecha).toLocaleDateString('es-AR') %></td>
              <td><%= g.categoria %></td>
              <td><%= g.descripcion || '' %></td>
              <td class="monto" style="text-align:right">
                $ <%= Number(g.monto).toLocaleString('es-AR', { minimumFractionDigits: 2 }) %>
              </td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>

  <script>
    // === Alerta al cambiar la fecha (usa SweetAlert que ya tenés)
    (function(){
      const $fecha = document.getElementById('fecha');
      if(!$fecha) return;

      const valorInicial = $fecha.value;

      $fecha.addEventListener('change', async (e) => {
        const nuevo = e.target.value;
        if (nuevo === valorInicial) return;

        let ok = true;
        if (window.Swal) {
          const r = await Swal.fire({
            title: '⚠️ CUIDADO',
            text: 'Estás por cambiar la fecha del gasto. ¿Confirmás?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sí, cambiar',
            cancelButtonText: 'No, volver',
            reverseButtons: true
          });
          ok = r.isConfirmed;
        } else {
          ok = confirm('Estás por cambiar la fecha del gasto. ¿Confirmás?');
        }

        if (!ok) {
          e.target.value = valorInicial; // volver al valor original
        }
      });

      // Validación rápida de monto (evitar negativos / NaN)
      const $monto = document.getElementById('monto');
      const $form  = document.getElementById('form-gasto');
      $form.addEventListener('submit', (ev) => {
        const v = parseFloat($monto.value || '0');
        if (isNaN(v) || v <= 0) {
          ev.preventDefault();
          if (window.Swal) {
            Swal.fire('Monto inválido', 'Ingresá un monto mayor a 0', 'error');
          } else {
            alert('Ingresá un monto mayor a 0');
          }
        }
      });
    })();
  </script>

  <%- include('layouts/footer') %>
</body>
</html>
