<%- include ./layouts/head.ejs %>
<%- include ./layouts/header.ejs %>
<html>
<body>
<main>
   <div class="register-form">
    
    <h2>Registrate</h2>

    <form action="./register" method="post" class="formulario-register">

        <label for="nombre">Nombre Completo</label>
        <input type="text" name="nombre" value="<%= locals.oldData ? oldData.nombre : '' %>">
        <% if (locals.errors && errors.nombre) { %>
          <div class="error">
           <%= errors.nombre.msg %>
          </div>
         <% } %>

        <label for="apellido">Apellido</label>
        <input type="text" name="apellido" value="<%= locals.oldData ? oldData.apellido : '' %>">
        <% if (locals.errors && errors.apellido) { %>
          <div class="error">
           <%= errors.apellido.msg %>
          </div>
         <% } %>

        <label for="email">Email</label>
        <input type="text" name="email" value="<%= locals.oldData ? oldData.email : '' %>">
        <% if (locals.errors && errors.email) { %>
          <div class="error">
           <%= errors.email.msg %>
          </div>
         <% } %>
         <% if (locals.errors && errors.emailExists) { %>
          <div class="error">
           <%= errors.emailExists.msg %>
          </div>
         <% } %>

        <label for="password">Contraseña</label>
        <input type="password" name="password" value="<%= locals.oldData ? oldData.password : '' %>">
        <% if (locals.errors && errors.password) { %>
          <div class="error">
           <%= errors.password.msg %>
          </div>
         <% } %>

        <label for="telefono">Teléfono</label>
        <input type="text" name="celular" value="<%= locals.oldData ? oldData.celular : '' %>">
        <% if (locals.errors && errors.celular) { %>
          <div class="error">
           <%= errors.celular.msg %>
          </div>
         <% } %>

        <label for="direccion">Dirección</label>
        <input type="text" name="direccion" value="<%= locals.oldData ? oldData.direccion : '' %>">
        <% if (locals.errors && errors.direccion) { %>
          <div class="error">
           <%= errors.direccion.msg %>
          </div>
         <% } %>

         <label for="provincia">Provincia</label>
         <select name="provincia" id="provincia" onchange="cargarLocalidades()">
           <option value="">Selecciona una provincia</option>
           <!-- Las opciones de provincia se cargarán aquí -->
         </select>
         
         <label for="localidad">Localidad</label>
         <select name="localidad" id="localidad">
           <option value="">Selecciona una localidad</option>
           <!-- Las opciones de localidad se cargarán aquí -->
         </select>

        <label for="fecha_nacimiento">Fecha de Nacimiento</label>
        <input type="date" name="fecha_nacimiento" value="<%= locals.oldData ? oldData.fecha_nacimiento : '' %>">
        <% if (locals.errors && errors.fecha_nacimiento) { %>
          <div class="error">
           <%= errors.fecha_nacimiento.msg %>
          </div>
         <% } %>

        <label for="acepto_terminos">
            <input type="checkbox" name="acepto_terminos" <%= locals.oldData && oldData.acepto_terminos ? 'checked' : '' %> required>
            Acepto los <a href="/terminos" target="_blank">términos y condiciones</a>
        </label>
        <% if (locals.errors && errors.acepto_terminos) { %>
          <div class="error">
           <%= errors.acepto_terminos.msg %>
          </div>
         <% } %>

        <div class="btn-guardar">
            <input type="submit" value="Guardar" class="btn-register"> 
            <a href="/" class="btn-cancel">Cancelar</a> 
        </div>

    </form>
  </div>
</main>

<%- include ./layouts/footer.ejs %>

<script>
// Cargar provincias desde la API al cargar la página
async function cargarProvincias() {
  try {
    const response = await fetch('https://apis.datos.gob.ar/georef/api/provincias');
    const data = await response.json();
    const provincias = data.provincias;
    const provinciaSelect = document.getElementById('provincia');
    
    // Ordenar alfabéticamente y agregar las provincias al select
    provincias.sort((a, b) => a.nombre.localeCompare(b.nombre));
    
    provincias.forEach(provincia => {
      const option = document.createElement('option');
      option.value = provincia.id;
      option.textContent = provincia.nombre;
      provinciaSelect.appendChild(option);
    });
  } catch (error) {
    console.error('Error al cargar provincias:', error);
  }
}

// Cargar localidades de la provincia seleccionada
async function cargarLocalidades() {
  const provinciaId = document.getElementById('provincia').value;
  const localidadSelect = document.getElementById('localidad');

  console.log('provinciaId:', provinciaId);  // Imprime el valor de provinciaId

  if (provinciaId) {
    try {
      // Verifica que el id sea un valor válido
      if (!provinciaId || isNaN(provinciaId)) {
        console.error('Provincia no válida');
        return;
      }

      const response = await fetch(`https://apis.datos.gob.ar/georef/api/localidades?provincia=${provinciaId}&max=9999`);
      const data = await response.json();

      console.log('Respuesta de localidades:', data);  // Verifica la respuesta de la API

      const localidades = data.localidades;

      // Limpiar las opciones de localidad
      localidadSelect.innerHTML = '<option value="">Selecciona una localidad</option>';

      // Verificar si hay localidades
      if (localidades && localidades.length > 0) {
        // Ordenar alfabéticamente y agregar las localidades al select
        localidades.sort((a, b) => a.nombre.localeCompare(b.nombre));

        localidades.forEach(localidad => {
          const option = document.createElement('option');
          option.value = localidad.id;
          option.textContent = localidad.nombre;
          localidadSelect.appendChild(option);
        });
      } else {
        // Mensaje en caso de no haber localidades
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No hay localidades disponibles';
        localidadSelect.appendChild(option);
      }
    } catch (error) {
      console.error('Error al cargar localidades:', error);
    }
  } else {
    // Limpiar las opciones si no se selecciona provincia
    localidadSelect.innerHTML = '<option value="">Selecciona una localidad</option>';
  }
}


// Llamar a cargar provincias al cargar la página
window.onload = cargarProvincias;

</script>

</body>
</html>
