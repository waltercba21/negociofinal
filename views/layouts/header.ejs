<header class="<%= isLogged ? 'is-logged' : 'is-guest' %>"
        data-usuario-id="<%= (userLogged && userLogged.id) ? userLogged.id : '' %>">

  <a href="/">
    <img class="logo" src="/uploads/productos/logo.png?v=2" alt="LOGO" />
  </a>

  <button class="hamburger" onclick="toggleMenu()" aria-label="Abrir menÃº">â˜°</button>

  <% const qHeader = (typeof req !== 'undefined' && req.query && req.query.q) ? String(req.query.q) : ''; %>

  <form class="header-search" action="/productos" method="GET" role="search" autocomplete="off">
    <div class="buscador-con-icono">
      <span class="search-ico" aria-hidden="true">
  <svg viewBox="0 0 24 24" focusable="false">
    <circle cx="11" cy="11" r="7"></circle>
    <path d="M20 20l-3.5-3.5"></path>
  </svg>
</span>


      <input
        type="text"
        name="q"
        id="headerEntradaBusqueda"
        placeholder="Â¿QuÃ© estÃ¡s buscando? Ej: Escort, Ã“ptica, Faro, Agile"
        value="<%= qHeader %>">

      <button type="button" id="headerBotonLimpiar" class="boton-limpiar" aria-label="Limpiar bÃºsqueda">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </form>

  <nav class="navbar">
    <a class="nav-link" href="/">INICIO</a>
    <a class="nav-link" href="/productos">PRODUCTOS</a>

    <% if (!isAdminUser) { %>
      <a class="nav-link" href="/productos/ofertas">OFERTAS</a>
      <a class="nav-link" href="https://wa.me/+543513820440/" target="_blank">WHATSAPP</a>
      <a class="nav-link" href="#" onclick="abrirMapa(); return false;">UBICACIÃ“N</a>
    <% } %>

    <% if (isAdminUser) { %>
      <a class="nav-link" href="/productos/panelControl">PANEL CONTROL</a>
      <a class="nav-link" href="/productos/presupuestoMostrador">PRESUPUESTO</a>
      <a class="nav-link-factura" href="/productos/facturasMostrador">FACTURAS</a>
      <a class="nav-link" href="/arca">ARCA</a>
      <a class="nav-link" href="/administracion/gastos" id="gastos-btn">GASTOS</a>
      <a class="nav-link" href="/administracion" id="admin-btn">ADMINISTRACIÃ“N</a>
      <a href="/pedidos" class="nav-link pedidos-link" style="position:relative;">
  PEDIDOS
  <span id="badge-pedidos" class="badge-pedidos" style="display:none;">0</span>
</a>

    <% } %>

    <% if (!isLogged) { %>
      <!-- SOLO mobile: auth dentro del menÃº -->
      <div class="nav-auth">
        <a class="nav-link" href="/users/login">Iniciar SesiÃ³n</a>
        <a class="nav-link register-link" href="/users/register">Registrarme</a>
      </div>
    <% } %>
  </nav>

  <div class="icons">
    <% if (isLogged) { %>
      <div class="logueado">
        <a href="/users/profile"><p>Hola <%= userLogged.nombre %></p></a>

        <% if (!isAdminUser) { %>
          <a href="/carrito" class="carrito-icon">
            <i class="fa-solid fa-cart-shopping"></i>
            <span id="carrito-notificacion" class="cantidad-alerta"
              <% if (cantidadCarrito <= 0) { %> style="display: none;" <% } %>>
              <%= cantidadCarrito %>
            </span>
          </a>
        <% } %>

        <a href="/users/logout">
          <i class="fa-solid fa-right-from-bracket"></i>
          <span>Salir</span>
        </a>
      </div>
    <% } else { %>
      <!-- En mobile se ocultan y se usan los del menÃº -->
      <a href="/users/login">Iniciar SesiÃ³n</a>
      <a class="register-link" href="/users/register">Registrarme</a>
    <% } %>
  </div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  const socket = io();

  const headerEl = document.querySelector('header[data-usuario-id]');
  const usuarioId = headerEl ? headerEl.dataset.usuarioId : '';

  if (usuarioId) {
    socket.emit('register', { usuarioId: Number(usuarioId) });
  }

  socket.on('pedidoActualizado', (data) => {
    alert(`Pedido #${data.id_pedido} â†’ ${data.estado}`);
  });

  // Admin (dejalo, pero solo si existe la funciÃ³n)
  socket.on('actualizarNotificacion', () => {
    if (typeof actualizarPedidosPendientes === 'function') {
      actualizarPedidosPendientes();
    }
  });
</script>


  <script>
    (function () {
      const input = document.getElementById('headerEntradaBusqueda');
      const clear = document.getElementById('headerBotonLimpiar');
      if (!input || !clear) return;

      const sync = () => { clear.style.display = input.value.trim() ? 'block' : 'none'; };
      sync();

      input.addEventListener('input', sync, { passive: true });
      clear.addEventListener('click', () => {
        input.value = '';
        sync();
        input.focus();
      }, { passive: true });
    })();
  </script>
  <script>
document.addEventListener('DOMContentLoaded', () => {
  const badge = document.getElementById('badge-pedidos');
  if (!badge) return; // si esta pÃ¡gina no tiene el botÃ³n, no hace nada

  async function actualizarBadgePedidos() {
    try {
      const res = await fetch('/pedidos/cantidad', { headers: { 'Accept': 'application/json' } });
      if (!res.ok) return;
      const data = await res.json();
      const n = Number(data.cantidad || 0);

      badge.textContent = n;
      badge.style.display = (n > 0) ? 'inline-flex' : 'none';
    } catch (_) {}
  }

  function toastPedido(texto) {
    if (typeof Swal === 'undefined') return;
    Swal.fire({
      toast: true,
      position: 'top-end',
      icon: 'info',
      title: texto,
      showConfirmButton: false,
      timer: 3200,
      timerProgressBar: true
    });
  }

  actualizarBadgePedidos();

  const socket = io();

  socket.on('nuevoPedido', (payload = {}) => {
    // payload esperado: { mensaje, id_carrito, usuario, estado } (lo emite carritoController)
    toastPedido(payload.mensaje || `ðŸ“¦ Nuevo pedido #${payload.id_carrito || ''}`);
    actualizarBadgePedidos();
  });

  socket.on('actualizarNotificacion', () => {
    actualizarBadgePedidos();
  });
});
</script>

</header>
