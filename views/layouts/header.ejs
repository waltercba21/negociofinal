<header class="<%= isLogged ? 'is-logged' : 'is-guest' %>">
  <a href="/">
    <img class="logo" src="/uploads/productos/logo.png?v=2" alt="LOGO" />
  </a>

  <button class="hamburger" onclick="toggleMenu()" aria-label="Abrir menú">☰</button>

  <% const qHeader = (typeof req !== 'undefined' && req.query && req.query.q) ? String(req.query.q) : ''; %>

  <form class="header-search" action="/productos" method="GET" role="search" autocomplete="off">
    <div class="buscador-con-icono">
      <span class="search-ico" aria-hidden="true">
  <svg viewBox="0 0 24 24" focusable="false">
    <circle cx="11" cy="11" r="7"></circle>
    <path d="M20 20l-3.5-3.5"></path>
  </svg>
</span>


      <input
        type="text"
        name="q"
        id="headerEntradaBusqueda"
        placeholder="¿Qué estás buscando? Ej: Escort, Óptica, Faro, Agile"
        value="<%= qHeader %>">

      <button type="button" id="headerBotonLimpiar" class="boton-limpiar" aria-label="Limpiar búsqueda">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </form>

  <nav class="navbar">
    <a class="nav-link" href="/">INICIO</a>
    <a class="nav-link" href="/productos">PRODUCTOS</a>

    <% if (!isAdminUser) { %>
      <a class="nav-link" href="/productos/ofertas">OFERTAS</a>
      <a class="nav-link" href="https://wa.me/+543513820440/" target="_blank">WHATSAPP</a>
      <a class="nav-link" href="#" onclick="abrirMapa(); return false;">UBICACIÓN</a>
    <% } %>

    <% if (isAdminUser) { %>
      <a class="nav-link" href="/productos/panelControl">PANEL CONTROL</a>
      <a class="nav-link" href="/productos/presupuestoMostrador">PRESUPUESTO</a>
      <a class="nav-link-factura" href="/productos/facturasMostrador">FACTURAS</a>
      <a class="nav-link" href="/administracion/gastos" id="gastos-btn">GASTOS</a>
      <a class="nav-link" href="/administracion" id="admin-btn">ADMINISTRACIÓN</a>
      <a class="nav-link pedidos-icon" href="/pedidos" id="pedidos-btn">
        PEDIDOS
        <span id="pedido-notificacion" class="pedido-alerta" style="display: none;">0</span>
      </a>
    <% } %>

    <% if (!isLogged) { %>
      <!-- SOLO mobile: auth dentro del menú -->
      <div class="nav-auth">
        <a class="nav-link" href="/users/login">Iniciar Sesión</a>
        <a class="nav-link register-link" href="/users/register">Registrarme</a>
      </div>
    <% } %>
  </nav>

  <div class="icons">
    <% if (isLogged) { %>
      <div class="logueado">
        <a href="/users/profile"><p>Hola <%= userLogged.nombre %></p></a>

        <% if (!isAdminUser) { %>
          <a href="/carrito" class="carrito-icon">
            <i class="fa-solid fa-cart-shopping"></i>
            <span id="carrito-notificacion" class="cantidad-alerta"
              <% if (cantidadCarrito <= 0) { %> style="display: none;" <% } %>>
              <%= cantidadCarrito %>
            </span>
          </a>
        <% } %>

        <a href="/users/logout">
          <i class="fa-solid fa-right-from-bracket"></i>
          <span>Salir</span>
        </a>
      </div>
    <% } else { %>
      <!-- En mobile se ocultan y se usan los del menú -->
      <a href="/users/login">Iniciar Sesión</a>
      <a class="register-link" href="/users/register">Registrarme</a>
    <% } %>
  </div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    const socket = io();
    socket.on('actualizarNotificacion', () => { actualizarPedidosPendientes(); });

    async function actualizarPedidosPendientes() {
      try {
        const response = await fetch('/pedidos/cantidad');
        const data = await response.json();
        const notificacion = document.getElementById("pedido-notificacion");
        if (!notificacion) return;

        if (data.cantidad > 0) {
          notificacion.textContent = data.cantidad;
          notificacion.style.display = "flex";
        } else {
          notificacion.style.display = "none";
        }
      } catch (error) {
        console.error("❌ Error al obtener pedidos pendientes:", error);
      }
    }
    actualizarPedidosPendientes();
  </script>  
  <script>
    (function () {
      const input = document.getElementById('headerEntradaBusqueda');
      const clear = document.getElementById('headerBotonLimpiar');
      if (!input || !clear) return;

      const sync = () => { clear.style.display = input.value.trim() ? 'block' : 'none'; };
      sync();

      input.addEventListener('input', sync, { passive: true });
      clear.addEventListener('click', () => {
        input.value = '';
        sync();
        input.focus();
      }, { passive: true });
    })();
  </script>
</header>
