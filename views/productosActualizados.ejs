<%- include ./layouts/head.ejs %>
<%- include ./layouts/header.ejs %>
<body>
  <main>
    <h1>Productos Actualizados</h1>

    <!-- Botonera superior -->
    <div style="display:flex; gap:10px; align-items:center; margin: 10px 0 20px;">
      <a href="/productos/panelControl" class="btn btn-primary">‚Üê Volver al Panel de Control</a>

      <% if (typeof cantidadNuevos !== 'undefined' && Number(cantidadNuevos) > 0) { %>
        <a href="/productos/actualizados/nuevos.pdf" class="btn btn-secondary">
          üìÑ PRODUCTOS NUEVOS (<%= cantidadNuevos %>)
        </a>
      <% } else { %>
        <button class="btn btn-secondary" disabled title="No se detectaron productos nuevos">
          üìÑ PRODUCTOS NUEVOS (0)
        </button>
      <% } %>
    </div>

    <table>
      <thead>
        <tr>
          <th>C√≥digo</th>
          <th>Nombre</th>
          <th>Precio Lista Viejo</th>
          <th>Precio Lista Nuevo</th>
          <th>Precio De Venta</th>
          <th>Diferencia</th>
          <th>Modificaci√≥n</th>
        </tr>
      </thead>
      <tbody>
        <% (productos || []).forEach(producto => {
          let viejo = parseFloat(producto.precio_lista_antiguo || 0);
          let nuevo = parseFloat(producto.precio_lista_nuevo || 0);
          let diferencia = viejo > 0 ? ((nuevo - viejo) / viejo) * 100 : 0;
          let diferenciaRedondeada = diferencia.toFixed(2);
          let diferenciaClass = diferencia > 0 ? 'positivo' : (diferencia < 0 ? 'negativo' : 'neutro');
          let modificacion = producto.sin_cambio ? 'NO MODIFICA' : 'MODIFICA';
        %>
        <tr>
          <td><%= producto.codigo %></td>
          <td><%= producto.nombre %></td>
          <td>$<%= viejo.toLocaleString('es-AR') %></td>
          <td>$<%= nuevo.toLocaleString('es-AR') %></td>
          <td>$<%= parseFloat(producto.precio_venta || 0).toLocaleString('es-AR') %></td>
          <td class="<%= diferenciaClass %>"><%= diferenciaRedondeada %> %</td>
          <td><%= modificacion %></td>
        </tr>
        <% }); %>
      </tbody>
    </table>

    <p>Total de productos actualizados: <%= (productos || []).length %></p>

    <% if (ofertasFaltantes && ofertasFaltantes.length) { %>
      <hr style="margin: 30px 0;">
      <h2>‚ö†Ô∏è Productos que <u>NO</u> vinieron en el √∫ltimo Excel de <strong>DISTRIMAR OFERTAS</strong></h2>
      <p style="margin-top:6px">
        Revisalos: probablemente debas quitarles la bandera de oferta y volver al precio de lista habitual.
      </p>

      <table>
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Nombre</th>
            <th>Precio Lista (OFERTA) en DB</th>
            <th>Precio de Venta Actual</th>
            <th>Marcado como Oferta</th>
          </tr>
        </thead>
        <tbody>
          <% ofertasFaltantes.forEach(p => { %>
            <tr>
              <td><%= p.codigo %></td>
              <td><%= p.nombre %></td>
              <td>$<%= Number(p.precio_lista_oferta || 0).toLocaleString('es-AR') %></td>
              <td>$<%= Number(p.precio_venta || 0).toLocaleString('es-AR') %></td>
              <td><%= p.oferta_flag %></td>
            </tr>
          <% }); %>
        </tbody>
      </table>

      <p style="margin-top: 8px">Total fuera de la nueva lista de OFERTAS: <strong><%= ofertasFaltantes.length %></strong></p>
    <% } %>
  </main>

  <div style="margin-top: 20px; text-align: center;">
    <a href="/productos/panelControl" class="btn btn-primary">‚Üê Volver al Panel de Control</a>
  </div>

  <%- include ./layouts/footer.ejs %>
</body>
