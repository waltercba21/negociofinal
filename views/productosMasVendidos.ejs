<%- include('./layouts/head.ejs') %>
<%- include('./layouts/header.ejs') %>

<div class="mv-wrap container mt-4">
  <div class="mv-card">
    <!-- Encabezado + filtros (sticky) -->
    <div class="mv-header">
      <h2 class="mv-title">Productos Más Vendidos</h2>

      <form class="mv-filters" method="GET" action="">
        <div class="mv-field">
          <label for="categoria_id" class="mv-label">Categoría</label>
          <select id="categoria_id" name="categoria_id" class="mv-input">
            <option value="">Todas</option>
            <% (categorias || []).forEach(c => { %>
              <option value="<%= c.id %>" <%= (filtros && String(filtros.categoria_id) === String(c.id)) ? 'selected' : '' %>><%= c.nombre %></option>
            <% }) %>
          </select>
        </div>

        <div class="mv-field">
          <label for="desde" class="mv-label">Desde</label>
          <input type="date" id="desde" name="desde" class="mv-input" value="<%= filtros?.desde || '' %>">
        </div>

        <div class="mv-field">
          <label for="hasta" class="mv-label">Hasta</label>
          <input type="date" id="hasta" name="hasta" class="mv-input" value="<%= filtros?.hasta || '' %>">
        </div>
        <div class="mv-actions-extra">
  <form method="GET" action="/reportes/recomendaciones">
    <input type="hidden" name="categoria_id" value="<%= filtros?.categoria_id || '' %>">
    <input type="hidden" name="desde" value="<%= filtros?.desde || '' %>">
    <input type="hidden" name="hasta" value="<%= filtros?.hasta || '' %>">
    <button class="mv-btn" type="submit">
      Generar Recomendaciones de Compra (PDF)
    </button>
  </form>
</div>

        <div class="mv-actions">
          <button type="submit" class="mv-btn">Filtrar</button>
        </div>
      </form>

      <div class="mv-summary">
        <strong>Filtros:</strong>
        <span><%= (filtros?.categoria_id ? 'Categoría ID ' + filtros.categoria_id : 'Todas las categorías') %></span> ·
        <span><%= (filtros?.desde ? ('Desde ' + filtros.desde) : 'Sin fecha desde') %></span> ·
        <span><%= (filtros?.hasta ? ('Hasta ' + filtros.hasta) : 'Sin fecha hasta') %></span>
      </div>
    </div>

    <!-- Tabla (body scrollable con thead sticky) -->
    <div class="mv-table-wrap">
      <table class="mv-table">
        <thead>
          <tr>
            <th>Nombre</th>
            <th class="mv-num">Total Vendido</th>
            <th class="mv-num">Precio Venta</th>
          </tr>
        </thead>
        <tbody>
          <% if ((productos || []).length === 0) { %>
            <tr>
              <td colspan="3" class="mv-empty">No se encontraron resultados con los filtros aplicados.</td>
            </tr>
          <% } else { %>
            <% productos.forEach(prod => { %>
              <tr>
                <td class="mv-name"><%= prod.nombre %></td>
                <td class="mv-num"><%= prod.total_vendido %></td>
                <td class="mv-num">
                  $ <%= Number(prod.precio_venta || 0).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
                </td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<%- include('./layouts/footer.ejs') %>
