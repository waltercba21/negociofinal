<%- include('./layouts/head.ejs') %>
<%- include('./layouts/header.ejs') %>

<div class="mv-wrap container mt-4">
  <form class="mv-filters" method="GET" action="">
    <div class="mv-field" style="min-width:260px;">
      <label for="busqueda" class="mv-label">Producto (nombre o código)</label>
      <input
        type="text"
        id="busqueda"
        name="busqueda"
        class="mv-input"
        placeholder="Ej: Faro Ranger 2018 o ABC123"
        value="<%= filtros?.busqueda || '' %>">
    </div>

    <div class="mv-field">
      <label for="categoria_id" class="mv-label">Categoría</label>
      <select id="categoria_id" name="categoria_id" class="mv-input">
        <option value="">Todas</option>
        <% (categorias || []).forEach(c => { %>
          <option value="<%= c.id %>" <%= (filtros && String(filtros.categoria_id) === String(c.id)) ? 'selected' : '' %>>
            <%= c.nombre %>
          </option>
        <% }) %>
      </select>
    </div>

    <div class="mv-field">
      <label for="desde" class="mv-label">Desde</label>
      <input type="date" id="desde" name="desde" class="mv-input" value="<%= filtros?.desde || '' %>">
    </div>

    <div class="mv-field">
      <label for="hasta" class="mv-label">Hasta</label>
      <input type="date" id="hasta" name="hasta" class="mv-input" value="<%= filtros?.hasta || '' %>">
    </div>

    <div class="mv-actions" style="gap:12px;">
      <button type="submit" class="mv-btn">Filtrar</button>
      <button
        type="submit"
        class="mv-btn"
        formaction="/reportes/recomendaciones"
        formmethod="GET"
        formtarget="_blank"
        title="Genera PDF con top vendidos, top buscados y sugerido de compra">
        PDF Recomendaciones
      </button>
    </div>
  </form>

  <div class="mv-summary" style="margin-top:8px;">
    <strong>Filtros:</strong>
    <span><%= (filtros?.busqueda ? ('“' + filtros.busqueda + '”') : 'Sin texto') %></span> ·
    <span><%= (filtros?.categoria_id ? ('Categoría ID ' + filtros.categoria_id) : 'Todas categorías') %></span> ·
    <span><%= (filtros?.desde ? ('Desde ' + filtros.desde) : 'Sin desde') %></span> ·
    <span><%= (filtros?.hasta ? ('Hasta ' + filtros.hasta) : 'Sin hasta') %></span>
  </div>

  <div class="mv-table-wrap">
    <table class="mv-table">
      <thead>
        <tr>
          <th>Producto</th>
          <th class="mv-num">Total Vendido</th>
          <th class="mv-num">Precio Venta</th>
        </tr>
      </thead>
      <tbody>
        <% if ((productos || []).length === 0) { %>
          <tr>
            <td colspan="3" class="mv-empty">No se encontraron resultados con los filtros aplicados.</td>
          </tr>
        <% } else { %>
          <% productos.forEach(p => { %>
            <tr>
              <td class="mv-name"><%= p.nombre %></td>
              <td class="mv-num"><%= Number(p.total_vendido || 0) %></td>
              <td class="mv-num">$ <%= Number(p.precio_venta || 0).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<%- include('./layouts/footer.ejs') %>
