<%- include ./layouts/head.ejs %>
<%- include ./layouts/header.ejs %>

<body>
  <main>
    <div class="container-crear">
      <div class="titulo-crear">Crear Producto</div>

      <div class="contenido-crear">
        <div class="card-body">
          <form class="form-crear" method="POST" action="/productos" enctype="multipart/form-data">
            <!-- ============ CARACTERÍSTICAS ============ -->
            <div class="caracteristicas">
              <div class="form-group-crear">
                <label for="imagen">Imagen</label>
                <input id="imagen" class="form-control-file" type="file" name="archivos[]" multiple>
              </div>

              <!-- Siempre presente para el preview -->
              <div id="preview" class="imagen-miniatura-contenedor"></div>

              <div class="form-group-crear">
                <label for="nombre">Nombre</label>
                <input id="nombre" class="form-control" type="text" name="nombre" required>
              </div>

              <div class="form-group-crear">
                <label for="descripcion">Descripción</label>
                <input id="descripcion" class="form-control" type="text" name="descripcion">
              </div>

              <div class="form-group-crear">
                <label for="oferta">Oferta</label>
                <input type="hidden" name="oferta" value="0">
                <input type="checkbox" id="oferta" name="oferta" value="1" class="form-check-input" <%= (producto && producto.oferta === 1) ? 'checked' : '' %> >
              </div>

              <div class="form-group-crear">
                <label for="categoria">Categoría</label>
                <select id="categoria" name="categoria" class="form-control">
                  <option value="" selected>Selecciona una categoría</option>
                  <% categorias.forEach(function(categoria) { %>
                    <option value="<%= categoria.id %>"><%= categoria.nombre %></option>
                  <% }); %>
                </select>
              </div>

              <div class="form-group-crear">
                <label for="marca">Marca</label>
                <select id="marca" name="marca" class="form-control">
                  <option value="" selected>Selecciona una marca</option>
                  <% marcas.forEach(function(marca) { %>
                    <option value="<%= marca.id %>"><%= marca.nombre %></option>
                  <% }); %>
                </select>
              </div>

              <div class="form-group-crear">
                <label for="modelo_id">Modelo</label>
                <select id="modelo_id" name="modelo_id" class="form-control">
                  <option value="" selected>Selecciona un modelo</option>
                  <% modelos.forEach(function(modelo) { %>
                    <option value="<%= modelo.id %>"><%= modelo.nombre %></option>
                  <% }); %>
                </select>
              </div>
            </div>

            <!-- ============ PROVEEDORES ============ -->
            <div id="proveedoresContainer">
              <div class="form-group-crear">
                <label for="calidad_original">Calidad FITAM</label>
                <input type="checkbox" id="calidad_original" name="calidad_original" value="1">
              </div>

              <div class="form-group-crear">
                <label for="calidad_vic">Calidad VIC</label>
                <input type="checkbox" id="calidad_vic" name="calidad_vic" value="1">
              </div>

              <!-- Indicador del proveedor asignado (más barato) -->
              <div class="form-group-crear">
                <label>Proveedor asignado (automático por costo IVA más bajo):</label>
                <div id="proveedorAsignado" class="form-control" readonly></div>
              </div>

              <!-- Bloque base de proveedor (plantilla para clonar) -->
              <div class="proveedor">
                <div class="form-group-crear">
                  <label class="label-proveedor">Proveedor <span class="nombre_proveedor"></span></label>
                  <select class="proveedores form-control" name="proveedores[]" required>
                    <option value="" selected>Selecciona proveedor...</option>
                    <% proveedores.forEach(function(proveedor) { %>
                      <option value="<%= proveedor.id %>" data-descuento="<%= proveedor.descuento %>">
                        <%= proveedor.nombre %>
                      </option>
                    <% }); %>
                  </select>
                </div>

                <div class="form-group-crear">
                  <label class="label-codigo">Código Proveedor</label>
                  <input class="codigo form-control" type="text" name="codigo[]" value="">
                </div>

                <div class="form-group-crear">
                  <label class="label-precio-lista">Precio de Lista</label>
                  <input class="precio_lista form-control" type="number" step="0.01" name="precio_lista[]" value="">
                </div>

                <div class="form-group-crear">
                  <label class="label-descuento">Descuento</label>
                  <input class="descuentos_proveedor_id form-control" type="text" name="descuentos_proveedor_id[]" value="0" readonly>
                </div>

                <!-- Ocultos compatibles con el JS (si faltan, el JS los crea) -->
                <input type="hidden" class="costo_neto" name="costo_neto[]" value="0">
                <input type="hidden" class="IVA" name="IVA[]" value="21">
                <input type="hidden" class="costo_iva" name="costo_iva[]" value="0">
              </div>

              <!-- Botón + (fuera del bloque .proveedor para evitar que el clon lo copie) -->
              <div class="form-group-crear">
                <button id="addProveedor" type="button" class="btn btn-secondary">+ Agregar proveedor</button>
              </div>
            </div>

            <!-- ============ UTILIDADES / ESTADO / STOCK ============ -->
            <div class="utilidades">
              <div class="form-group-crear">
                <label for="utilidad">Utilidad</label>
                <input id="utilidad" class="form-control" type="number" name="utilidad" value="<%= typeof utilidad !== 'undefined' ? utilidad : '' %>">
              </div>

              <div class="form-group-crear">
                <label for="precio_venta">Precio Venta</label>
                <input id="precio_venta" class="form-control" type="number" name="precio_venta" value="<%= producto && producto.precio_venta ? producto.precio_venta : '' %>">
              </div>

              <div class="form-group-crear">
                <label for="estado">Estado</label>
                <select id="estado" class="form-control" name="estado">
                  <option value="">Selecciona un estado...</option>
                  <option value="activo">Activo</option>
                  <option value="inactivo">Inactivo</option>
                </select>
              </div>

              <div class="form-group-crear">
                <label for="stock_minimo">Stock Mínimo</label>
                <input type="number" id="stock_minimo" class="form-control" name="stock_minimo" min="0" required>
              </div>

              <div class="form-group-crear">
                <label for="stock_actual">Stock Actual</label>
                <input type="number" id="stock_actual" class="form-control" name="stock_actual" min="0" required>
              </div>

              <div class="botones-crear">
                <button class="btn btn-success" type="submit">Guardar</button>
                <a class="btn btn-primary" href="/productos">Cancelar</a>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </main>

  <%- include ./layouts/footer.ejs %>

  <!-- Libs -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.10.2/Sortable.min.js"></script>

  <!-- Tu JS (usa el que corregimos) -->
  <script src="/js/crear.js"></script>
</body>
