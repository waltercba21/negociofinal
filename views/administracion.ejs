<%- include('./layouts/head.ejs') %>
<%- include('./layouts/header.ejs') %>

<body>
  <style>
    /* ========================= ADMIN DASH (DESKTOP) ========================= */
    :root{
      --brand:#1f487e;
      --brand2:#0f2f55;

      --bg:#f4f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:rgba(15,23,42,.65);
      --line:rgba(2,6,23,.10);

      --shadow:0 14px 30px rgba(2,6,23,.10);
      --shadow2:0 10px 22px rgba(2,6,23,.10);

      --r14:14px;
      --r18:18px;
      --tap:44px;
    }

    /* Fondo claro (sin negro) */
    .af-admin{
      background:var(--bg);
      padding:18px;
      border-radius:18px;
      color:var(--text);
      font-size:14px;
      max-width: 1280px;
      margin: 0 auto;
    }

    /* Header del panel */
    .af-topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:14px 16px;
      border-radius:18px;
      background:linear-gradient(90deg, rgba(31,72,126,.10), rgba(15,47,85,.06));
      border:1px solid rgba(31,72,126,.18);
      box-shadow:var(--shadow2);
      margin-bottom:14px;
    }
    .af-topbar h1{
      margin:0;
      font-size:16px;
      font-weight:950;
      letter-spacing:.2px;
      color:rgba(15,23,42,.88);
    }
    .af-topbar .af-topbar-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* Dashboard: solo botones/tarjetas */
    .af-dash{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:14px;
    }

    .af-tile{
      border-radius:18px;
      background:var(--card);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:120px;
    }

    .af-tile .af-tile-title{
      margin:0;
      font-weight:950;
      letter-spacing:.15px;
      color:rgba(15,23,42,.90);
      font-size:15px;
    }
    .af-tile .af-tile-desc{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.25;
    }

    .af-tile .af-tile-actions{
      margin-top:auto;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Bot√≥n principal (un solo esquema en degrade) */
    .af-btn{
      appearance:none;
      border:1px solid transparent;
      border-radius:999px;
      min-height:var(--tap);
      padding:10px 14px;
      font-weight:950;
      letter-spacing:.15px;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .af-btn:hover{ transform:translateY(-1px); box-shadow:0 14px 26px rgba(2,6,23,.12); }
    .af-btn:active{ transform:translateY(0); box-shadow:none; }

    .af-btn--primary{
      color:#fff;
      background:linear-gradient(180deg, var(--brand), var(--brand2));
      border-color:rgba(15,47,85,.85);
      box-shadow:0 10px 22px rgba(2,6,23,.14);
    }

    .af-btn--ghost{
      color:rgba(15,23,42,.85);
      background:#fff;
      border:1px solid rgba(31,72,126,.25);
    }

    /* Modales (prolijos, sin colorinche) */
    .af-admin .modal-content{
      border-radius:18px;
      border:1px solid rgba(15,23,42,.10);
      box-shadow:0 18px 50px rgba(2,6,23,.18);
      overflow:hidden;
    }
    .af-admin .modal-header{
      background:linear-gradient(180deg, var(--brand), var(--brand2));
      color:#fff;
      border-bottom:0;
    }
    .af-admin .btn-close{ filter:invert(1); opacity:.95; }

    /* Labels: oscuros sobre fondo claro (sin blanco) */
    .af-admin .form-label{
      display:block;
      margin:0 0 6px 0;
      font-weight:900;
      color:rgba(15,23,42,.80);
    }

    .af-admin .form-control,
    .af-admin .form-select{
      border-radius:14px;
      border:1px solid rgba(15,23,42,.14);
      padding:10px 12px;
      background:#fff;
      outline:none;
      box-shadow:0 1px 0 rgba(2,6,23,.02);
    }
    .af-admin .form-control:focus,
    .af-admin .form-select:focus{
      border-color:rgba(31,72,126,.55);
      box-shadow:0 0 0 4px rgba(31,72,126,.12);
    }

    /* Resultados b√∫squeda */
    .af-admin #resultadosBusqueda,
    .af-admin #resultadosBusquedaPresupuesto{
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      box-shadow:0 10px 20px rgba(2,6,23,.10);
    }
    .af-admin #resultadosBusqueda .list-group-item,
    .af-admin #resultadosBusquedaPresupuesto .list-group-item{
      border:0;
      border-bottom:1px solid rgba(15,23,42,.08);
      padding:10px 12px;
    }
    .af-admin #resultadosBusqueda .list-group-item:last-child,
    .af-admin #resultadosBusquedaPresupuesto .list-group-item:last-child{
      border-bottom:0;
    }

    /* Tablas modal */
    .af-admin .table thead th{
      background:#f2f6ff;
      font-weight:950;
      color:rgba(15,23,42,.82);
    }
    .af-admin .table td,
    .af-admin .table th{
      vertical-align:middle;
      padding:.55rem .65rem;
    }

    /* Compacto */
    .af-admin .mb-3{ margin-bottom:12px !important; }
    .af-admin .modal-footer{ gap:10px; }

    /* (Opcional) ajustar tama√±os de modal */
    .af-modal-xl{ max-width: 1200px; }
  </style>

  <main class="af-admin">
    <div class="af-topbar">
      <h1>Administraci√≥n</h1>
      <div class="af-topbar-actions">
        <a href="/administracion/objetivos" class="af-btn af-btn--ghost">üéØ Objetivos</a>
      </div>
    </div>

    <!-- ================= DASHBOARD (solo botones) ================= -->
    <section class="af-dash">
      <div class="af-tile">
        <h3 class="af-tile-title">Proveedor</h3>
        <p class="af-tile-desc">Seleccionar proveedor, ver descuento y gestionar alta/edici√≥n/baja.</p>
        <div class="af-tile-actions">
          <button class="af-btn af-btn--primary" data-open="modalGestionProveedor">Abrir</button>
        </div>
      </div>

      <div class="af-tile">
        <h3 class="af-tile-title">Cat√°logos</h3>
        <p class="af-tile-desc">Categor√≠as, Marcas y Modelos.</p>
        <div class="af-tile-actions">
          <button class="af-btn af-btn--primary" data-open="modalCatalogos">Abrir</button>
        </div>
      </div>

      <div class="af-tile">
        <h3 class="af-tile-title">Factura</h3>
        <p class="af-tile-desc">Registrar factura y cargar productos.</p>
        <div class="af-tile-actions">
          <button class="af-btn af-btn--primary" data-open="modalFactura">Abrir</button>
        </div>
      </div>

      <div class="af-tile">
        <h3 class="af-tile-title">Nota de cr√©dito</h3>
        <p class="af-tile-desc">Registrar nota de cr√©dito vinculada a factura.</p>
        <div class="af-tile-actions">
          <button class="af-btn af-btn--primary" data-open="modalNotaCredito">Abrir</button>
        </div>
      </div>

      <div class="af-tile">
        <h3 class="af-tile-title">Presupuesto</h3>
        <p class="af-tile-desc">Registrar presupuesto y cargar productos.</p>
        <div class="af-tile-actions">
          <button class="af-btn af-btn--primary" data-open="modalPresupuesto">Abrir</button>
        </div>
      </div>

      <div class="af-tile">
        <h3 class="af-tile-title">Listados</h3>
        <p class="af-tile-desc">Buscar documentos y generar PDFs/res√∫menes.</p>
        <div class="af-tile-actions">
          <button class="af-btn af-btn--primary" data-open="modalListados">Abrir</button>
        </div>
      </div>
    </section>

    <!-- ================= MODAL: GESTI√ìN PROVEEDOR (selector + toolbar) ================= -->
    <div class="modal fade" id="modalGestionProveedor" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Proveedor</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>

          <div class="modal-body">
            <div class="d-flex gap-2 mb-2 flex-wrap">
              <button id="btnNuevoProveedor" class="btn btn-sm btn-success">+ Nuevo</button>
              <button id="btnEditarProveedor" class="btn btn-sm btn-warning" disabled>Editar</button>
              <button id="btnEliminarProveedorDirecto" class="btn btn-sm btn-danger" disabled>Eliminar</button>
            </div>

            <select id="selectProveedor" class="form-select mb-2">
              <option value="">Cargando...</option>
            </select>

            <div id="detalleProveedor" class="p-2" style="border:1px dashed rgba(31,72,126,.25);border-radius:14px;background:#fbfdff;">
              <p id="bloqueDescuentoProveedor" class="d-none mb-0">
                <strong>Descuento:</strong> <span id="descuentoProveedorView">-</span>
              </p>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ================= MODAL PROVEEDOR (EXISTENTE) ================= -->
    <div class="modal fade" id="modalProveedor" tabindex="-1" aria-labelledby="modalProveedorLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalProveedorLabel">Datos del Proveedor</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>

          <form id="formProveedor" class="needs-validation" novalidate>
            <input type="hidden" name="id" id="proveedorId">
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-md-4">
                  <label for="nombre" class="form-label">Nombre / Empresa</label>
                  <input type="text" class="form-control" name="nombre" id="nombre" autocomplete="off" required>
                </div>
                <div class="col-md-4">
                  <label for="contacto" class="form-label">Contacto</label>
                  <input type="text" class="form-control" name="contacto" autocomplete="off" id="contacto">
                </div>
                <div class="col-md-4">
                  <label for="telefono" class="form-label">Tel√©fono</label>
                  <input type="text" class="form-control" name="telefono" autocomplete="off" id="telefono">
                </div>
                <div class="col-md-4">
                  <label for="mail" class="form-label">Email</label>
                  <input type="email" class="form-control" name="mail" autocomplete="off" id="mail">
                </div>
                <div class="col-md-4">
                  <label for="direccion" class="form-label">Direcci√≥n</label>
                  <input type="text" class="form-control" name="direccion" autocomplete="off" id="direccion">
                </div>
                <div class="col-md-4">
                  <label for="ciudad" class="form-label">Ciudad</label>
                  <input type="text" class="form-control" name="ciudad" autocomplete="off" id="ciudad">
                </div>
                <div class="col-md-4">
                  <label for="provincia" class="form-label">Provincia</label>
                  <input type="text" class="form-control" name="provincia" autocomplete="off" id="provincia">
                </div>
                <div class="col-md-4">
                  <label for="cuit" class="form-label">CUIT</label>
                  <input type="text" class="form-control" name="cuit" autocomplete="off" id="cuit">
                </div>
                <div class="col-md-4">
                  <label for="banco" class="form-label">Banco</label>
                  <input type="text" class="form-control" name="banco" autocomplete="off" id="banco">
                </div>
                <div class="col-md-4">
                  <label for="cbu" class="form-label">CBU</label>
                  <input type="text" class="form-control" name="cbu" autocomplete="off" id="cbu">
                </div>
                <div class="col-md-4">
                  <label for="alias" class="form-label">Alias</label>
                  <input type="text" class="form-control" name="alias" autocomplete="off" id="alias">
                </div>
                <div class="col-md-4">
                  <label for="descuento" class="form-label">Descuento (%)</label>
                  <input type="number" class="form-control" autocomplete="off" name="descuento" id="descuento" min="0" max="100" step="0.01">
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-danger d-none" id="btnEliminarProveedor">Eliminar</button>
                <button type="submit" class="btn btn-success">Guardar Cambios</button>
              </div>
            </div>
          </form>

        </div>
      </div>
    </div>

    <!-- ================= MODAL: CATALOGOS (selector + acciones) ================= -->
    <div class="modal fade" id="modalCatalogos" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog af-modal-xl modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Cat√°logos (Categor√≠as, Marcas, Modelos)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <div class="row g-3">
              <!-- CATEGORIAS -->
              <div class="col-md-4">
                <div class="p-3" style="border:1px solid rgba(2,6,23,.10);border-radius:18px;background:#fff;box-shadow:var(--shadow2);">
                  <h6 class="mb-2" style="font-weight:950;color:rgba(15,23,42,.88);">Categor√≠as</h6>
                  <div class="d-flex gap-2 mb-2 flex-wrap">
                    <button id="btnNuevaCategoria" class="btn btn-sm btn-success">+ Nueva</button>
                    <button id="btnEditarCategoria" class="btn btn-sm btn-warning" disabled>Editar</button>
                    <button id="btnEliminarCategoria" class="btn btn-sm btn-danger" disabled>Eliminar</button>
                  </div>
                  <select id="selectCategoria" class="form-select">
                    <option value="">Cargando...</option>
                  </select>
                </div>
              </div>

              <!-- MARCAS -->
              <div class="col-md-4">
                <div class="p-3" style="border:1px solid rgba(2,6,23,.10);border-radius:18px;background:#fff;box-shadow:var(--shadow2);">
                  <h6 class="mb-2" style="font-weight:950;color:rgba(15,23,42,.88);">Marcas</h6>
                  <div class="d-flex gap-2 mb-2 flex-wrap">
                    <button id="btnNuevaMarca" class="btn btn-sm btn-success">+ Nueva</button>
                    <button id="btnEditarMarca" class="btn btn-sm btn-warning" disabled>Editar</button>
                    <button id="btnEliminarMarca" class="btn btn-sm btn-danger" disabled>Eliminar</button>
                  </div>
                  <select id="selectMarca" class="form-select">
                    <option value="">Cargando...</option>
                  </select>
                </div>
              </div>

              <!-- MODELOS -->
              <div class="col-md-4">
                <div class="p-3" style="border:1px solid rgba(2,6,23,.10);border-radius:18px;background:#fff;box-shadow:var(--shadow2);">
                  <h6 class="mb-2" style="font-weight:950;color:rgba(15,23,42,.88);">Modelos</h6>
                  <div class="d-flex gap-2 mb-2 flex-wrap">
                    <button id="btnNuevoModelo" class="btn btn-sm btn-success">+ Nuevo</button>
                    <button id="btnEditarModelo" class="btn btn-sm btn-warning" disabled>Editar</button>
                    <button id="btnEliminarModelo" class="btn btn-sm btn-danger" disabled>Eliminar</button>
                  </div>

                  <div class="mb-2">
                    <label class="form-label">Filtrar por marca</label>
                    <select id="filtroMarcaModelos" class="form-select">
                      <option value="">Todas</option>
                    </select>
                  </div>

                  <select id="selectModelo" class="form-select">
                    <option value="">Cargando...</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== Modales Cat√°logos (EXISTENTES) ===== -->
    <div class="modal fade" id="modalCategoria" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form id="formCategoria" class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Categor√≠a</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="categoriaId">
            <div class="mb-3">
              <label class="form-label">Nombre</label>
              <input class="form-control" id="categoriaNombre" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-success">Guardar</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal fade" id="modalMarca" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form id="formMarca" class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Marca</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="marcaId">
            <div class="mb-3">
              <label class="form-label">Nombre</label>
              <input class="form-control" id="marcaNombre" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-success">Guardar</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal fade" id="modalModelo" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form id="formModelo" class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Modelo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="modeloId">
            <div class="mb-3">
              <label class="form-label">Marca</label>
              <select id="modeloMarcaId" class="form-select" required></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Nombre</label>
              <input class="form-control" id="modeloNombre" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-success">Guardar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ================= MODAL: FACTURA ================= -->
    <div class="modal fade" id="modalFactura" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Registrar Factura</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label for="facturaProveedor" class="form-label">Proveedor</label>
              <select id="facturaProveedor" class="form-select">
                <option value="">Seleccionar proveedor...</option>
                <% proveedores.forEach(p => { %>
                  <option value="<%= p.id %>"><%= p.nombre %></option>
                <% }) %>
              </select>
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                <label for="facturaFecha" class="form-label">Fecha Factura</label>
                <input type="date" id="facturaFecha" class="form-control">
              </div>
              <div class="col-md-6">
                <label for="facturaFechaPago" class="form-label">Fecha Vencimiento</label>
                <input type="date" id="facturaFechaPago" class="form-control">
              </div>
              <div class="col-md-6">
                <label for="facturaNumero" class="form-label">N√∫mero de factura</label>
                <input type="text" id="facturaNumero" class="form-control">
              </div>
              <div class="col-md-6">
                <label for="facturaImporteTotal" class="form-label">Importe total con IVA</label>
                <input type="number" step="0.01" id="facturaImporteTotal" class="form-control">
              </div>
              <div class="col-md-6">
                <label for="facturaIVA" class="form-label">IVA</label>
                <select id="facturaIVA" class="form-select">
                  <option value="">Seleccionar IVA...</option>
                  <option value="21">21%</option>
                  <option value="10.5">10.5%</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="facturaImporteBruto" class="form-label">Importe bruto</label>
                <input type="number" step="0.01" id="facturaImporteBruto" class="form-control">
              </div>
            </div>

            <div class="d-flex gap-2 mt-3 flex-wrap">
              <button id="btnAgregarProductosFactura" class="btn btn-primary">Agregar Productos</button>

              <div class="ms-auto d-flex gap-2 flex-wrap">
                <div style="min-width:220px;">
                  <label for="facturaCondicion" class="form-label">Estado del pago</label>
                  <select id="facturaCondicion" class="form-select">
                    <option value="pendiente" selected>PENDIENTE</option>
                    <option value="pagado">PAGADO</option>
                  </select>
                </div>

                <div style="min-width:220px;">
                  <label for="facturaAdministrador" class="form-label">Administrador</label>
                  <select id="facturaAdministrador" class="form-select" required>
                    <option value="">Seleccionar administrador...</option>
                    <option value="GERARDO">GERARDO</option>
                    <option value="CHACHO">CHACHO</option>
                    <option value="WALTER">WALTER</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button id="btnGuardarFactura" class="btn btn-success">Guardar Factura</button>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL Productos Factura (EXISTENTE) -->
    <div class="modal fade" id="modalProductosFactura" tabindex="-1" aria-labelledby="modalProductosFacturaLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalProductosFacturaLabel">Productos de la Factura</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>

          <div class="modal-body">
            <div class="mb-3 position-relative">
              <label for="buscadorProducto" class="form-label">Buscar producto</label>
              <input type="text" class="form-control" id="buscadorProducto" placeholder="Escrib√≠ el nombre o c√≥digo...">
              <div id="resultadosBusqueda" class="list-group mt-1"></div>
            </div>

            <div class="table-responsive mt-4">
              <table class="table table-bordered table-sm align-middle text-center" id="tablaProductosFactura">
                <thead class="table-light">
                  <tr>
                    <th>C√≥digo Prov.</th>
                    <th>Producto</th>
                    <th>Imagen</th>
                    <th>Cantidad</th>
                    <th>Acci√≥n</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button type="button" class="btn btn-success" id="btnConfirmarProductosFactura">Confirmar Productos</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ================= MODAL: NOTA DE CR√âDITO ================= -->
    <div class="modal fade" id="modalNotaCredito" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Registrar Nota de Cr√©dito</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label for="notaCreditoProveedor" class="form-label">Proveedor</label>
              <select id="notaCreditoProveedor" class="form-select">
                <option value="">Seleccionar proveedor...</option>
                <% proveedores.forEach(p => { %>
                  <option value="<%= p.id %>"><%= p.nombre %></option>
                <% }) %>
              </select>
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                <label for="notaCreditoFecha" class="form-label">Fecha Nota de Cr√©dito</label>
                <input type="date" id="notaCreditoFecha" class="form-control">
              </div>
              <div class="col-md-6">
                <label for="notaCreditoNumero" class="form-label">N√∫mero de Nota de Cr√©dito</label>
                <input type="text" id="notaCreditoNumero" class="form-control" placeholder="Ej: 001-00001234">
              </div>
              <div class="col-md-6">
                <label for="notaCreditoFacturaNumero" class="form-label">Corresponde a Factura N¬∫</label>
                <input type="text" id="notaCreditoFacturaNumero" class="form-control" placeholder="Ej: 001-00005678">
              </div>
              <div class="col-md-6">
                <label for="notaCreditoTipo" class="form-label">Tipo</label>
                <select id="notaCreditoTipo" class="form-select">
                  <option value="">Seleccionar tipo...</option>
                  <option value="descuento">Por descuento</option>
                  <option value="devolucion_mercaderia">Por devoluci√≥n de mercader√≠a</option>
                  <option value="diferencia_precio">Por diferencia de precio</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="notaCreditoIVA" class="form-label">IVA</label>
                <select id="notaCreditoIVA" class="form-select">
                  <option value="">Seleccionar IVA...</option>
                  <option value="21">21%</option>
                  <option value="10.5">10.5%</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="notaCreditoImporteTotal" class="form-label">Importe total (con IVA)</label>
                <input type="number" step="0.01" id="notaCreditoImporteTotal" class="form-control">
              </div>
              <div class="col-md-6">
                <label for="notaCreditoAdministrador" class="form-label">Administrador</label>
                <select id="notaCreditoAdministrador" class="form-select" required>
                  <option value="">Seleccionar administrador...</option>
                  <option value="GERARDO">GERARDO</option>
                  <option value="CHACHO">CHACHO</option>
                  <option value="WALTER">WALTER</option>
                </select>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button id="btnGuardarNotaCredito" class="btn btn-success">Guardar Nota de Cr√©dito</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ================= MODAL: PRESUPUESTO ================= -->
    <div class="modal fade" id="modalPresupuesto" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Registrar Presupuesto</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label for="presupuestoProveedor" class="form-label">Proveedor</label>
              <select id="presupuestoProveedor" class="form-select">
                <option value="">Seleccionar proveedor...</option>
                <% proveedores.forEach(p => { %>
                  <option value="<%= p.id %>"><%= p.nombre %></option>
                <% }) %>
              </select>
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                <label for="presupuestoFecha" class="form-label">Fecha del presupuesto</label>
                <input type="date" id="presupuestoFecha" class="form-control">
              </div>
              <div class="col-md-6">
                <label for="presupuestoFechaPago" class="form-label">Fecha Vencimiento</label>
                <input type="date" id="presupuestoFechaPago" class="form-control">
              </div>
              <div class="col-md-6">
                <label for="presupuestoNumero" class="form-label">N√∫mero</label>
                <input type="text" id="presupuestoNumero" class="form-control">
              </div>
              <div class="col-md-6">
                <label for="presupuestoImporte" class="form-label">Importe total</label>
                <input type="number" step="0.01" id="presupuestoImporte" class="form-control">
              </div>
            </div>

            <div class="d-flex gap-2 mt-3 flex-wrap">
              <button id="btnAgregarProductosPresupuesto" class="btn btn-primary">Agregar Productos</button>

              <div class="ms-auto d-flex gap-2 flex-wrap">
                <div style="min-width:220px;">
                  <label for="presupuestoCondicion" class="form-label">Estado del pago</label>
                  <select id="presupuestoCondicion" class="form-select">
                    <option value="pendiente" selected>PENDIENTE</option>
                    <option value="pagado">PAGADO</option>
                  </select>
                </div>

                <div style="min-width:220px;">
                  <label for="presupuestoAdministrador" class="form-label">Administrador</label>
                  <select id="presupuestoAdministrador" class="form-select" required>
                    <option value="">Seleccionar administrador...</option>
                    <option value="GERARDO">GERARDO</option>
                    <option value="CHACHO">CHACHO</option>
                    <option value="WALTER">WALTER</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button id="btnGuardarPresupuesto" class="btn btn-success">Guardar Presupuesto</button>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL Productos Presupuesto (EXISTENTE) -->
    <div class="modal fade" id="modalProductosPresupuesto" tabindex="-1" aria-labelledby="modalProductosPresupuestoLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalProductosPresupuestoLabel">Productos del Presupuesto</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>

          <div class="modal-body">
            <div class="mb-3 position-relative">
              <label for="buscadorProductoPresupuesto" class="form-label">Buscar producto</label>
              <input type="text" class="form-control" id="buscadorProductoPresupuesto" placeholder="Escrib√≠ el nombre o c√≥digo...">
              <div id="resultadosBusquedaPresupuesto" class="list-group mt-1"></div>
            </div>

            <div class="table-responsive mt-4">
              <table class="table table-bordered table-sm align-middle text-center" id="tablaProductosPresupuesto">
                <thead class="table-light">
                  <tr>
                    <th>C√≥digo Prov.</th>
                    <th>Producto</th>
                    <th>Imagen</th>
                    <th>Cantidad</th>
                    <th>Acci√≥n</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button type="button" class="btn btn-success" id="btnConfirmarProductosPresupuesto">Confirmar Productos</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ================= MODAL: LISTADOS ================= -->
    <div class="modal fade" id="modalListados" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Listado de Facturas y Presupuestos</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label for="filtroProveedor" class="form-label">Proveedor</label>
              <select id="filtroProveedor" class="form-select">
                <option value="">Todos los proveedores</option>
                <% proveedores.forEach(p => { %>
                  <option value="<%= p.id %>"><%= p.nombre %></option>
                <% }) %>
              </select>
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                <label for="filtroTipo" class="form-label">Tipo</label>
                <select id="filtroTipo" class="form-select">
                  <option value="">Todos</option>
                  <option value="factura">Facturas</option>
                  <option value="presupuesto">Presupuestos</option>
                  <option value="nota_credito">Notas de Cr√©dito</option>
                </select>
              </div>

              <div class="col-md-6">
                <label for="filtroNumero" class="form-label">N√∫mero</label>
                <input type="text" id="filtroNumero" class="form-control" placeholder="Ej: 001-12345">
              </div>

              <div class="col-md-6">
                <label class="form-label">Fecha Desde</label>
                <input type="date" id="filtroFechaDesde" class="form-control">
              </div>

              <div class="col-md-6">
                <label class="form-label">Fecha Hasta</label>
                <input type="date" id="filtroFechaHasta" class="form-control">
              </div>

              <div class="col-md-6">
                <label for="filtroCondicion" class="form-label">Condici√≥n</label>
                <select id="filtroCondicion" class="form-select">
                  <option value="">Todas</option>
                  <option value="pendiente">Pendiente</option>
                  <option value="pagado">Pagado</option>
                </select>
              </div>
            </div>

            <div class="d-flex gap-2 mt-3 flex-wrap">
              <button id="btnGenerarPDFResumenFacturas" class="btn btn-primary">üìÑ Resumen Facturas</button>
              <button id="btnGenerarPDFResumenPresupuestos" class="btn btn-primary">üìù Resumen Presupuestos</button>
              <button id="btnVerVencimientos" class="btn btn-primary">üìÜ Vencimientos</button>
              <button class="btn btn-success ms-auto" id="btnBuscarListados">Buscar</button>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL Resultados Listados (EXISTENTE) -->
    <div class="modal fade" id="modalResultadosListados" tabindex="-1" aria-labelledby="modalResultadosListadosLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalResultadosListadosLabel">Resultados de la b√∫squeda</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>

          <div class="modal-body">
            <div class="row" id="contenedorResultadosListados"></div>

            <div class="d-flex justify-content-between align-items-center mt-4">
              <button class="btn btn-outline-secondary" id="btnAnteriorPagina" disabled>‚Üê Anterior</button>
              <span id="indicadorPagina" class="fw-bold">P√°gina 1</span>
              <button class="btn btn-outline-secondary" id="btnSiguientePagina" disabled>Siguiente ‚Üí</button>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL Detalle Documento (EXISTENTE) -->
    <div class="modal fade" id="modalDetalleDocumento" tabindex="-1" aria-labelledby="modalDetalleDocumentoLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalDetalleDocumentoLabel">Detalle del Documento</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body" id="contenedorDetalleDocumento"></div>
          <div class="modal-footer">
            <a id="btnImprimirDetallePDF" href="#" target="_blank" class="btn btn-outline-secondary mt-3">Imprimir Comprobante</a>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button type="button" id="btnHabilitarEdicion" class="btn btn-warning">Editar</button>
            <button type="button" id="btnEliminarDocumento" class="btn btn-danger">Eliminar</button>
            <button type="button" id="btnGuardarCambiosDocumento" class="btn btn-success d-none">Guardar Cambios</button>
          </div>
        </div>
      </div>
    </div>

  </main>

  <%- include('./layouts/footer.ejs') %>

  <!-- Tus JS existentes -->
  <script src="/js/proveedores.js"></script>
  <script src="/js/facturasAdministracion.js"></script>
  <script src="/js/presupuestosAdministracion.js"></script>
  <script src="/js/listadosDocumentos.js"></script>
  <script src="/js/catalogosAdmin.js"></script>
  <script src="/js/notasCreditoAdministracion.js?v=20260109_1"></script>

  <!-- JS NUEVO: abrir modales desde los tiles -->
  <script>
    (function(){
      function openModal(id){
        const el = document.getElementById(id);
        if (!el || !window.bootstrap) return;
        bootstrap.Modal.getOrCreateInstance(el).show();
      }

      document.addEventListener('click', (e) => {
        const btn = e.target.closest('[data-open]');
        if(!btn) return;
        e.preventDefault();
        openModal(btn.getAttribute('data-open'));
      });
    })();
  </script>
</body>
